<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ”¶è—</title>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <style>
        /* --- åŸºç¡€è®¾å®š (å¤ç”¨ Settings é£æ ¼) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: linear-gradient(180deg, #fff0f5 0%, #ffe4e1 100%);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            color: #5d5d5d;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- é¡¶éƒ¨å¯¼èˆª (ä¿®å¤ä½ç½®å’Œæ ·å¼) --- */
        .nav-bar {
            padding: 50px 24px 20px 24px; /* å¢åŠ é¡¶éƒ¨ç•™ç™½ï¼Œè§£å†³æŒ‰é’®å¤ªé ä¸Šé—®é¢˜ */
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
            flex-shrink: 0;
        }
        .back-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2);
            font-size: 18px; color: #888; 
            transition: transform 0.2s;
            border: none;
        }
        .back-btn:active { transform: scale(0.9); }
        .page-title {
            font-size: 18px; font-weight: 600; letter-spacing: 0.5px; color: #7a6a6a;
        }
        .right-action { width: 40px; } /* å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ */

        /* --- å†…å®¹åŒºåŸŸ --- */
        .content-area {
            flex: 1; padding: 0 20px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: 40px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .content-area::-webkit-scrollbar { display: none; }

        /* --- æ”¶è—å¡ç‰‡ç¾åŒ– --- */
        .collect-card {
            background: rgba(255, 255, 255, 0.75); /* ç»ç’ƒåŠé€æ˜ */
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.15); /* ç²‰è‰²æŸ”å…‰é˜´å½± */
            display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .collect-card:active { transform: scale(0.98); background: rgba(255,255,255,0.9); }
        
        .pink-envelope {
            width: 48px; height: 48px; 
            background: linear-gradient(135deg, #ffb7b2 0%, #ffdac1 100%);
            border-radius: 14px;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 22px; 
            box-shadow: 0 4px 10px rgba(255, 183, 178, 0.4);
            flex-shrink: 0;
        }
        
        .info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .info-title { font-size: 15px; font-weight: 600; color: #555; margin-bottom: 4px; }
        .info-desc { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-time { font-size: 11px; color: #bbb; margin-top: 6px; text-align: right; }

        /* --- ç©ºçŠ¶æ€ --- */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 60vh; color: #bbb;
        }
        .empty-icon { font-size: 48px; color: #e0e0e0; margin-bottom: 15px; }

        /* --- å¼¹çª—æ ·å¼ (é€‚é… Settings é£æ ¼) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); z-index: 500; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
            opacity: 0; transition: opacity 0.3s;
        }
        /* JSæ§åˆ¶æ˜¾ç¤ºæ—¶æ·»åŠ  .show ç±»æ¥å¤„ç†åŠ¨ç”»ï¼Œæˆ–è€…ç›´æ¥styleæ§åˆ¶ï¼Œè¿™é‡Œä¸ºäº†å…¼å®¹åŸé€»è¾‘ç›´æ¥ç”¨styleä½†ä¿ç•™åŠ¨ç”»è¿‡æ¸¡å±æ€§ */
        
        .modal-card {
            background: rgba(255, 255, 255, 0.95); 
            width: 88%; max-height: 75vh; border-radius: 24px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .m-header { 
            padding: 18px; 
            background: #fff; 
            color: #7a6a6a; font-size: 16px; font-weight: 600; 
            text-align: center; 
            border-bottom: 1px solid rgba(0,0,0,0.03);
            letter-spacing: 1px;
        }
        
        .m-body { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 12px;
            background: #fafafa;
            /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
            scrollbar-width: none; 
        }
        .m-body::-webkit-scrollbar { display: none; }
        
        .m-close { 
            padding: 15px; text-align: center; 
            background: #fff;
            color: #ffb7b2; font-weight: 600; cursor: pointer; 
            font-size: 14px;
            border-top: 1px solid rgba(0,0,0,0.03);
            transition: background 0.2s;
        }
        .m-close:active { background: #f5f5f5; }
        
        /* èŠå¤©è®°å½•æ ·å¼ä¼˜åŒ– */
        .msg-item { 
            padding: 12px 14px; 
            border-radius: 12px; 
            font-size: 14px; 
            line-height: 1.5;
            position: relative;
        }
        /* --- æ–°å¢ï¼šæ—¥è®°å†…å®¹æ ·å¼æ”¯æŒ (å¤åˆ¶è‡ª love_diary.html) --- */
        .diary-content-view {
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #eee;
            color: #444; line-height: 1.8; font-size: 15px;
            font-family: "Comic Sans MS", cursive, sans-serif; /* ä¿æŒæ‰‹å†™æ„Ÿ */
        }
        /* å­—ä½“ç‰¹æ•ˆ */
        .fx-bold { font-weight: 800; color: #333; }
        .fx-strike { text-decoration: line-through; color: #999; }
        .fx-big { font-size: 1.3em; display: inline-block; transform: rotate(-2deg); }
        .fx-small { font-size: 0.8em; color: #888; }
        .fx-color { color: #ff6b81; font-weight: bold; }
        .fx-messy { font-family: "Courier New", monospace; letter-spacing: -1px; transform: skewX(-10deg); display: inline-block; }
        .fx-marker { background: linear-gradient(180deg, transparent 60%, #fffd82 60%); }
        /* ç”¨æˆ·å‘è¨€ */
        .msg-user {
            background: #fff0f5; color: #555;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            margin-left: 20px;
        }
        /* è§’è‰²å‘è¨€ */
        .msg-char {
            background: #fff; color: #555;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            margin-right: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .msg-role { 
            font-size: 11px; margin-bottom: 4px; opacity: 0.6; font-weight: bold;
        }
        .msg-user .msg-role { color: #ff6b81; text-align: right; }
        .msg-char .msg-role { color: #888; text-align: left; }

    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="nav-bar">
        <!-- æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸ºdivç‚¹å‡»è·³è½¬ï¼Œæ ·å¼ä¸ºåœ†å½¢æŒ‰é’®ï¼Œä½ç½®å·²ä¸‹ç§» -->
        <div class="back-btn" onclick="location.href='qq_mine.html'">â†</div>
        <div class="page-title">çè´µå›å¿†</div>
        <div class="right-action"></div>
    </div>

    <!-- åˆ—è¡¨å®¹å™¨ -->
    <div class="content-area" id="listContainer"></div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-card">
            <div class="m-header">å¯¹è¯è¯¦æƒ…</div>
            <div class="m-body" id="detailBody"></div>
            <div class="m-close" onclick="closeModal()">å…³é—­</div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-card" style="height: auto;">
            <div class="m-header" style="color:#ff6b6b">åˆ é™¤å›å¿†</div>
            <div class="m-body" style="text-align:center; color:#888; padding:30px;">
                ç¡®å®šè¦åˆ é™¤è¿™æ¡æ”¶è—å—ï¼Ÿ<br>åˆ é™¤åæ— æ³•æ¢å¤ã€‚
            </div>
            <div style="display: flex; border-top: 1px solid #eee;">
                <div class="m-close" style="flex:1; border-right:1px solid #eee; color:#999; border-top:none;" onclick="document.getElementById('deleteModal').style.display='none'">å–æ¶ˆ</div>
                <div class="m-close" style="flex:1; color:#ff6b6b; border-top:none;" onclick="executeDelete()">åˆ é™¤</div>
            </div>
        </div>
    </div>
    
    <script>
        // --- åŸæœ‰é€»è¾‘ä»£ç ï¼Œä¿æŒåŠŸèƒ½ä¸å˜ ---
        
        let listData = [];
        let dbPromise;
        function initDB() {
            if (!dbPromise) {
    dbPromise = idb.openDB('QQ_DB_2026', 1, {
        upgrade(db) {
            // è¿™é‡Œåªåšä¸€ä»¶äº‹ï¼šå¦‚æœæ²¡æœ‰ keyval è¡¨ï¼Œå°±å»ºä¸€ä¸ª
            if (!db.objectStoreNames.contains('keyval')) {
                db.createObjectStore('keyval');
            }
        },
    });
}
            return dbPromise;
        }
        async function dbGet(key) {
            const db = await initDB();
            return await db.get('keyval', key);
        }
        async function dbSet(key, val) {
            const db = await initDB();
            return await db.put('keyval', val, key);
        }
// å¼€å§‹å¼‚æ­¥è¯»å–
async function loadData() {
            const str = await dbGet('qq_collect_data');
            if (str) {
                try {
                    listData = JSON.parse(str);
                } catch(e) { console.error(e); }
            }
            initPage();
        }
        loadData();

function initPage() {
        const container = document.getElementById('listContainer');
        const modal = document.getElementById('detailModal');

        // ä¸ºäº†é…åˆ fade åŠ¨ç”»ç¨å¾®å°è£…ä¸€ä¸‹
        window.closeModal = function() {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        if (listData.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">â˜…</div>
                    <div>è¿˜æ²¡æœ‰æ”¶è—è¿‡å¯¹è¯å“¦</div>
                </div>`;
        } else {
            let deleteTargetIndex = -1; // è®°å½•è¦åˆ é™¤å“ªä¸€ä¸ª
        let pressTimer = null;      // é•¿æŒ‰è®¡æ—¶å™¨
        let isLongPress = false;    // æ ‡è®°æ˜¯å¦è§¦å‘äº†é•¿æŒ‰

        listData.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = 'collect-card';
            
            // --- ä¿®æ”¹å¼€å§‹ï¼šåˆ¤æ–­ç±»å‹ ---
            let titleText = "";
            let previewText = "";
            let iconHtml = "â¤";

            if (item.type === 'diary') {
                // æ—¥è®°ç±»å‹
                titleText = `${item.charName} çš„æ—¥è®°`;
                // ç®€å•å»é™¤HTMLæ ‡ç­¾åšé¢„è§ˆ
                let tempDiv = document.createElement("div");
                tempDiv.innerHTML = item.content;
                previewText = tempDiv.textContent || tempDiv.innerText || "";
                iconHtml = "ğŸ“’"; // æ—¥è®°å›¾æ ‡
            } else {
                // é»˜è®¤èŠå¤©è®°å½•ç±»å‹
                titleText = `ä¸ ${item.charName} çš„å¯¹è¯`;
                previewText = (item.msgs && item.msgs.length > 0) ? item.msgs[0].content : '...';
            }
            // --- ä¿®æ”¹ç»“æŸ ---

            el.innerHTML = `
                <div class="pink-envelope">${iconHtml}</div>
                <div class="info">
                    <div class="info-title">${titleText}</div>
                    <div class="info-desc">${previewText}</div>
                    <div class="info-time">${item.date}</div>
                </div>
            `;

            // --- é•¿æŒ‰ä¸ç‚¹å‡»é€»è¾‘å¼€å§‹ ---
            const startPress = () => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    showDeleteModal(index); // è§¦å‘é•¿æŒ‰å¼¹çª—
                }, 600); // 600æ¯«ç§’ç®—é•¿æŒ‰
            };

            const endPress = () => {
                clearTimeout(pressTimer);
            };

            // è§¦æ‘¸å±äº‹ä»¶
            el.addEventListener('touchstart', startPress);
            el.addEventListener('touchend', endPress);
            el.addEventListener('touchmove', endPress); // æ»‘åŠ¨åˆ™å–æ¶ˆé•¿æŒ‰

            // é¼ æ ‡äº‹ä»¶ (å…¼å®¹ç”µè„‘æµ‹è¯•)
            el.addEventListener('mousedown', startPress);
            el.addEventListener('mouseup', endPress);

            // ç‚¹å‡»äº‹ä»¶ï¼šå¦‚æœæ˜¯é•¿æŒ‰è§¦å‘çš„ï¼Œå°±ä¸è¿›è¯¦æƒ…
            el.onclick = () => {
                if (!isLongPress) {
                    showDetail(index);
                }
            };
            // --- é•¿æŒ‰ä¸ç‚¹å‡»é€»è¾‘ç»“æŸ ---

            container.appendChild(el);
        });

        // æ˜¾ç¤ºåˆ é™¤å¼¹çª— (æ–°åŠŸèƒ½)
        window.showDeleteModal = function(index) {
            deleteTargetIndex = index;
            const m = document.getElementById('deleteModal');
            m.style.display = 'flex';
            requestAnimationFrame(() => m.style.opacity = '1');
        }

        // æ‰§è¡Œåˆ é™¤ (æ–°åŠŸèƒ½)
        window.executeDelete = function() {
            if (deleteTargetIndex > -1) {
                listData.splice(deleteTargetIndex, 1); // åˆ æ•°ç»„
                dbSet('qq_collect_data', JSON.stringify(listData)).then(function() {
                    location.reload();
                });
            }
        }
        }
}

        function showDetail(index) {
            const item = listData[index];
            const body = document.getElementById('detailBody');
            body.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
            
            const header = document.querySelector('.m-header'); // è·å–æ ‡é¢˜æ 

            if (item.type === 'diary') {
                // --- æ—¥è®°æ¨¡å¼ ---
                if(header) header.innerText = "æ—¥è®°è¯¦æƒ…";
                
                // åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œç›´æ¥å¥—ç”¨æ—¥è®°çš„ç™½è‰²åœ†è§’æ ·å¼
                const div = document.createElement('div');
                div.className = 'diary-content-view'; 
                // å…³é”®ï¼šæ¸²æŸ“æ—¥è®°çš„ HTML å…¨æ–‡
                div.innerHTML = item.content; 
                body.appendChild(div);

            } else {
                // --- å¯¹è¯æ¨¡å¼ ---
                if(header) header.innerText = "å¯¹è¯è¯¦æƒ…";

                if (item.msgs) {
                    item.msgs.forEach(m => {
                        const div = document.createElement('div');
                        const isUser = m.role === 'user';
                        div.className = `msg-item ${isUser ? 'msg-user' : 'msg-char'}`;
                        
                        let content = m.content;
                        if(m.msgType && m.msgType !== 'text') content = `[${m.msgType}]`;
                        
                        div.innerHTML = `<div class="msg-role">${isUser ? 'æˆ‘' : item.charName}</div><div>${content}</div>`;
                        body.appendChild(div);
                    });
                }
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            const m = document.getElementById('detailModal');
            m.style.display = 'flex';
            
            // ç¡®ä¿å¼¹çª—å†…å®¹åŒºéšè—æ»šåŠ¨æ¡ä½†å¯ä»¥æ»šåŠ¨
            if(body) {
                body.style.scrollbarWidth = 'none'; // Firefox
                // é’ˆå¯¹ Chrome/Safari çš„éšè—æ»šåŠ¨æ¡æ ·å¼
                const styleId = 'hide-scroll-style';
                if (!document.getElementById(styleId)) {
                    const style = document.createElement('style');
                    style.id = styleId;
                    style.innerHTML = '#detailBody::-webkit-scrollbar { display: none; }';
                    document.head.appendChild(style);
                }
            }

            // åŠ¨ç”»æ·¡å…¥
            requestAnimationFrame(() => {
                m.style.opacity = '1';
            });
        }
    </script>
</body>
</html>
