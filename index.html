<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Buzzy</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Buzzy">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/R0PzBq9R/IMG-8184.jpg">
    <meta name="theme-color" content="#f6f8fb">
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Buzzy%22%2C%22short_name%22%3A%22Buzzy%22%2C%22display%22%3A%22standalone%22%2C%22start_url%22%3A%22.%22%2C%22theme_color%22%3A%22%23f6f8fb%22%2C%22background_color%22%3A%22%23dce0e6%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fi.postimg.cc%2FR0PzBq9R%2FIMG-8184.jpg%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fjpeg%22%7D%5D%7D'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        /* --- 1. 基础设定 --- */
        :root { --app-size: 62px; --gap-size: 20px; --page-padding-top: max(50px, env(safe-area-inset-top) + 20px); }
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body { margin: 0; height: 100vh; width: 100vw; background: #dce0e6; display: flex; justify-content: center; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Songti SC", "PingFang SC", serif; overscroll-behavior-y: none; transition: font-family 0.3s ease; }
        .screen-container { width: 100%; max-width: 420px; height: 100%; background: linear-gradient(160deg, #f6f8fb 0%, #e1e9f0 100%); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .pages-wrapper { flex: 1; display: flex; overflow-x: auto; overflow-y: hidden; scroll-snap-type: x mandatory; scrollbar-width: none; scroll-behavior: smooth; }
        .pages-wrapper::-webkit-scrollbar { display: none; }
        .page { flex-shrink: 0; width: 100%; height: 100%; scroll-snap-align: center; padding: var(--page-padding-top) 22px 140px 22px; overflow-y: auto; position: relative; display: flex; flex-direction: column; scrollbar-width: none; -ms-overflow-style: none; }
        .page::-webkit-scrollbar { display: none; }
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: max-content; gap: var(--gap-size); width: 100%; flex: 1; position: relative; }
        .grid-item { position: relative; cursor: pointer; transition: transform 0.2s; z-index: 10; }
        .grid-item:active { transform: scale(0.95); } 
        .sortable-ghost { opacity: 0.3; filter: grayscale(1); }
        .sortable-drag { transform: scale(1.1) !important; z-index: 1000; opacity: 0.95; }
        .widget-item { grid-column: span 2; grid-row: span 2; aspect-ratio: 1/1; border-radius: 28px; position: relative; }
        .widget-avatar { display: flex; justify-content: center; align-items: center; overflow: visible; z-index: 10; }
        .wing-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; z-index: 1; pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .feather { position: absolute; background: rgba(255, 255, 255, 0.9); border-radius: 50% 0 50% 0; box-shadow: 0 2px 6px rgba(189, 212, 231, 0.5); }
        .f-l-1 { width: 52px; height: 30px; left: -35px; top: -10px; transform: rotate(-30deg); animation: flap-l 3s ease-in-out infinite; }
        .f-l-2 { width: 42px; height: 24px; left: -38px; top: 15px; transform: rotate(-15deg); animation: flap-l 3s ease-in-out infinite 0.2s; }
        .f-r-1 { width: 52px; height: 30px; right: -35px; top: -10px; transform: scaleX(-1) rotate(-30deg); animation: flap-r 3s ease-in-out infinite; }
        .f-r-2 { width: 42px; height: 24px; right: -38px; top: 15px; transform: scaleX(-1) rotate(-15deg); animation: flap-r 3s ease-in-out infinite 0.2s; }
        @keyframes flap-l { 0%,100%{transform: rotate(-30deg) translateY(0);} 50%{transform: rotate(-20deg) translateY(-6px);} }
        @keyframes flap-r { 0%,100%{transform: scaleX(-1) rotate(-30deg) translateY(0);} 50%{transform: scaleX(-1) rotate(-20deg) translateY(-6px);} }
        .avatar-circle { width: 96px; height: 96px; border-radius: 50%; background: #fff; border: 4px solid rgba(255,255,255,0.95); box-shadow: 0 8px 25px rgba(166, 177, 193, 0.4); z-index: 5; background-size: cover; background-position: center; background-image: url('https://images.unsplash.com/photo-1585110396067-c3d6e3789682?q=80&w=200&auto=format&fit=crop'); }
        .star-particle { position: absolute; background: #fff; border-radius: 50%; box-shadow: 0 0 8px rgba(255,255,255,0.8); opacity: 0; animation: twinkle var(--d) infinite ease-in-out; z-index: 6; }
        @keyframes twinkle { 0%,100%{opacity:0;transform:scale(0.3)} 50%{opacity:1;transform:scale(1)} }
        .widget-time { background: rgba(255,255,255,0.55); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #5d6575; box-shadow: 0 10px 25px rgba(0,0,0,0.02); }
        .time-big { font-family: inherit; font-size: 2.8rem; font-weight: 200; line-height: 1; color: #334; margin-bottom: 5px; }
        .time-date { font-family: inherit; font-size: 0.85rem; font-weight: 400; opacity: 0.9; letter-spacing: 0.5px; }
        .time-weather { font-family: inherit; font-size: 0.9rem; font-weight: 500; margin-top: 2px; color: #555; }
        .widget-polaroid { overflow: visible; z-index: 10; }
        .polaroid-card { position: absolute; width: 60%; height: 75%; background: #fff; padding: 5px 5px 22px 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s; cursor: pointer; }
        .polaroid-card:active { transform: scale(0.96) !important; }
        .polaroid-img { width: 100%; height: 100%; background-color: #eee; background-size: cover; background-position: center; }
        .p-1 { top: 5%; left: 8%; transform: rotate(-8deg); z-index: 1; }
        .p-2 { bottom: 5%; right: 8%; transform: rotate(6deg); z-index: 2; }
        .widget-pill { grid-column: 1 / -1 !important; width: 100%; grid-row: span 2; height: 140px; background: rgba(255, 255, 255, 0.35); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); border-radius: 100px; display: flex; align-items: center; justify-content: space-between; padding: 8px 10px 8px 30px; position: relative; overflow: visible; }
        .pill-img-wrap { width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.9); box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; flex-shrink: 0; cursor: pointer; margin-right: 5px; }
        .pill-img { width: 100%; height: 100%; background-size: cover; background-position: center; }
        .pill-text-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-right: 15px; text-align: center; min-width: 0; }
        .pill-quote { font-family: inherit; font-size: 18px; color: #1d1d1f; line-height: 1.5; font-weight: 600; margin-bottom: 12px; text-shadow: 0 1px 1px rgba(255,255,255,0.6); cursor: pointer; transition: opacity 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .pill-loc-wrap { display: inline-flex; align-items: center; gap: 4px; color: #555; font-size: 12px; font-weight: 500; background: rgba(255,255,255,0.5); padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: background 0.2s; max-width: 100%; font-family: inherit; }
        .pill-loc-icon { width: 12px; height: 12px; fill: currentColor; flex-shrink: 0; }
        .pill-loc-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .min-star { position: absolute; width: 6px; height: 6px; background: #fff; transform: rotate(45deg); opacity: 0; box-shadow: 0 0 4px rgba(255,255,255,0.9); animation: simple-blink 3s infinite ease-in-out; pointer-events: none; }
        .ms-1 { top: 20%; left: 8%; animation-delay: 0s; }
        .ms-2 { bottom: 15%; left: 25%; width: 4px; height: 4px; animation-delay: 1.5s; }
        .ms-3 { top: 12%; right: 40%; width: 5px; height: 5px; animation-delay: 0.8s; }
        @keyframes simple-blink { 0%, 100% { opacity: 0; transform: rotate(45deg) scale(0.5); } 50% { opacity: 1; transform: rotate(45deg) scale(1); box-shadow: 0 0 8px rgba(255,255,255,0.8); } }
        .widget-bow { grid-column: span 2; grid-row: span 1; height: var(--app-size); aspect-ratio: auto; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.35); border-radius: 20px; display: flex; justify-content: center; align-items: center; position: relative; overflow: visible !important; box-shadow: 0 5px 15px rgba(255,255,255,0.1); }
        .bow-icon { width: 55px; height: 55px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 14c-1.3 0-2.5-.8-2.9-2-.3-.8-.1-1.6.4-2.2.6-.7 1.6-1.1 2.5-.8.9-.3 1.9.1 2.5.8.5.6.7 1.4.4 2.2-.4 1.2-1.6 2-2.9 2zm6.5-6c-1.2 0-2.4.6-3.2 1.6-.3-.3-.7-.6-1.1-.8l2-4.5c.2-.5 0-1.1-.5-1.3-.5-.2-1.1 0-1.3.5L12.5 8c-.2 0-.3-.1-.5-.1s-.3 0-.5.1L9.6 3.5c-.2-.5-.8-.7-1.3-.5-.5.2-.7.8-.5 1.3l2 4.5c-.4.2-.8.5-1.1.8-.8-1-2-1.6-3.2-1.6-2.5 0-4.5 2-4.5 4.5 0 1.2.5 2.4 1.4 3.2L4 21.5c-.1.5.2 1.1.7 1.3.1 0 .2.1.3.1.4 0 .8-.2 1-.6l1.7-4.2c.4.1.9.2 1.3.2 2.5 0 4.5-2 4.5-4.5v-.5c0 2.5 2 4.5 4.5 4.5.4 0 .9-.1 1.3-.2l1.7 4.2c.2.4.6.6 1 .6.1 0 .2 0 .3-.1.5-.2.8-.7.7-1.3l-1.6-5.8c.9-.8 1.4-2 1.4-3.2 0-2.5-2-4.5-4.5-4.5z'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 0 4px rgba(255,255,255,0.9)); opacity: 0.95; z-index: 5; }
        .diamond-s { position: absolute; background: #fff; transform: rotate(45deg); border-radius: 1px; box-shadow: 0 0 6px rgba(255,255,255,0.9); animation: dia-blink 2.5s infinite ease-in-out; z-index: 1; }
        .ds-1 { width: 8px; height: 8px; top: 18%; left: 12%; animation-delay: 0s; }
        .ds-2 { width: 5px; height: 5px; bottom: 20%; right: 15%; animation-delay: 1.2s; }
        .ds-3 { width: 4px; height: 4px; top: 15%; right: 28%; animation-delay: 0.5s; }
        .ds-4 { width: 7px; height: 7px; bottom: 15%; left: 30%; animation-delay: 1.8s; }
        @keyframes dia-blink { 0%,100%{opacity: 0.3; transform: rotate(45deg) scale(0.7);} 50%{opacity: 1; transform: rotate(45deg) scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,1);} }
        .widget-vinyl { background: rgba(255,255,255,0.65); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex; justify-content: center; align-items: center; overflow: visible; }
        .vinyl-disc { width: 88%; height: 88%; border-radius: 50%; background: conic-gradient(#1a1a1a 0%, #3a3a3a 15%, #1a1a1a 30%, #3a3a3a 45%, #1a1a1a 60%, #3a3a3a 75%, #1a1a1a 90%, #3a3a3a 100%); position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.25); display: flex; justify-content: center; align-items: center; animation: spin 12s linear infinite; }
        .vinyl-cover { width: 65%; height: 65%; border-radius: 50%; background-image: url('https://images.unsplash.com/photo-1514525253440-b393452e8d26?w=300&q=80'); background-size: cover; background-position: center; border: 2px solid rgba(255,255,255,0.15); cursor: pointer; z-index: 5; }
        .vinyl-arm { position: absolute; top: 2px; right: 2px; width: 40px; height: 60px; pointer-events: none; z-index: 6; transform-origin: top right; transform: rotate(20deg); }
        .arm-head { width: 10px; height: 18px; background: #e0e0e0; border-radius: 2px; position: absolute; bottom: 0; left: 0; transform: rotate(-20deg); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .arm-rod { width: 4px; height: 55px; background: #ccc; position: absolute; top: 0; right: 4px; transform: rotate(-15deg); border-radius: 2px; }
        @keyframes spin { 0%{transform: rotate(0deg);} 100%{transform: rotate(360deg);} }
        .app-item { grid-column: span 1; display: flex; flex-direction: column; align-items: center; gap: 7px; position: relative; }
        .app-icon-img { width: var(--app-size); height: var(--app-size); border-radius: 16px; background-color: #ffffff; background-size: 55%; background-position: center; background-repeat: no-repeat; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .app-name { font-size: 11px; color: #333; font-weight: 500; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; font-family: inherit; }
        .icon-qq { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpath d='M8 14s1.5 2 4 2 4-2 4-2'%3E%3C/path%3E%3Cline x1='9' y1='9' x2='9.01' y2='9'%3E%3C/line%3E%3Cline x1='15' y1='9' x2='15.01' y2='9'%3E%3C/line%3E%3C/svg%3E"); }
        .icon-worldbook { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 19.5A2.5 2.5 0 0 1 6.5 17H20'%3E%3C/path%3E%3Cpath d='M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z'%3E%3C/path%3E%3C/svg%3E"); }
        .icon-weibo { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'%3E%3C/path%3E%3Ccircle cx='12' cy='12' r='3'%3E%3C/circle%3E%3C/svg%3E"); }
        .icon-game { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='2' y='6' width='20' height='12' rx='2'%3E%3C/rect%3E%3Cpath d='M6 12h4m-2-2v4'%3E%3C/path%3E%3Cline x1='15' y1='11' x2='15.01' y2='11'%3E%3C/line%3E%3Cline x1='18' y1='13' x2='18.01' y2='13'%3E%3C/line%3E%3C/svg%3E"); }
        .icon-love { 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FF9EAA'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3Cpath d='M16.5 5c-1.74 0-3.41.81-4.5 2.09C10.91 5.81 9.24 5 7.5 5 4.42 5 2 7.42 2 10.5c0 3.78 3.4 6.86 8.55 11.54L12 23.35l1.45-1.32C18.6 17.36 22 14.28 22 10.5 22 7.42 19.58 5 16.5 5z' fill='none' stroke='%23FFCCD5' stroke-width='1.5'/%3E%3C/svg%3E");
        }
        .icon-calendar {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='4' y='5' width='16' height='16' rx='2'%3E%3C/rect%3E%3Cline x1='16' y1='3' x2='16' y2='7'%3E%3C/line%3E%3Cline x1='8' y1='3' x2='8' y2='7'%3E%3C/line%3E%3Cline x1='4' y1='11' x2='20' y2='11'%3E%3C/line%3E%3Ctext x='12' y='17' font-family='sans-serif' font-size='7' fill='black' text-anchor='middle' stroke='none'%3E25%3C/text%3E%3C/svg%3E");
        }
        .icon-phone {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .57 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.05 12.05 0 0 0 2.81.57A2 2 0 0 1 22 16.92z'%3E%3C/path%3E%3C/svg%3E");
        }
        .static-dock-wrap { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; height: 95px; background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 32px; display: flex; justify-content: space-around; align-items: center; padding: 0 20px; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.4); }
        .static-app { width: var(--app-size); height: var(--app-size); border-radius: 16px; background-color: #ffffff; background-repeat: no-repeat; background-position: center; background-size: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; cursor: pointer; transition: transform 0.1s; }
        .static-app:active { transform: scale(0.9); background-color: #f0f0f0; }
        .icon-sys-set { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='black'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' /%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z' /%3E%3C/svg%3E"); }
        .icon-sys-font { display:flex;justify-content:center;align-items:center;color:#000;font-weight:600;font-size:22px; font-family: inherit; }
        .icon-sys-theme { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z'/%3E%3C/svg%3E"); }
        .delete-btn { position: absolute; top: -8px; left: -8px; width: 24px; height: 24px; background: rgba(0, 0, 0, 0.6); color: #fff; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 16px; z-index: 100; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(1deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-1deg); } }
        .is-editing .grid-item { animation: shake 0.25s infinite ease-in-out; }
        .is-editing .widget-item .delete-btn { display: flex; }
        .move-controls { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 140%; height: 100%; pointer-events: none; display: flex; justify-content: space-between; align-items: center; z-index: 200; }
        .move-btn { width: 30px; height: 30px; border-radius: 50%; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; justify-content: center; align-items: center; cursor: pointer; pointer-events: auto; font-size: 14px; font-weight: bold; color: #333; }
        .move-btn:active { background: #f0f0f0; transform: scale(0.9); }
        .new-page-placeholder { grid-column: 1 / -1; width: 100%; height: calc(100vh - 200px); display: none !important; justify-content: center; align-items: center; }
        .is-editing .is-empty-page .new-page-placeholder { display: flex !important; }
        .add-circle { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.4); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; color: #000; font-size: 40px; font-weight: 300; box-shadow: 0 5px 20px rgba(0,0,0,0.05); cursor: pointer; }
        .page-indicators { position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 60; pointer-events: none; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(0,0,0,0.2); backdrop-filter: blur(2px); transition: background 0.3s; }
        .dot.active { background: #333; box-shadow: 0 1px 3px rgba(255,255,255,0.5); }
        .dock-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200%); width: 88%; max-width: 380px; height: 100px; background: #ffffff; box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.9); border-radius: 26px; padding: 0 15px; display: flex; align-items: center; gap: 15px; overflow-x: auto; transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 2000; scrollbar-width: none; -ms-overflow-style: none; }
        .dock-container::-webkit-scrollbar { display: none; }
        .dock-container.visible { transform: translateX(-50%) translateY(0); }
        .dock-preview { flex-shrink: 0; width: 70px; height: 70px; position: relative; }
        .dock-preview .grid-item { width: 150px; height: 150px; transform: scale(0.46); transform-origin: top left; pointer-events: none; animation: none !important; }
        .dock-preview .delete-btn { display: none !important; }
        .modal-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .app-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 600; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,1,0.23,1); display: flex; flex-direction: column; overflow: hidden; }
        .app-layer.active { transform: translateY(0); }
        .app-iframe { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            border: none; 
            background: #fff; /* 必须有背景色，不然透明了 */
        }
        .home-bar-wrap { position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 8px; z-index: 610; cursor: pointer; background: linear-gradient(to top, rgba(0,0,0,0.05), transparent); }
        .home-bar { width: 120px; height: 5px; background: rgba(0,0,0,0.3); border-radius: 10px; }
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .custom-modal-box { width: 320px; background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 15px; animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .pink-glow { box-shadow: 0 10px 40px rgba(255, 182, 193, 0.4), 0 0 20px rgba(255, 192, 203, 0.8) !important; border: 1px solid rgba(255, 228, 225, 1); }
        .white-glow { box-shadow: 0 0 30px 5px rgba(255, 255, 255, 0.9) !important; border: 1px solid rgba(255, 255, 255, 1); }
        .btn-pink { background: #FFB7C5 !important; color: #fff; }
        .btn-pink:active { background: #ff9eb0 !important; }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 16px; font-weight: bold; color: #333; text-align: center; font-family: inherit; }
        .modal-input { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 12px; font-size: 15px; outline: none; font-family: inherit; resize: none; }
        .modal-input:focus { background: #fff; border-color: #ccc; }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .modal-btn-editor { flex: 1; padding: 10px; border-radius: 12px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; font-family: inherit; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-confirm { background: #333; color: #fff; }
        .modal-btn-editor:hover { opacity: 0.8; }

        /* --- 顶部消息通知弹窗 --- */
        .notification-banner {
            position: fixed; top: -120px; left: 0; width: 100%; height: 110px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-radius: 0 0 24px 24px; /* 上方直角，下方圆角 */
            z-index: 10000; /* 最顶层 */
            display: flex; align-items: center; padding: 0 20px;
            padding-top: max(env(safe-area-inset-top), 20px); /* 适配刘海屏 */
            transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }
        .notification-banner.show { top: 0; }
        .notif-avatar {
            width: 42px; height: 42px; border-radius: 10px; /* 圆角正方形 */
            background-color: #eee; background-size: cover; background-position: center;
            margin-right: 12px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05);
        }
        .notif-content { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .notif-title { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 3px; }
        .notif-text { font-size: 13px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    </style>
</head>
<body>

    <!-- 顶部通知横幅 -->
    <div class="notification-banner" id="topNotification" onclick="onNotificationClick()">
        <div class="notif-avatar" id="notifAvatar"></div>
        <div class="notif-content">
            <div class="notif-title" id="notifTitle">角色名</div>
            <div class="notif-text" id="notifText">消息内容...</div>
        </div>
    </div>

    <!-- 全局悬浮字幕 (可拖动) -->
    <div id="globalSubtitle" style="
        position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
        padding: 5px 10px; /* 减小内边距 */
        color: #fff; font-size: 16px;
        text-align: center; pointer-events: none; z-index: 99999;
        display: none; white-space: nowrap; max-width: 90%; overflow: hidden; text-overflow: ellipsis;
        transition: top 0.1s, left 0.1s; 
        text-shadow: 2px 2px 2px rgba(0,0,0,0.8), -1px -1px 0 #000; /* 强描边，确保不要背景也能看清 */
    ">
        歌词加载中...
    </div>
    
    <div class="screen-container" id="screen">
        <div class="pages-wrapper" id="pagesWrapper">
            <!-- Page 1 -->
            <div class="page" id="page1">
                <div class="grid-container sortable-grid">
                    <!-- Widgets -->
                    <div class="grid-item widget-item widget-avatar" data-type="avatar">
                        <div class="delete-btn">×</div>
                        <div class="wing-wrapper"><div class="feather f-l-1"></div><div class="feather f-l-2"></div><div class="feather f-r-1"></div><div class="feather f-r-2"></div></div>
                        <div class="stars-wrap"></div><div class="avatar-circle"></div>
                    </div>
                    <div class="grid-item widget-item widget-time" data-type="time">
                        <div class="delete-btn">×</div><div class="time-big">12:00</div><div class="time-date">1月11日</div><div class="time-weather">晴 23℃</div>
                    </div>
                    
                    <!-- APPS -->
<div class="grid-item app-item" id="app-qq" data-url="qq.html" data-name="QQ">
    <div class="app-icon-img icon-qq"></div><span class="app-name">QQ</span>
</div>
<div class="grid-item app-item" id="app-worldbook" data-url="worldbook.html" data-name="世界书">
    <div class="app-icon-img icon-worldbook"></div><span class="app-name">世界书</span>
</div>
<div class="grid-item app-item" id="app-weibo" data-url="weibo.html" data-name="论坛">
    <div class="app-icon-img icon-weibo"></div><span class="app-name">论坛</span>
</div>

<!-- 这是一个独立的游戏App -->
<div class="grid-item app-item" id="app-game" data-url="game.html" data-name="游戏">
    <div class="app-icon-img icon-game"></div><span class="app-name">游戏</span>
</div>

<!-- 这是一个独立的情侣空间App，必须放在上面的 </div> 后面 -->
<div class="grid-item app-item" id="app-love" data-url="love.html" data-name="情侣空间">
    <div class="app-icon-img icon-love"></div><span class="app-name">情侣空间</span>
</div>

<!-- 日历 App -->
<div class="grid-item app-item" id="app-calendar" data-url="riji.html" data-name="日历">
    <div class="app-icon-img icon-calendar"></div><span class="app-name">日历</span>
</div>

<!-- 电话 App -->
<div class="grid-item app-item" id="app-telephone" data-url="telephone.html" data-name="电话">
    <div class="app-icon-img icon-phone"></div><span class="app-name">电话</span>
</div>

                    <!-- Plus Placeholder -->
                    <div class="new-page-placeholder"><div class="add-circle" onclick="onAddPageClick(event)">+</div></div>
                </div>
            </div>
        </div>

        <div class="page-indicators" id="pageDots"><div class="dot active"></div></div>

        <!-- Static Dock -->
        <div class="static-dock-wrap">
           <!-- 这里的 id 一定要加 -->
           <div class="static-app icon-sys-set" id="dock-settings" onclick="openApp('settings.html')"></div>
           <div class="static-app icon-sys-font" id="dock-font" onclick="openApp('font_app.html')">Aa</div>
           <div class="static-app icon-sys-theme" id="dock-theme" onclick="openApp('theme_app.html')"></div>
        </div>

        <!-- 音乐播放器 (移到主页以保持跨窗口播放) -->
    <iframe id="listenFrame" src="qq_func_listen.html" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        border: none; z-index: 2500; display: none; /* z-index要比appLayer高 */
    "></iframe>
        
        <!-- App Open Layer -->
        <div class="app-layer" id="appLayer">
            <iframe class="app-iframe" id="keepAliveFrame" style="display:none;" src=""></iframe>
            <iframe class="app-iframe" id="appFrame" src=""></iframe>
            <div class="home-bar-wrap" onclick="closeApp()">
                <div class="home-bar"></div>
            </div>
        </div>

    </div>

    <!-- Drawer -->
    <div class="dock-container" id="dockDrawer">
        <!-- 预览: 蝴蝶结 -->
        <div class="dock-preview" style="width: 130px;">
            <div class="grid-item widget-item widget-bow" data-type="bow">
                <div class="delete-btn">×</div>
                <div class="diamond-s ds-1"></div><div class="diamond-s ds-2"></div><div class="diamond-s ds-3"></div><div class="diamond-s ds-4"></div>
                <div class="bow-icon"></div>
            </div>
        </div>
        <!-- 预览: 唱片机 -->
        <div class="dock-preview">
            <div class="grid-item widget-item widget-vinyl" data-type="vinyl">
                <div class="delete-btn">×</div>
                <div class="vinyl-disc">
                    <div class="vinyl-cover"></div>
                </div>
                <div class="vinyl-arm"><div class="arm-rod"></div><div class="arm-head"></div></div>
            </div>
        </div>
        <!-- 预览: 头像 -->
        <div class="dock-preview">
            <div class="grid-item widget-item widget-avatar" data-type="avatar">
                <div class="delete-btn">×</div>
                <div class="wing-wrapper"><div class="feather f-l-1"></div><div class="feather f-l-2"></div><div class="feather f-r-1"></div><div class="feather f-r-2"></div></div>
                <div class="stars-wrap"></div><div class="avatar-circle"></div>
            </div>
        </div>
        <!-- 预览: 时间 -->
        <div class="dock-preview">
            <div class="grid-item widget-item widget-time" data-type="time">
                <div class="delete-btn">×</div><div class="time-big">12:00</div><div class="time-date">1月1日</div><div class="time-weather">晴 25℃</div>
            </div>
        </div>
        <!-- 预览: 拍立得 -->
        <div class="dock-preview">
            <div class="grid-item widget-item widget-polaroid" data-type="polaroid">
                <div class="delete-btn">×</div>
                <div class="polaroid-card p-1"><div class="polaroid-img" style="background-image: url('https://images.unsplash.com/photo-1517487881594-2787fef5ebf7?w=300&q=80')"></div></div>
                <div class="polaroid-card p-2"><div class="polaroid-img" style="background-image: url('https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&q=80')"></div></div>
            </div>
        </div>
        <!-- 预览: 雾化长条 -->
        <div class="dock-preview" style="width: 180px;">
            <div class="grid-item widget-item widget-pill" data-type="pill">
                <div class="delete-btn">×</div>
                <div class="min-star ms-1"></div><div class="min-star ms-2"></div><div class="min-star ms-3"></div>
                <div class="pill-text-area">
                    <div class="pill-quote" onclick="openTextEditor(this, 'quote')">你别忧愁<br>我爱你带笑的眼眸</div>
                    <div class="pill-loc-wrap" onclick="openTextEditor(this, 'location')">
                        <svg class="pill-loc-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        <span class="pill-loc-text">冰岛</span>
                    </div>
                </div>
                <div class="pill-img-wrap">
                    <div class="pill-img" style="background-image: url('https://images.unsplash.com/photo-1490750967868-58cb75063ed4?w=300&q=80')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal parts -->
    <div class="modal-mask" id="modal">
        <div class="custom-modal-box pink-glow">
            <div class="modal-title" style="margin-bottom: 10px;">更换图片</div>
            <button class="modal-btn-editor btn-pink" style="margin-bottom:10px;" onclick="actFile()">从本地上传</button>
            <button class="modal-btn-editor btn-pink" style="margin-bottom:10px;" onclick="actUrl()">使用 URL</button>
            <button class="modal-btn-editor btn-cancel" onclick="hideModal()">取消</button>
        </div>
    </div>
    <input type="file" id="fileIn" hidden>

    <div id="textEditorModal" class="custom-modal-overlay">
        <div class="custom-modal-box white-glow">
            <div class="modal-title" id="editorTitle">修改内容</div>
            <textarea id="editorInput" class="modal-input" rows="3"></textarea>
            <div class="modal-btns">
                <button class="modal-btn-editor btn-cancel" onclick="closeEditor()">取消</button>
                <button class="modal-btn-editor btn-confirm" onclick="saveEditor()">确认</button>
            </div>
        </div>
    </div>
    
    <div id="warningModal" class="custom-modal-overlay">
        <div class="custom-modal-box white-glow">
            <div class="modal-title">哎呀，太大了捏</div>
            <div style="text-align:center; color:#666; font-size:14px; margin:10px 0; line-height:1.6;">
                图片太大啦，可能会导致保存失败哦~<br>建议换张小一点的或者用URL链接试试看？
            </div>
            <div class="modal-btns">
                <button class="modal-btn-editor btn-confirm" onclick="closeWarning()">知道啦</button>
            </div>
        </div>
    </div>

    <div id="urlInputModal" class="custom-modal-overlay">
        <div class="custom-modal-box pink-glow">
            <div class="modal-title">请输入图片链接</div>
            <input type="text" id="newImgUrl" class="modal-input" placeholder="https://..." style="text-align:left;">
            <div class="modal-btns">
                <button class="modal-btn-editor btn-cancel" onclick="closeUrlModal()">取消</button>
                <button class="modal-btn-editor btn-pink" onclick="confirmUrl()">确定</button>
            </div>
        </div>
    </div>

    <!-- 魔法咒语弹窗 -->
    <!-- 注意：这里加了 style="z-index: 20000;" 确保它能浮在锁屏密码盘的最上面 -->
    <div id="forgotPwdModal" class="custom-modal-overlay" style="z-index: 20000;">
        <div class="custom-modal-box white-glow">
            <div class="modal-title">请输入魔法咒语</div>
            <input type="text" id="magicSpellInput" class="modal-input" placeholder="悄悄告诉我..." style="margin-bottom: 15px;">
            <div class="modal-btns">
                <button class="modal-btn-editor btn-cancel" onclick="closeForgotModal()">取消</button>
                <button class="modal-btn-editor btn-confirm" onclick="verifySpell()">保存</button>
            </div>
        </div>
    </div>

    <script>
        const notifyAudio = new Audio();
        // --- 【新增】建立跨窗口通信频道 ---
    const globalChannel = new BroadcastChannel('buzzy_sync_channel');

    // 监听来自其他窗口的消息（例如单独打开的qq.html发来的通知）
    globalChannel.onmessage = (event) => {
        const data = event.data;
        
        // 1. 处理新消息弹窗通知
        if (data && data.type === 'new_msg_notify') {
            showNotification(data);
        }

        if (data && data.type === 'font_update') {
            window.reloadGlobalFont();
        }

        if (data && data.type === 'theme_update') {
            window.reloadTheme();
        }
        
        // 2. 如果未来有其他需要同步的数据（比如刷新未读数），可以在这里扩展
    };
        notifyAudio.preload = "auto"; 
        const pagesWrapper = document.getElementById('pagesWrapper');
        const pageDots = document.getElementById('pageDots');
        const dockDrawer = document.getElementById('dockDrawer');
        let isEditing = false;
        let pressTimer;

        // --- Layout Saving Logic (修改版：静默处理) ---
        async function saveLayout() {
            try {
                const layoutHtml = pagesWrapper.innerHTML;
                await localforage.setItem('healing_ui_layout_v21', layoutHtml);
            } catch (e) {
                // 这里的弹窗代码删除了，改为在后台悄悄打印错误
                console.log('存储空间可能满了，但在尝试自动压缩前不打扰用户');
            }
        }

        async function loadLayout() {
            const savedHtml = await localforage.getItem('healing_ui_layout_v21');
            if (savedHtml) {
                pagesWrapper.innerHTML = savedHtml;
                document.querySelectorAll('.grid-container').forEach(grid => { initSortableForGrid(grid); });
                document.querySelectorAll('.stars-wrap').forEach(createStars);
                updateDots();
            } else {
                initSortableForGrid(document.querySelector('.grid-container'));
            }
            window.reloadGlobalFont();
        }

        // --- App Open/Close Logic ---
        function openApp(url) {
            if(!url) return;
            const layer = document.getElementById('appLayer');
            const normalFrame = document.getElementById('appFrame');
            const kaFrame = document.getElementById('keepAliveFrame');
            
            const isChatWindow = url.includes('chat_window.html');

            // 只要打开 App，两者都必须是 block 状态，通过 z-index 控制谁在上面
            normalFrame.style.display = 'block';
            kaFrame.style.display = 'block';

            if (isChatWindow) {
                // === 1. 进入聊天对话框 ===
                // 让聊天窗口层级变高 (z-index 20)，盖住普通应用
                kaFrame.style.zIndex = '20';
                normalFrame.style.zIndex = '10';
                
                // 只有ID变了才重新加载，否则保持原样
                const currentSrc = kaFrame.getAttribute('src') || "";
                const newId = (url.match(/id=([^&]*)/) || [])[1];
                const oldId = (currentSrc.match(/id=([^&]*)/) || [])[1];

                if (newId !== oldId || !oldId) {
                    kaFrame.src = url;
                    kaFrame.onload = () => { window.reloadGlobalFont(); };
                }
                
                if (kaFrame && kaFrame.contentWindow) {
                    kaFrame.contentWindow.postMessage({ type: 'app_visibility_change', isVisible: true }, '*');
                }
                
            } else {
                // === 2. 进入普通 App (如日历) ===
                // 让普通应用层级变高 (z-index 20)，盖住聊天窗口
                // 【关键】：不要把 kaFrame 设为 display:none，否则API会断！
                normalFrame.style.zIndex = '20';
                kaFrame.style.zIndex = '10';

                // 加载页面
                normalFrame.src = url;
                normalFrame.onload = () => { window.reloadGlobalFont(); };
                
                // 告诉聊天窗口它不可见了（但还在后台跑）
                if (kaFrame && kaFrame.contentWindow) {
                    kaFrame.contentWindow.postMessage({ type: 'app_visibility_change', isVisible: false }, '*');
                }
            }
            
            // 显示应用层容器
            layer.classList.add('active');
        }

        function closeApp() {
            const layer = document.getElementById('appLayer');
            const normalFrame = document.getElementById('appFrame');
            const kaFrame = document.getElementById('keepAliveFrame');
            
            // 隐藏应用层
            layer.classList.remove('active');

            // 告诉聊天窗口它不可见了
            if (kaFrame && kaFrame.contentWindow) {
                kaFrame.contentWindow.postMessage({ type: 'app_visibility_change', isVisible: false }, '*');
            }
            
            // 延迟清理普通 App (如日历)，防止关闭动画时白屏
            // 注意：不要清理 kaFrame，让它一直活着
            setTimeout(() => { 
                normalFrame.src = ''; 
                // 复位层级
                normalFrame.style.zIndex = '';
                kaFrame.style.zIndex = '';
            }, 400);
        }

        // --- 核心修复：重写 Iframe 注入逻辑 (适配两个 Frame) ---
        window.reloadGlobalFont = async function() {
            let savedFont = await localforage.getItem('healing_active_font'); 
            if(!savedFont) return;
            
            try {
                const fontData = (typeof savedFont === 'string') ? JSON.parse(savedFont) : savedFont;
                const size = fontData.size || 16; 
                
                document.documentElement.style.fontSize = size + 'px';

                // 补丁样式
                let styleTag = document.getElementById('dynamic-font-patch');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'dynamic-font-patch';
                    document.head.appendChild(styleTag);
                }
                styleTag.innerHTML = `
                    .app-name { font-size: 0.7rem !important; }
                    .pill-quote { font-size: 1.125rem !important; }
                    .pill-loc-wrap { font-size: 0.75rem !important; }
                    .icon-sys-font { font-size: 1.375rem !important; }
                    .modal-title { font-size: 1rem !important; }
                    .modal-input { font-size: 0.94rem !important; }
                    .time-big { font-size: 2.8rem !important; }
                `;

                let fontFace = null;
                let familyString = '';
                if (fontData.id !== 'default' && fontData.url) {
                    const fontName = 'CustomGlobalFont';
                    fontFace = new FontFace(fontName, `url(${fontData.url})`);
                    await fontFace.load();
                    document.fonts.add(fontFace);
                    familyString = `"${fontName}", -apple-system, BlinkMacSystemFont, sans-serif`;
                    document.body.style.fontFamily = familyString;
                } else {
                    document.body.style.fontFamily = '';
                }
                
                // 【修改点】同时给两个 Iframe 尝试应用字体
                applyFontToSpecificFrame(document.getElementById('appFrame'), familyString, fontFace, size);
                applyFontToSpecificFrame(document.getElementById('keepAliveFrame'), familyString, fontFace, size);
                
            } catch(e) {
                console.error("全局字体加载出错:", e);
            }
        };

        // 提取出来的通用注入函数
        function applyFontToSpecificFrame(frame, familyString, loadedFontFace, size) {
            if (!frame || !frame.contentWindow) return;
            // 如果 frame 是隐藏的且 src 为空，可能无法注入，但没关系
            try {
                const iDoc = frame.contentWindow.document;
                if(iDoc) {
                    if (loadedFontFace) { iDoc.fonts.add(loadedFontFace); }
                    if (familyString) { iDoc.body.style.fontFamily = familyString; }
                    if (size) {
                        iDoc.documentElement.style.fontSize = size + 'px';
                        let patch = iDoc.getElementById('iframe-font-patch');
                        if (!patch) {
                            patch = iDoc.createElement('style');
                            patch.id = 'iframe-font-patch';
                            iDoc.head.appendChild(patch);
                        }
                        patch.innerHTML = `
                            body { font-size: 1rem !important; }
                            div, p, span, a, li, input, textarea, button { }
                            .page-title { font-size: 1.125rem !important; }
                            .btn-add { font-size: 0.94rem !important; }
                            .font-selector { font-size: 0.875rem !important; }
                            .preset-item { font-size: 0.875rem !important; }
                            .modal-title { font-size: 1rem !important; }
                            .modal-input { font-size: 0.875rem !important; }
                            .app-name, .title, .text, .content { font-size: 1rem !important; }
                            h1 { font-size: 2rem !important; }
                            h2 { font-size: 1.5rem !important; }
                            small { font-size: 0.8rem !important; }
                        `;
                    }
                }
            } catch(e) { }
        }
        function createStars(wrapper) {
            if(!wrapper) return; wrapper.innerHTML = '';
            for(let i=0; i<6; i++) {
                const s = document.createElement('div'); s.className = 'star-particle';
                const deg = Math.random() * 360; const dist = 55 + Math.random() * 15;
                const x = Math.cos(deg * Math.PI/180) * dist; const y = Math.sin(deg * Math.PI/180) * dist;
                s.style.width = s.style.height = (3 + Math.random()*3) + 'px';
                s.style.left = `calc(50% + ${x}px)`; s.style.top = `calc(50% + ${y}px)`;
                s.style.setProperty('--d', (1.5+Math.random())+'s'); s.style.animationDelay = (Math.random()*2)+'s';
                wrapper.appendChild(s);
            }
        }
        document.querySelectorAll('.stars-wrap').forEach(createStars);
        
        function updateTime() {
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const date = `${now.getMonth()+1}月${now.getDate()}日`;
            document.querySelectorAll('.widget-time').forEach(w => {
                const tBig = w.querySelector('.time-big'); const tDate = w.querySelector('.time-date');
                if(tBig) tBig.innerText = time; if(tDate) tDate.innerText = date;
            });
        }
        setInterval(updateTime, 1000); updateTime();

        function clearMoveControls() { document.querySelectorAll('.move-controls').forEach(el => el.remove()); }
        function showMoveControls(appItem) {
            clearMoveControls(); 
            const controls = document.createElement('div'); controls.className = 'move-controls';
            controls.innerHTML = `<div class="move-btn" data-dir="left">←</div><div class="move-btn" data-dir="right">→</div>`;
            appItem.appendChild(controls);
            controls.querySelectorAll('.move-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); moveAppItem(appItem, btn.dataset.dir); });
            });
        }
        function moveAppItem(item, dir) {
            const currentPage = item.closest('.page');
            const allPages = Array.from(document.querySelectorAll('.page'));
            const currentIndex = allPages.indexOf(currentPage);
            let targetPage;
            if (dir === 'left') {
                if (currentIndex > 0) targetPage = allPages[currentIndex - 1]; else return; 
            } else {
                if (currentIndex < allPages.length - 1) targetPage = allPages[currentIndex - 1 + 2]; 
                else { addNewPage(); const updatedPages = document.querySelectorAll('.page'); targetPage = updatedPages[updatedPages.length - 1]; setTimeout(() => { pagesWrapper.scrollTo({ left: pagesWrapper.scrollWidth, behavior: 'smooth' }); }, 100); }
            }
            if (targetPage) {
                const grid = targetPage.querySelector('.grid-container');
                const placeholder = grid.querySelector('.new-page-placeholder');
                grid.insertBefore(item, placeholder);
                clearMoveControls(); checkPagesStatus();
                setTimeout(() => { targetPage.scrollIntoView({ behavior: 'smooth' }); }, 100);
            }
        }

        document.addEventListener('click', (e) => {
            if(e.target.closest('.static-dock-wrap')) return;

            if(isEditing) {
                if(e.target.classList.contains('delete-btn') || e.target.classList.contains('add-circle')) return;
                const appItem = e.target.closest('.app-item');
                if (appItem && !e.target.closest('.dock-preview') && !e.target.closest('.move-btn')) {
                    e.stopPropagation(); showMoveControls(appItem); return;
                }
                if(!e.target.closest('.grid-item') && !e.target.closest('#dockDrawer') && !e.target.closest('.move-btn')) { exitEdit(); }
            } 
            else {
                const appItem = e.target.closest('.app-item');
                if (appItem && !e.target.closest('.dock-preview')) {
                    const url = appItem.getAttribute('data-url');
                    if (url) openApp(url); 
                }
            }
        });
        
        window.onAddPageClick = function(e) { e.stopPropagation(); addNewPage(); setTimeout(() => { pagesWrapper.scrollTo({ left: pagesWrapper.scrollWidth, behavior: 'smooth' }); }, 50); };

        function initSortableForGrid(gridEl) {
            new Sortable(gridEl, {
                group: 'shared', animation: 150, delay: 300, delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                filter: '.new-page-placeholder',
                onStart: () => { enterEdit(); clearMoveControls(); },
                onEnd: () => { checkPagesStatus(); },
                onAdd: (evt) => {
                    const item = evt.item;
                    if (item.classList.contains('dock-preview')) {
                        const realWidget = item.querySelector('.grid-item');
                        item.replaceWith(realWidget); realWidget.style = "";
                        if(realWidget.dataset.type === 'avatar') createStars(realWidget.querySelector('.stars-wrap'));
                        updateTime();
                    }
                    checkPagesStatus();
                }
            });
        }
        
        new Sortable(dockDrawer, { group: { name: 'shared', pull: 'clone', put: false }, sort: false, animation: 150 });

        function checkPagesStatus() {
            document.querySelectorAll('.page').forEach(page => {
                const grid = page.querySelector('.grid-container');
                const items = grid.querySelectorAll('.grid-item:not(.new-page-placeholder)').length;
                if(items === 0) page.classList.add('is-empty-page'); else page.classList.remove('is-empty-page');
            });
            if (isEditing) {
                const pages = document.querySelectorAll('.page');
                const lastPage = pages[pages.length-1];
                const lastGrid = lastPage.querySelector('.grid-container');
                const hasItems = lastGrid.querySelectorAll('.grid-item:not(.new-page-placeholder)').length > 0;
                if (hasItems) addNewPage();
            }
            updateDots();
        }
        function addNewPage() {
            const newPage = document.createElement('div');
            newPage.className = 'page is-empty-page';
            newPage.innerHTML = `<div class="grid-container sortable-grid"><div class="new-page-placeholder"><div class="add-circle" onclick="onAddPageClick(event)">+</div></div></div>`;
            pagesWrapper.appendChild(newPage);
            initSortableForGrid(newPage.querySelector('.grid-container'));
            updateDots();
        }
        pagesWrapper.addEventListener('scroll', () => { const pageIndex = Math.round(pagesWrapper.scrollLeft / pagesWrapper.clientWidth); updateDotsHighlight(pageIndex); });
        function updateDots() {
            const count = document.querySelectorAll('.page').length; pageDots.innerHTML = '';
            for(let i=0; i<count; i++) { const dot = document.createElement('div'); dot.className = 'dot' + (i===0?' active':''); pageDots.appendChild(dot); }
            const current = Math.round(pagesWrapper.scrollLeft / pagesWrapper.clientWidth); updateDotsHighlight(current);
        }
        function updateDotsHighlight(index) { document.querySelectorAll('.dot').forEach((d, i) => { if(i === index) d.classList.add('active'); else d.classList.remove('active'); }); }

        function enterEdit() {
            if(isEditing) return; isEditing = true;
            document.body.classList.add('is-editing'); dockDrawer.classList.add('visible');
            if(navigator.vibrate) navigator.vibrate(50); checkPagesStatus();
        }
        function exitEdit() {
            isEditing = false;
            document.body.classList.remove('is-editing'); dockDrawer.classList.remove('visible');
            clearMoveControls(); 
            const pages = document.querySelectorAll('.page');
            for (let i = pages.length - 1; i >= 0; i--) {
                const page = pages[i];
                if (page.classList.contains('is-empty-page') && document.querySelectorAll('.page').length > 1) { page.remove(); }
            }
            updateDots();
            saveLayout();
        }
        pagesWrapper.addEventListener('mousedown', startP); pagesWrapper.addEventListener('touchstart', startP);
        function startP(e) {
            if(isEditing || e.target.classList.contains('delete-btn') || e.target.classList.contains('add-circle') || e.target.closest('.move-btn')) return;
            if(e.target.closest('.static-dock-wrap')) return; 
            pressTimer = setTimeout(enterEdit, 600);
        }
        ['mouseup','touchend','touchmove'].forEach(ev => document.addEventListener(ev, () => clearTimeout(pressTimer)));
        document.addEventListener('click', (e) => { if(e.target.classList.contains('delete-btn')) { e.stopPropagation(); e.target.closest('.grid-item').remove(); checkPagesStatus(); } });

        let currAvatar = null; 
        let currTextTarget = null; 
        let currEditType = ''; 
        const modal = document.getElementById('modal'); 
        const textModal = document.getElementById('textEditorModal'); 
        const warningModal = document.getElementById('warningModal');
        window.closeWarning = function() { warningModal.style.display = 'none'; };
        function showWarning() { warningModal.style.display = 'flex'; }
        const editorInput = document.getElementById('editorInput');
        const editorTitle = document.getElementById('editorTitle');
        const urlModal = document.getElementById('urlInputModal');
        const urlInputField = document.getElementById('newImgUrl');

        document.addEventListener('click', (e) => {
            if(isEditing) return;
            const avatarWidget = e.target.closest('.widget-avatar');
            const polaroidCard = e.target.closest('.polaroid-card');
            const pillImgWrap = e.target.closest('.pill-img-wrap');
            const vinylCover = e.target.closest('.vinyl-cover');
            if (e.target.closest('.dock-preview')) return;
            if (avatarWidget) { currAvatar = avatarWidget.querySelector('.avatar-circle'); modal.style.display = 'flex'; } 
            else if (polaroidCard) { currAvatar = polaroidCard.querySelector('.polaroid-img'); modal.style.display = 'flex'; }
            else if (pillImgWrap) { currAvatar = pillImgWrap.querySelector('.pill-img'); modal.style.display = 'flex'; }
            else if (vinylCover) { currAvatar = vinylCover; modal.style.display = 'flex'; }
        });

        window.openTextEditor = function(element, type) {
            if(isEditing || element.closest('.dock-preview')) return;
            event.stopPropagation(); 
            currTextTarget = element;
            currEditType = type;
            if (type === 'quote') {
                editorTitle.innerText = "编辑文案 (支持HTML换行)";
                editorInput.value = element.innerHTML.replace(/<br\s*\/?>/gi, "\n");
                editorInput.setAttribute('rows', 3);
            } else {
                editorTitle.innerText = "编辑地点";
                const span = element.querySelector('.pill-loc-text');
                editorInput.value = span ? span.innerText : element.innerText;
                editorInput.setAttribute('rows', 1);
            }
            textModal.style.display = 'flex';
            editorInput.focus();
        };

        window.saveEditor = function() {
            if(!currTextTarget) return;
            const val = editorInput.value;
            if (currEditType === 'quote') { currTextTarget.innerHTML = val.replace(/\n/g, "<br>"); } else { const span = currTextTarget.querySelector('.pill-loc-text'); if(span) span.innerText = val; else currTextTarget.innerText = val; }
            closeEditor(); saveLayout(); 
        };
        window.closeEditor = function() { textModal.style.display = 'none'; currTextTarget = null; };
        window.hideModal = () => modal.style.display = 'none';
        window.actFile = () => { document.getElementById('fileIn').click(); hideModal(); }
        // --- 核心修改：上传时偷偷压缩图片 ---
        document.getElementById('fileIn').onchange = (e) => {
            const f = e.target.files[0];
            if (f && currAvatar) {
                const r = new FileReader();
                r.onload = v => {
                    // 1. 创建一个临时的 Image 对象
                    const img = new Image();
                    img.src = v.target.result;
                    
                    img.onload = () => {
                        // 2. 创建一个隐形的画布
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // 3. 设定最大尺寸（例如 800px），太大的图片会导致卡顿且占空间
                        // 对于小组件来说，800px 已经极其清晰了
                        const maxSide = 800;
                        let w = img.width;
                        let h = img.height;

                        // 计算等比缩放后的尺寸
                        if (w > h) {
                            if (w > maxSide) { h *= maxSide / w; w = maxSide; }
                        } else {
                            if (h > maxSide) { w *= maxSide / h; h = maxSide; }
                        }

                        canvas.width = w;
                        canvas.height = h;

                        // 4. 把图片画到画布上
                        ctx.drawImage(img, 0, 0, w, h);

                        // 5. 【关键】导出为 JPEG，质量设为 0.7
                        // 这步操作会让 5MB 的图片变成 100KB 左右，且肉眼几乎看不出区别
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

                        // 6. 将压缩后的图片赋值给组件，并保存
                        currAvatar.style.backgroundImage = `url('${compressedBase64}')`;
                        saveLayout();
                    };
                };
                r.readAsDataURL(f);
            }
            // 清空 input，防止无法连续选择同一张图
            e.target.value = '';
        };
        window.actUrl = () => { hideModal(); urlModal.style.display = 'flex'; urlInputField.value = ''; setTimeout(() => urlInputField.focus(), 100); }
        window.closeUrlModal = () => { urlModal.style.display = 'none'; }
        window.confirmUrl = () => { const url = urlInputField.value.trim(); if(url && currAvatar) { currAvatar.style.backgroundImage = `url('${url}')`; saveLayout(); } closeUrlModal(); }
        // 1. 注册功能：现在同时也扫描底部的 Dock 栏
        async function registerInstalledApps() {
            const apps = [];
            
            // A. 扫描桌面上的普通 APP
            document.querySelectorAll('.app-item').forEach(el => {
                if(el.id) {
                    const name = el.getAttribute('data-name') || el.querySelector('.app-name')?.innerText || '普通应用';
                    apps.push({ id: el.id, name: name });
                }
            });

            // B. 扫描底部 Dock 栏 (新增逻辑)
            // 我们手动给这三个固定的家伙命名
            const dockNames = {
                'dock-settings': '系统设置',
                'dock-font': '字体设置',
                'dock-theme': '主题美化'
            };
            document.querySelectorAll('.static-app').forEach(el => {
                if(el.id && dockNames[el.id]) {
                    apps.push({ id: el.id, name: dockNames[el.id] });
                }
            });

            // 存入数据库
            await localforage.setItem('buzzy_installed_apps', JSON.stringify(apps));
        }

        // --- 2. 应用主题 (可爱外框版) ---
        window.reloadTheme = async function() {
            // 先同步字体
            if(window.reloadGlobalFont) window.reloadGlobalFont();

            const themeStr = await localforage.getItem('buzzy_active_theme');
            if(!themeStr) return;
            
            let theme;
            try { 
        theme = (typeof themeStr === 'string') ? JSON.parse(themeStr) : themeStr; 
    } catch(e) { return; }

            // A. 图标逻辑 (保持不变)
            if(theme.icons) {
                Object.keys(theme.icons).forEach(appId => {
                    const iconUrl = theme.icons[appId];
                    const appEl = document.getElementById(appId);
                    if(appEl && iconUrl) {
                        let targetImg = appEl.querySelector('.app-icon-img');
                        if (!targetImg) targetImg = appEl; 
                        targetImg.style.backgroundImage = `url('${iconUrl}')`;
                        targetImg.style.backgroundSize = 'cover'; 
                        targetImg.style.backgroundRepeat = 'no-repeat';
                        if(appId === 'dock-font') appEl.style.color = 'transparent'; 
                    }
                });
            }

            // B. 可爱外框逻辑
            const screen = document.getElementById('screen');
            const body = document.body;
            
            // 检查是否已经插入过可爱样式的CSS，如果没有就插进去
            let cuteStyle = document.getElementById('cute-frame-style');
            if (!cuteStyle) {
                cuteStyle = document.createElement('style');
                cuteStyle.id = 'cute-frame-style';
                // 这里用 CSS 伪元素 ::before 和 ::after 来画两个小耳朵
                cuteStyle.innerHTML = `
                    .cute-mode-body {
                        background-color: #ffe6ea !important; /* 淡粉色背景 */
                        display: flex !important;
                        justify-content: center !important;
                        align-items: center !important;
                        min-height: 100vh !important;
                        margin: 0 !important;
                        overflow-x: hidden;
                    }
                    .cute-frame {
                        border: 12px solid #ffffff !important; /* 白色粗边框 */
                        border-radius: 40px !important;        /* 大圆角 */
                        box-shadow: 0 10px 40px rgba(255, 182, 193, 0.6) !important; /* 粉色柔光阴影 */
                        margin: 50px auto !important;          /* 留出顶部给耳朵 */
                        position: relative !important;
                        z-index: 10;
                        box-sizing: border-box; /* 确保内容在框内 */
                        transform: scale(0.95); /* 微微缩小一点显得精致 */
                    }
                    /* 左耳朵 */
                    .cute-frame::before {
                        content: '';
                        position: absolute;
                        top: -24px; left: 30px;
                        width: 50px; height: 50px;
                        background: #ffffff;
                        border-radius: 50%;
                        z-index: -1; /* 藏在屏幕后面 */
                        box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
                    }
                    /* 右耳朵 */
                    .cute-frame::after {
                        content: '';
                        position: absolute;
                        top: -24px; right: 30px;
                        width: 50px; height: 50px;
                        background: #ffffff;
                        border-radius: 50%;
                        z-index: -1;
                        box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
                    }
                `;
                document.head.appendChild(cuteStyle);
            }

            if(theme.frameEnabled === true) {
                // 【开启可爱模式】
                body.classList.add('cute-mode-body');
                screen.classList.add('cute-frame');
                
                // 修正尺寸，防止太大
                screen.style.maxWidth = '400px'; 
                
            } else {
                // 【关闭模式 - 彻底恢复】
                body.classList.remove('cute-mode-body');
                screen.classList.remove('cute-frame');
                
                // 清除尺寸限制
                screen.style.maxWidth = '';
                screen.style.margin = '';
            }

            // C. 壁纸逻辑
            if(theme.homeWp) {
                screen.style.backgroundImage = `url('${theme.homeWp}')`;
                screen.style.backgroundSize = 'cover';
                screen.style.backgroundPosition = 'center';
            } else {
                screen.style.backgroundImage = '';
            }
            
            // D. 锁屏
            checkLockScreen(theme);
        };

        // iOS 风格锁屏检查
        function checkLockScreen(theme) {
    let lockLayer = document.getElementById('lockLayer');
    
    // 如果开启了锁屏，且未解锁
    if(theme.lockEnabled && !sessionStorage.getItem('is_unlocked')) {
        if(!lockLayer) {
            lockLayer = document.createElement('div');
            lockLayer.id = 'lockLayer';
            
            // 获取用户设置的颜色，如果没有则默认为白色
            const textColor = theme.lockTextColor || '#ffffff'; // <--- 【新增这行】

            // 基础样式
            // 【注意下面一行：将原本的 color: #fff; 改为 color: ${textColor};】
            lockLayer.style.cssText = `
                position:absolute; top:0; left:0; width:100%; height:100%;
                background-color: #333; background-size: cover; background-position: center;
                z-index: 9999; display: flex; flex-direction: column; align-items: center; 
                color: ${textColor};  /* <--- 【修改这里】 */
                padding-top: 60px; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            `;
            document.getElementById('screen').appendChild(lockLayer);
        }
                
                lockLayer.style.backgroundImage = `url('${theme.lockWp || ''}')`;
                
                // 时间日期逻辑
                const date = new Date();
                const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                const dateStr = `${date.getMonth()+1}月${date.getDate()}日 星期${"日一二三四五六".charAt(date.getDay())}`;
                
                // 处理个性化文案: [Input] of Buzzy Phone
                // 位于日期左下方，如果没输入则不显示
                let customHtml = '';
                if(theme.customText && theme.customText.trim() !== "") {
                    customHtml = `<div style="font-size:0.9rem; opacity:0.9; margin-top:2px; font-weight:500;">${theme.customText} of Buzzy Phone</div>`;
                }

                // 锁屏 HTML 结构 (壁纸层)
                // 点击壁纸层任何地方，显示密码键盘
                lockLayer.innerHTML = `
                    <div id="lockWallpaperView" style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center;" onclick="showPasscodePad()">
                        <div style="font-size:4.5rem; font-weight:300; line-height:1; margin-bottom:10px;">${timeStr}</div>
                        <div style="display:flex; flex-direction:column; align-items:flex-start;">
                            <div style="font-size:1.2rem; font-weight:400;">${dateStr}</div>
                            ${customHtml}
                        </div>
                        <div style="margin-top:auto; margin-bottom:30px; font-size:0.9rem; opacity:0.7; animation: bounce 2s infinite;">点击解锁</div>
                    </div>
                `;
                
                // 注入 CSS 动画
                if(!document.getElementById('lockStyles')) {
                    const s = document.createElement('style');
                    s.id = 'lockStyles';
                    s.innerHTML = `@keyframes bounce {0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);}}`;
                    document.head.appendChild(s);
                }

            } else {
                if(lockLayer) lockLayer.remove();
            }
        }

        // 显示 iOS 密码键盘 (覆盖在壁纸上) - 已修改：包含忘记密码入口
        window.showPasscodePad = async function() {
            // 获取当前主题密码设置
            const themeStr = await localforage.getItem('buzzy_active_theme');
            if(!themeStr) return unlockPhone(); // 没设置直接开
            const theme = (typeof themeStr === 'string') ? JSON.parse(themeStr) : themeStr;
            if(!theme.pwd || theme.pwd === "") return unlockPhone(); // 没密码直接开

            const lockLayer = document.getElementById('lockLayer');
            
            // 创建毛玻璃键盘层
            const padLayer = document.createElement('div');
            padLayer.id = 'passcodeLayer';
            padLayer.style.cssText = `
                position:absolute; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.2); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
                display:flex; flex-direction:column; align-items:center; justify-content:center;
                animation: fadeIn 0.3s ease; z-index: 10000;
            `;

            const pwdLen = parseInt(theme.pwdLen) || 4;
            
            // 生成圆点
            let dotsHtml = '';
            for(let i=0; i<pwdLen; i++) {
                dotsHtml += `<div class="p-dot" id="dot-${i}" style="width:12px; height:12px; border:1.5px solid #fff; border-radius:50%; margin:0 8px; transition:0.2s;"></div>`;
            }

            // 修改点：在键盘底下加了一行“忘记密码”
            padLayer.innerHTML = `
                <div style="font-size:16px; margin-bottom:20px; font-weight:500;">输入密码</div>
                <div style="display:flex; margin-bottom:40px;">${dotsHtml}</div>
                <div class="num-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px 25px;">
                    ${[1,2,3,4,5,6,7,8,9].map(n => `<div class="num-btn" onclick="typePass(${n})" style="width:70px; height:70px; border-radius:50%; background:rgba(255,255,255,0.2); display:flex; justify-content:center; align-items:center; font-size:28px; cursor:pointer; transition:0.1s;">${n}</div>`).join('')}
                    <div style="width:70px; height:70px;"></div>
                    <div class="num-btn" onclick="typePass(0)" style="width:70px; height:70px; border-radius:50%; background:rgba(255,255,255,0.2); display:flex; justify-content:center; align-items:center; font-size:28px; cursor:pointer;">0</div>
                    <div onclick="cancelPass()" style="width:70px; height:70px; display:flex; justify-content:center; align-items:center; font-size:14px; cursor:pointer;">取消</div>
                </div>
                <div onclick="showForgotModal()" style="margin-top: 30px; font-size: 13px; opacity: 0.8; text-decoration: underline; cursor: pointer; padding: 10px;">
                    忘记密码
                </div>
            `;
            
            // 点击特效 CSS
            const style = document.createElement('style');
            style.innerHTML = `
                .num-btn:active { background: rgba(255,255,255,0.5) !important; } 
                @keyframes fadeIn { from{opacity:0} to{opacity:1} }
                @keyframes shakeError { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-10px)} 40%,80%{transform:translateX(10px)} }
            `;
            padLayer.appendChild(style);
            
            lockLayer.appendChild(padLayer);
            window.currentInput = ""; // 重置输入
        }

        // --- 新增：魔法咒语逻辑 ---
        window.showForgotModal = function() {
            document.getElementById('forgotPwdModal').style.display = 'flex';
            const input = document.getElementById('magicSpellInput');
            input.value = '';
            setTimeout(() => input.focus(), 100);
        }

        window.closeForgotModal = function() {
            document.getElementById('forgotPwdModal').style.display = 'none';
        }

        window.verifySpell = function() {
            const input = document.getElementById('magicSpellInput');
            const val = input.value.trim();
            
            // 校验咒语 (Buzzy phone)
            if(val === "Buzzy phone") {
                closeForgotModal(); // 关闭弹窗
                cancelPass();       // 关闭密码盘
                unlockPhone();      // 进系统
            } else {
                input.style.border = "1px solid red";
                input.value = "";
                input.placeholder = "咒语不对哦...";
                setTimeout(() => {
                    input.style.border = "1px solid #eee";
                }, 1000);
            }
        }

        // 处理输入
        window.typePass = async function(num) {
            const themeStr = await localforage.getItem('buzzy_active_theme');
            const theme = (typeof themeStr === 'string') ? JSON.parse(themeStr) : themeStr;
            const maxLen = parseInt(theme.pwdLen) || 4;
            
            if(window.currentInput.length < maxLen) {
                window.currentInput += num;
                // 点亮圆点
                const dot = document.getElementById(`dot-${window.currentInput.length - 1}`);
                if(dot) { dot.style.background = '#fff'; }
                
                // 检查密码
                if(window.currentInput.length === maxLen) {
                    setTimeout(() => {
                        if(window.currentInput === theme.pwd) {
                            unlockPhone();
                        } else {
                            // 密码错误抖动
                            const layer = document.getElementById('passcodeLayer'); // 1. 直接获取层
if(layer) { // 2.以此为目标抖动
    layer.style.animation = 'shakeError 0.4s';
    setTimeout(() => {
        window.currentInput = "";
        document.querySelectorAll('.p-dot').forEach(d => d.style.background = 'transparent');
        layer.style.animation = '';
    }, 400);
}
                        }
                    }, 100);
                }
            }
        }

        window.cancelPass = function() {
            const pl = document.getElementById('passcodeLayer');
            if(pl) pl.remove();
        }

        function unlockPhone() {
            sessionStorage.setItem('is_unlocked', 'true');
            const l = document.getElementById('lockLayer');
            if(l) {
                l.style.transform = 'translateY(-100%)';
                // 动画结束后移除，防止遮挡
                setTimeout(() => l.remove(), 400);
            }
        }

        // --- 消息通知逻辑 ---
        let currentNotifChatId = null;
        let notifTimer = null;

        // 监听来自 chat_window 的消息
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (data && data.type === 'new_msg_notify') {
                showNotification(data);
            }
            if (data.action === 'open_listen_frame') {
                const frame = document.getElementById('listenFrame');
                frame.style.display = 'block';
                // 告诉播放器我是主页，可能需要传递一些状态
                frame.contentWindow.postMessage({action: 'show'}, '*');
            }
            if (data.action === 'closeListen') {
                document.getElementById('listenFrame').style.display = 'none';
            }
        });

        function showNotification(data) {
            const kaFrame = document.getElementById('keepAliveFrame');
            // 关键判断：如果保活窗口是显示的(display: block)，说明用户正在聊天，不弹窗
            if (kaFrame.style.display !== 'none') return;

            const banner = document.getElementById('topNotification');
            const avatar = document.getElementById('notifAvatar');
            const title = document.getElementById('notifTitle');
            const text = document.getElementById('notifText');

            // 设置内容
            currentNotifChatId = data.chatId; // 记录 ID 用于跳转
            avatar.style.backgroundImage = `url('${data.avatar}')`;
            title.innerText = data.name; // 角色备注名
            text.innerText = data.msg;   // 第一条消息内容

            // 显示动画
            banner.classList.add('show');

            // --- 极速播放 (Index) ---
            // 只有当声音有源 且 不在聊天窗口(keepAliveFrame隐藏) 时才响
            if (notifyAudio.src && document.getElementById('keepAliveFrame').style.display === 'none') {
                notifyAudio.currentTime = 0;
                notifyAudio.play().catch(() => {
                    // 如果报错，说明用户还没在主页点过，无法播放，此时无解
                });
            }
            
            // 播放系统提示音/震动 (可选)
            if(navigator.vibrate) navigator.vibrate(50);

            // 3.5秒后自动收起
            if(notifTimer) clearTimeout(notifTimer);
            notifTimer = setTimeout(() => {
                banner.classList.remove('show');
            }, 3500);
        }

        function onNotificationClick() {
            if(currentNotifChatId) {
                // 点击弹窗，直接跳转到对应角色的聊天窗口
                openApp(`chat_window.html?id=${currentNotifChatId}`);
                // 收起弹窗
                document.getElementById('topNotification').classList.remove('show');
            }
        }
        
        document.body.addEventListener('click', () => {
            if(notifyAudio.src) {
                // 尝试播放一瞬间来解锁
                notifyAudio.play().then(() => {
                    notifyAudio.pause();
                    notifyAudio.currentTime = 0;
                }).catch(()=>{});
            }
        }, { once: true });
        
        // --- 强力加载音频 (Index) ---
        async function loadNotifySound() {
            try {
                const themeStr = await localforage.getItem('buzzy_active_theme');
                if (themeStr) {
                    const theme = (typeof themeStr === 'string') ? JSON.parse(themeStr) : themeStr;
                    if (theme.msgSound && theme.msgSound.startsWith('http')) {
                        notifyAudio.src = theme.msgSound;
                        notifyAudio.volume = 0.5;
                        notifyAudio.load();
                    }
                }
            } catch(e) {}
        }

        // 用户点击屏幕任意位置，解锁 index 页面的声音
        document.body.addEventListener('click', () => {
            if(notifyAudio.src) {
                notifyAudio.play().then(() => {
                    notifyAudio.pause();
                    notifyAudio.currentTime = 0;
                }).catch(()=>{});
            }
        }, { once: true }); // 只执行一次即可

        // 修改原本的 onload
        window.onload = async function() { // 1. 加 async
    await loadLayout();            // 2. 等待布局加载完毕
    registerInstalledApps();       // (这个存数据的可以不加 await)
    await reloadTheme();           // 3. 等待主题应用完毕
    loadNotifySound(); 
};

        // --- 全局悬浮字幕逻辑 ---
        const subEl = document.getElementById('globalSubtitle');
        let isSubDragging = false;
        let subOffsets = { x: 0, y: 0 };

        window.addEventListener('message', (e) => {
            const data = e.data;
            if(!data) return;

            if (data.type === 'toggle_global_subtitle') {
                if(data.show) {
                    subEl.style.display = 'block';
                    applySubConfig(data.config);
                    subEl.innerText = data.text || "...";
                } else {
                    subEl.style.display = 'none';
                }
            }
            else if (data.type === 'update_subtitle') {
                subEl.innerText = data.text || "...";
                if(data.config) applySubConfig(data.config);
            }
        });

        function applySubConfig(cfg) {
            if(!cfg) return;
            subEl.style.fontSize = cfg.size + 'px';
            subEl.style.color = cfg.color;
            // 处理不透明度：转换 Hex 为 RGBA 或者直接用 opacity (会影响文字)
            // 更好的方式是背景透明度，文字保持清晰，但用户需求通常是整体透明度
            // 这里我们用 text-shadow 保证文字可见性，用 opacity 控制整体
            subEl.style.opacity = cfg.opacity;
            
            subEl.style.background = 'transparent'; 
        }

        // 简单的拖动逻辑 (Touch & Mouse)
        subEl.style.pointerEvents = 'auto'; // 允许点击拖动
        
        function handleDragStart(clientX, clientY) {
            isSubDragging = true;
            const rect = subEl.getBoundingClientRect();
            subOffsets.x = clientX - rect.left;
            subOffsets.y = clientY - rect.top;
            subEl.style.transform = 'none'; // 移除居中变换，改为绝对定位
            subEl.style.left = rect.left + 'px';
            subEl.style.top = rect.top + 'px';
        }

        function handleDragMove(clientX, clientY) {
            if(!isSubDragging) return;
            // 限制在屏幕内
            let newX = clientX - subOffsets.x;
            let newY = clientY - subOffsets.y;
            subEl.style.left = newX + 'px';
            subEl.style.top = newY + 'px';
        }

        function handleDragEnd() { isSubDragging = false; }

        // Mouse events
        subEl.addEventListener('mousedown', e => handleDragStart(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => handleDragMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', handleDragEnd);

        // Touch events
        subEl.addEventListener('touchstart', e => {
            handleDragStart(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault(); // 防止滚动
        }, {passive: false});
        window.addEventListener('touchmove', e => {
            if(isSubDragging) {
                handleDragMove(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            }
        }, {passive: false});
        window.addEventListener('touchend', handleDragEnd);
    </script>
</body>
</html>
