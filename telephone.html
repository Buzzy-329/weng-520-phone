<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect Phone</title>
    <style>
        /* --- 1. åŸºç¡€æ¶æ„ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: linear-gradient(180deg, #fff0f5 0%, #fff 100%);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            color: #333; overflow: hidden; position: relative;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ  --- */
        .nav-bar {
            padding: 50px 24px 15px 24px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);
            position: absolute; top:0; left:0; width:100%; z-index: 10;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            height: 100px; /* å›ºå®šé«˜åº¦ */
        }
        .back-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2);
            font-size: 18px; color: #888; transition: transform 0.2s;
        }
        .back-btn:active { transform: scale(0.9); }
        .page-title { font-size: 18px; font-weight: 600; color: #7a6a6a; }
        .header-right-btn { 
            width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; 
            font-size: 24px; color: #ffb7b2; cursor: pointer; 
        }

        /* --- 3. åº•éƒ¨æ ‡ç­¾æ  --- */
        .tab-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: #fff; border-top: 1px solid #f0f0f0;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 20px; z-index: 20;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #ccc; cursor: pointer; transition: color 0.3s;
        }
        .tab-item.active { color: #ffb7b2; }
        .tab-icon { font-size: 24px; }
        .tab-text { font-size: 10px; font-weight: bold; }

        /* --- 4. ä¸»å†…å®¹å¯è§†åŒº --- */
        .main-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding-top: 100px; padding-bottom: 80px; 
            overflow-y: auto; display: none;
            flex-direction: column;
        }
        .main-view.active { display: flex; }

        /* --- é€šè®¯å½•æ ·å¼ --- */
        /* ä¿®æ”¹ç‚¹ï¼šå¢åŠ margin-topé˜²æ­¢è´´é¡¶ */
        .search-box {
            margin: 20px 20px 10px 20px; padding: 12px 15px;
            background: #fff; border-radius: 12px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            flex-shrink: 0;
        }
        .search-input { border: none; background: transparent; font-size: 14px; width: 100%; color: #333; }
        
        .contact-list { flex: 1; overflow-y: auto; position: relative; }
        .contact-list::-webkit-scrollbar { display: none; }
        
        .contact-row {
            padding: 15px 20px; display: flex; align-items: center; gap: 15px;
            background: #fff; border-bottom: 1px solid #f9f9f9;
            transition: background 0.2s; position: relative; overflow: hidden;
        }
        .contact-row:active { background: #fff0f5; }
        .contact-avatar {
            width: 44px; height: 44px; border-radius: 50%; background: #eee;
            object-fit: cover; border: 1px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .contact-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .contact-name { font-size: 16px; font-weight: 600; color: #333; }
        .contact-phone { font-size: 12px; color: #999; }
        .contact-group-title {
            padding: 5px 20px;
            background: #f4f4f4;
            color: #888;
            font-size: 14px;
            font-weight: bold;
        }
        .contact-index { 
            position: fixed; right: 5px; top: 130px; bottom: 90px; width: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 10px; color: #ffb7b2; font-weight: bold; gap: 2px;
        }

         /* --- æ‹¨å·é”®ç›˜æ ·å¼ (é»˜è®¤é¡µ) --- */
        #tab-keypad {
            background: #ffe4e1; /* æ·¡ç²‰è‰²èƒŒæ™¯ */
            padding-top: 100px; /* ã€ä¿®æ”¹ç‚¹ã€‘æ”¹ä¸º100pxï¼Œç»™é¡¶éƒ¨å¯¼èˆªæ ç•™ä½ç½® */
            /* z-index: 15; ã€ä¿®æ”¹ç‚¹ã€‘åˆ æ‰è¿™ä¸€è¡Œæˆ–è€…æ³¨é‡Šæ‰ï¼Œä¸è¦é®æŒ¡å¯¼èˆªæ  */
            justify-content: flex-end; /* å†…å®¹é ä¸‹ */
            padding-bottom: 100px;
        }
        
        /* é—ªçƒæ˜Ÿæ˜ŸåŠ¨ç”» */
        .star-hollow {
             position: absolute; color: #fff; font-size: 20px; opacity: 0.8;
             animation: twinkle 2s infinite ease-in-out; pointer-events: none;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        .dial-display {
            height: 80px; display: flex; justify-content: center; align-items: center;
            font-size: 36px; font-weight: 500; color: #333; letter-spacing: 2px;
            padding: 0 40px; white-space: nowrap; overflow: hidden; margin-bottom: 20px; z-index: 2;
        }
        
        .keypad-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 20px 30px; padding: 0 50px; justify-items: center; z-index: 2;
        }
        
        .dial-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: background 0.2s;
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.4);
        }
        .dial-btn:active { background: rgba(255,255,255,0.9); }
        .dial-num { font-size: 28px; font-weight: 400; color: #333; line-height: 1; }
        .dial-sub { font-size: 10px; color: #666; font-weight: 600; letter-spacing: 1px; }
        
        .action-area {
            margin-top: 30px; display: flex; justify-content: center; align-items: center; gap: 40px; z-index: 2;
        }
        /* ä¿®æ”¹ç‚¹ï¼šä¿®å¤å›¾æ ‡æˆä¸€å¨çš„é—®é¢˜ï¼Œä½¿ç”¨SVG */
        .call-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: #4cd964; /* ç»¿è‰² */
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 15px rgba(76, 217, 100, 0.4);
            cursor: pointer;
        }
        .call-btn svg { width: 32px; height: 32px; fill: white; }
        
        .del-btn {
            width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
            color: #666; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.2s;
            font-size: 24px;
        }

        /* --- æœ€è¿‘é€šè¯ (Recents) --- */
        .recents-list { padding: 10px 20px; }
        .recent-item {
            padding: 15px 0; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .recent-main { display: flex; flex-direction: column; gap: 4px; }
        .recent-name { font-size: 16px; font-weight: 600; color: #333; } 
        .recent-info { font-size: 12px; color: #888; display: flex; align-items: center; gap: 5px; }
        .recent-time { font-size: 14px; color: #aaa; }

        /* --- é€šè¯ä¸­ç•Œé¢ (Overlay) --- */
        .call-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #000 100%); 
            z-index: 100; display: none; flex-direction: column; align-items: center;
            padding-top: 80px; padding-bottom: 40px; color: #fff;
            transition: opacity 0.5s;
        }
        .call-avatar-box {
            width: 120px; height: 120px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            padding: 4px; position: relative;
        }
        .call-avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .call-status { margin-top: 20px; font-size: 14px; color: rgba(255,255,255,0.7); letter-spacing: 1px; }
        .call-timer { margin-top: 5px; font-size: 32px; font-weight: 300; font-variant-numeric: tabular-nums; }
        
        .chat-scroll-area { 
            flex: 1; width: 100%; margin: 30px 0; padding: 0 24px;
            overflow-y: scroll; scrollbar-width: none; 
            display: flex; flex-direction: column; gap: 15px; 
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
        }
        .chat-scroll-area::-webkit-scrollbar { display: none; }

        .call-msg { font-size: 15px; line-height: 1.5; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .call-msg.them { color: #fff; text-align: left; }
        .call-msg.me { color: #a9fdac; text-align: right; }
        
        .call-controls { width: 100%; padding: 0 40px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .speech-input {
            width: 100%; padding: 12px 20px; border-radius: 25px; border: none;
            background: rgba(255,255,255,0.15); color: #fff; font-size: 15px;
            backdrop-filter: blur(5px); transition: background 0.3s;
        }
        .speech-input:focus { background: rgba(255,255,255,0.25); }
        .hangup-btn {
            width: 70px; height: 70px; border-radius: 50%; background: #ff3b30;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 59, 48, 0.4);
        }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        /* --- å¼¹çª— (Modals) --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 200; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-mask.show { opacity: 1; }
        .modal-body {
            background: #fff; width: 85%; max-width: 320px;
            border-radius: 24px; padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; gap: 15px;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-mask.show .modal-body { transform: scale(1); }
        
        .modal-title { font-size: 18px; font-weight: 600; text-align: center; color: #333; margin-bottom: 5px; }
        .modal-desc { font-size: 13px; color: #888; text-align: center; line-height: 1.4; }
        
        .m-input-group { display: flex; flex-direction: column; gap: 5px; }
        .m-label { font-size: 11px; color: #ffb7b2; font-weight: bold; margin-left: 5px; }
        .m-input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #f0f0f0;
            background: #fafafa; font-size: 14px; color: #555;
        }
        
        .m-btns { display: flex; gap: 10px; margin-top: 10px; }
        .m-btn {
            flex: 1; padding: 12px; border-radius: 14px; border: none;
            font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .btn-cancel { background: #f5f5f5; color: #999; }
        .btn-confirm { background: #ffb7b2; color: #fff; }
        .btn-delete { background: #ffebeb; color: #ff6b6b; }

        /* åˆ—è¡¨é€‰æ‹©åˆ—è¡¨ */
        .select-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .select-item { 
            padding: 10px; background: #f9f9f9; border-radius: 10px; 
            display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .select-item.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .select-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }

        /* Toast */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 13px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 300;
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª (é€šè®¯å½•/æœ€è¿‘é€šè¯ç”¨) -->
    <div class="nav-bar" id="navBar">
        <div class="back-btn" onclick="exitApp()">â†</div>
        <div class="page-title" id="pageTitle">ç”µè¯</div>
        <!-- å³ä¸Šè§’æŒ‰é’®ï¼ŒJSæ§åˆ¶åŠŸèƒ½ -->
        <div class="header-right-btn" id="headerRightBtn"></div>
    </div>

    <!-- 1. é€šè®¯å½•ç•Œé¢ -->
    <div class="main-view" id="tab-contacts">
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" class="search-input" placeholder="æŸ¥æ‰¾è”ç³»äºº" oninput="renderContacts(this.value)">
        </div>
        <div class="contact-list" id="contactListEl">
            <!-- åˆ—è¡¨ JS ç”Ÿæˆ -->
        </div>
        <div class="contact-index" id="alphaIndex">
            <!-- å­—æ¯ç´¢å¼• -->
        </div>
    </div>

    <!-- 2. æ‹¨å·é”®ç›˜ç•Œé¢ -->
    <div class="main-view active" id="tab-keypad">
        <div id="starContainer"></div> <!-- æ˜Ÿæ˜Ÿå®¹å™¨ -->
        
        <div class="dial-display" id="dialDisplay"></div>
        
        <div class="keypad-grid">
            <div class="dial-btn" onclick="pressKey('1')"><div class="dial-num">1</div><div class="dial-sub">&nbsp;</div></div>
            <div class="dial-btn" onclick="pressKey('2')"><div class="dial-num">2</div><div class="dial-sub">ABC</div></div>
            <div class="dial-btn" onclick="pressKey('3')"><div class="dial-num">3</div><div class="dial-sub">DEF</div></div>
            <div class="dial-btn" onclick="pressKey('4')"><div class="dial-num">4</div><div class="dial-sub">GHI</div></div>
            <div class="dial-btn" onclick="pressKey('5')"><div class="dial-num">5</div><div class="dial-sub">JKL</div></div>
            <div class="dial-btn" onclick="pressKey('6')"><div class="dial-num">6</div><div class="dial-sub">MNO</div></div>
            <div class="dial-btn" onclick="pressKey('7')"><div class="dial-num">7</div><div class="dial-sub">PQRS</div></div>
            <div class="dial-btn" onclick="pressKey('8')"><div class="dial-num">8</div><div class="dial-sub">TUV</div></div>
            <div class="dial-btn" onclick="pressKey('9')"><div class="dial-num">9</div><div class="dial-sub">WXYZ</div></div>
            <div class="dial-btn" onclick="pressKey('*')"><div class="dial-num" style="padding-top:10px">*</div></div>
            <div class="dial-btn" onclick="pressKey('0')"><div class="dial-num">0</div><div class="dial-sub">+</div></div>
            <div class="dial-btn" onclick="pressKey('#')"><div class="dial-num" style="padding-top:10px">#</div></div>
        </div>

        <div class="action-area">
            <div style="width:50px"></div>
            <div class="call-btn" onclick="tryCall()">
                <!-- ä¿®æ­£åçš„é€šè¯å›¾æ ‡SVG -->
                <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </div>
            <div class="del-btn" id="delBtn" onclick="deleteKey()">âŒ«</div>
        </div>
    </div>

    <!-- 3. æœ€è¿‘é€šè¯ç•Œé¢ -->
    <div class="main-view" id="tab-recents">
        <div class="recents-list" id="recentsListEl">
            <!-- åˆ—è¡¨ JS ç”Ÿæˆ -->
        </div>
    </div>

    <!-- åº•éƒ¨ Tab -->
    <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('contacts')">
            <span class="tab-icon">ğŸ“–</span><span class="tab-text">é€šè®¯å½•</span>
        </div>
        <div class="tab-item active" onclick="switchTab('keypad')">
            <span class="tab-icon">âŒ¨ï¸</span><span class="tab-text">æ‹¨å·</span>
        </div>
        <div class="tab-item" onclick="switchTab('recents')">
            <span class="tab-icon">ğŸ•’</span><span class="tab-text">æœ€è¿‘é€šè¯</span>
        </div>
    </div>

    <!-- é€šè¯ Overlay -->
    <div class="call-overlay" id="callOverlay">
        <div class="call-avatar-box">
            <img id="callAvatar" src="" class="call-avatar-img">
        </div>
        <div class="call-status" id="callStatus">æ­£åœ¨å‘¼å«...</div>
        <div class="call-timer" id="callTimer">--:--</div>
        
        <div class="chat-scroll-area" id="callChatArea"></div>

        <div class="call-controls">
            <input type="text" class="speech-input" id="speechInput" placeholder="è¾“å…¥è¯´è¯..." autocomplete="off">
            <div class="hangup-btn" onclick="endCall()">
                <!-- æŒ‚æ–­å›¾æ ‡ -->
                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(135deg);"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 1: é€‰æ‹© QQ è§’è‰² -->
    <div class="modal-mask" id="selectCharModal">
        <div class="modal-body">
            <div class="modal-title">æ·»åŠ åˆ°é€šè®¯å½•</div>
            <div class="select-list" id="qqCharList"></div>
            <div class="m-btns"><button class="m-btn btn-cancel" onclick="closeModal('selectCharModal')">å–æ¶ˆ</button></div>
        </div>
    </div>

    <!-- å¼¹çª— 2: ç¼–è¾‘/æ·»åŠ è¯¦æƒ… -->
    <div class="modal-mask" id="editContactModal">
        <div class="modal-body">
            <div class="modal-title" id="editModalTitle">æ·»åŠ è”ç³»äºº</div>
            <div class="m-input-group">
                <span class="m-label">å¤‡æ³¨å</span>
                <input type="text" class="m-input" id="editName">
            </div>
            <div class="m-input-group">
                <span class="m-label">ç”µè¯å·ç  (æ•°å­—)</span>
                <input type="tel" class="m-input" id="editPhone" maxlength="11">
            </div>
            <div class="m-input-group">
                <span class="m-label">é“ƒå£° URL (å¯é€‰)</span>
                <input type="text" class="m-input" id="editRingtone" placeholder="http://...">
            </div>
            <div class="m-btns">
                <button class="m-btn btn-cancel" onclick="closeModal('editContactModal')">å–æ¶ˆ</button>
                <button class="m-btn btn-confirm" onclick="saveContact()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 3: å½’æ¡£è®°å¿†ä¸­ -->
    <div class="modal-mask" id="archivingModal">
        <div class="modal-body">
            <div class="modal-title">é€šè¯ç»“æŸ</div>
            <div class="modal-desc">
                æ­£åœ¨å½’æ¡£è®°å¿†åˆ°è®°å¿†åº“<span class="loading-dots"></span><br>
                è¯·å‹¿å…³é—­...
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 4: æ— ç”¨æˆ·è­¦å‘Š -->
    <div class="modal-mask" id="alertModal">
        <div class="modal-body">
            <div class="modal-title">æç¤º</div>
            <div class="modal-desc" id="alertMsg">ç”¨æˆ·ä¸å­˜åœ¨</div>
            <div class="m-btns"><button class="m-btn btn-confirm" onclick="closeModal('alertModal')">çŸ¥é“äº†</button></div>
        </div>
    </div>

    <!-- å¼¹çª— 5: ç¡®è®¤æ¸…ç©ºæœ€è¿‘é€šè¯ -->
    <div class="modal-mask" id="confirmClearModal">
        <div class="modal-body">
            <div class="modal-title">æ¸…ç©ºè®°å½•</div>
            <div class="modal-desc">ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ€è¿‘é€šè¯è®°å½•å—ï¼Ÿ</div>
            <div class="m-btns">
                <button class="m-btn btn-cancel" onclick="closeModal('confirmClearModal')">å–æ¶ˆ</button>
                <button class="m-btn btn-delete" onclick="doClearRecents()">æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 6: åˆ é™¤/ä¿®æ”¹è”ç³»äºº -->
    <div class="modal-mask" id="contactOptionModal">
        <div class="modal-body">
            <div class="modal-title" id="optContactName">é€‰é¡¹</div>
            <div class="m-btns" style="flex-direction: column;">
                <button class="m-btn btn-confirm" onclick="openModifyContact()">ä¿®æ”¹èµ„æ–™</button>
                <button class="m-btn btn-delete" onclick="deleteContact()">åˆ é™¤è”ç³»äºº</button>
                <button class="m-btn btn-cancel" onclick="closeModal('contactOptionModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šç¡®è®¤åˆ é™¤è”ç³»äººå¼¹çª— -->
    <div class="modal-mask" id="confirmDelContactModal">
        <div class="modal-body">
            <div class="modal-title">åˆ é™¤è”ç³»äºº</div>
            <div class="modal-desc">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè”ç³»äººå—ï¼Ÿ</div>
            <div class="m-btns">
                <button class="m-btn btn-cancel" onclick="closeModal('confirmDelContactModal')">å–æ¶ˆ</button>
                <button class="m-btn btn-delete" onclick="doRealDeleteContact()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>
    <audio id="ringtoneAudio" loop></audio>

    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    
    <script>
        // --- æ ¸å¿ƒï¼šæ•°æ®åº“è¿æ¥å·¥å…· ---
        const phoneChannel = new BroadcastChannel('buzzy_sync_channel');
        let dbPromise;
        function initDB() {
            if (!dbPromise) {
    dbPromise = idb.openDB('QQ_DB_2026', 1, {
        upgrade(db) {
            // è¿™é‡Œåªåšä¸€ä»¶äº‹ï¼šå¦‚æœæ²¡æœ‰ keyval è¡¨ï¼Œå°±å»ºä¸€ä¸ª
            if (!db.objectStoreNames.contains('keyval')) {
                db.createObjectStore('keyval');
            }
        },
    });
}
            return dbPromise;
        }
        async function dbGet(key) {
            const db = await initDB();
            return await db.get('keyval', key);
        }
        async function dbSet(key, val) {
            const db = await initDB();
            return await db.put('keyval', val, key);
        }
        // --- æ ¸å¿ƒæ•°æ®KEY ---
        const DB_QQ_KEY = 'qq_app_data_pro_max_final'; // QQè§’è‰²æ•°æ®æº
        const DB_WB_KEY = 'wb_books'; // ä¸–ç•Œä¹¦æ•°æ®æº
        const DB_PHONE_CONTACTS = 'phone_contacts'; // æœ¬åœ°å­˜å‚¨ï¼šé€šè®¯å½•
        const DB_PHONE_RECENTS = 'phone_recents'; // æœ¬åœ°å­˜å‚¨ï¼šé€šè¯è®°å½•
        const API_KEY_STORAGE = 'aiPhone_presets';
        const API_ID_STORAGE = 'aiPhone_currentId';

        let contacts = []; 
        let recents = []; 
        let dialNumber = "";
        
        let currentTab = 'keypad';
        let selectedContactId = null;

        // é€šè¯çŠ¶æ€å¯¹è±¡
        let activeCall = null; 

        // --- æ±‰å­—è½¬æ‹¼éŸ³é¦–å­—æ¯è¾…åŠ©å‡½æ•° ---
        function getPyFirstLetter(str) {
            if (!str || typeof str !== 'string') return '#';
            const c = str.charAt(0);
            // å¦‚æœæ˜¯è‹±æ–‡ï¼Œç›´æ¥è¿”å›å¤§å†™
            if (/[a-zA-Z]/.test(c)) return c.toUpperCase();
            // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œåˆ©ç”¨ localeCompare è¾¹ç•Œå­—ç¬¦åˆ¤æ–­
            const zh = "é˜¿å…«åš“å“’è›¾å‘å™¶å“ˆå‡»å’”åƒå¦ˆæ‹¿å“¦å•ªæœŸç„¶æ’’å¡ŒæŒ–æ˜”å‹åŒ".split('');
            const en = "ABCDEFGHJKLMNOPQRSTWXYZ".split('');
            if (c.localeCompare('é˜¿', 'zh') < 0) return '#';
            if (c.localeCompare('åŒ', 'zh') > 0) return 'Z';
            
            for (let i = 0; i < zh.length; i++) {
                if (c.localeCompare(zh[i], 'zh') === 0) return en[i];
                if (c.localeCompare(zh[i], 'zh') < 0) return en[i - 1];
            }
            return '#';
        }
        
        // --- åˆå§‹åŒ– ---
        window.onload = async function() {
            await loadData();
            createStars();
            switchTab('keypad'); 
            
            // å›è½¦å‘é€
            document.getElementById('speechInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') handleUserSpeak();
            });
        };

        function exitApp() {
            if(window.parent && window.parent.closeApp) window.parent.closeApp();
            else history.back();
        }

        // --- æ•°æ®åŠ è½½ ---
        async function loadData() {
            // è¯»å–é€šè®¯å½•
            const cRaw = await dbGet(DB_PHONE_CONTACTS);
            contacts = (typeof cRaw === 'string') ? JSON.parse(cRaw) : (cRaw || []);
            
            // è¯»å–é€šè¯è®°å½•
            const rRaw = await dbGet(DB_PHONE_RECENTS);
            recents = (typeof rRaw === 'string') ? JSON.parse(rRaw) : (rRaw || []);
        }

        async function saveData() {
            // è½¬ä¸ºå­—ç¬¦ä¸²ä¿å­˜ï¼Œä¿æŒæ ¼å¼ç»Ÿä¸€
            await dbSet(DB_PHONE_CONTACTS, JSON.stringify(contacts));
            await dbSet(DB_PHONE_RECENTS, JSON.stringify(recents));
        }

        // --- UI ç”Ÿæˆ: èƒŒæ™¯æ˜Ÿæ˜Ÿ ---
        function createStars() {
            const container = document.getElementById('starContainer');
            for(let i=0; i<15; i++) {
                const star = document.createElement('div');
                star.className = 'star-hollow';
                star.innerHTML = 'â˜†'; 
                star.style.left = Math.random() * 90 + '%';
                star.style.top = Math.random() * 80 + '%';
                const scale = 0.5 + Math.random();
                star.style.fontSize = (20 * scale) + 'px';
                star.style.animationDelay = (Math.random() * 2) + 's';
                container.appendChild(star);
            }
        }

        // --- æ ‡ç­¾åˆ‡æ¢é€»è¾‘ ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.tab-item');
            
            if(tab === 'contacts') items[0].classList.add('active');
            if(tab === 'keypad') items[1].classList.add('active');
            if(tab === 'recents') items[2].classList.add('active');

            document.querySelectorAll('.main-view').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            const navBar = document.getElementById('navBar');
            const pageTitle = document.getElementById('pageTitle');
            const rightBtn = document.getElementById('headerRightBtn');

            // ä¿®æ”¹ç‚¹ï¼šæ‰€æœ‰ç•Œé¢éƒ½æ˜¾ç¤ºé¡¶éƒ¨æ ï¼Œç»Ÿä¸€é£æ ¼
            navBar.style.display = 'flex';
            rightBtn.onclick = null; // é‡ç½®ç‚¹å‡»äº‹ä»¶
            rightBtn.innerText = '';

            if(tab === 'contacts') {
                pageTitle.innerText = 'é€šè®¯å½•';
                rightBtn.innerText = '+'; 
                rightBtn.style.fontSize = '24px';
                rightBtn.onclick = openSelectCharModal; 
                renderContacts(); // æ¯æ¬¡åˆ‡æ¢å›æ¥åˆ·æ–°åˆ—è¡¨
            } else if(tab === 'recents') {
                pageTitle.innerText = 'æœ€è¿‘é€šè¯';
                rightBtn.innerText = 'ğŸ—‘ï¸'; 
                rightBtn.style.fontSize = '18px';
                rightBtn.onclick = () => openModal('confirmClearModal'); 
                renderRecents();
            } else if(tab === 'keypad') {
                pageTitle.innerText = 'æ‹¨å·é”®ç›˜';
                // æ‹¨å·é¡µå³ä¸Šè§’å¦‚æœä¸éœ€è¦åŠŸèƒ½ï¼Œå¯ä»¥ç•™ç©ºï¼Œæˆ–è€…åŠ ä¸ªè®¾ç½®
            }
        }

        // --- é€šè®¯å½•é€»è¾‘ ---
        function renderContacts(filter='') {
            const list = document.getElementById('contactListEl');
            const indexEl = document.getElementById('alphaIndex');
            list.innerHTML = ''; indexEl.innerHTML = '';
            
            // 1. è¿‡æ»¤
            let displayList = contacts.filter(c => {
                if(!filter) return true;
                const f = filter.toLowerCase();
                return c.name.toLowerCase().includes(f) || c.phone.includes(f);
            });

            // 2. æ’åº (åˆ©ç”¨ä¸­æ–‡ localeCompare æ’åºï¼Œè®©â€œç¨‹â€æ’åœ¨â€œå¸¸â€åé¢ç­‰)
            displayList.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));

            // 3. ç”Ÿæˆå³ä¾§ç´¢å¼•æ¡
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ#";
            for(let char of chars) {
                let s = document.createElement('div');
                s.innerText = char;
                indexEl.appendChild(s);
            }

            // 4. åˆ†ç»„æ¸²æŸ“ (ä½¿ç”¨æ–°çš„ getPyFirstLetter å‡½æ•°)
            let currentGroup = '';
            
            displayList.forEach(c => {
                // ã€ä¿®æ”¹ç‚¹ã€‘è¿™é‡Œè°ƒç”¨åˆšæ‰æ·»åŠ çš„å‡½æ•°ï¼Œç¨‹ -> C
                let firstChar = getPyFirstLetter(c.name);

                // å¦‚æœå½“å‰é¦–å­—æ¯å’Œä¸Šä¸€ä¸ªä¸ä¸€æ ·ï¼Œä¸”ä¸åœ¨æœç´¢æ¨¡å¼ä¸‹ï¼Œåˆ™æ·»åŠ åˆ†ç»„å¤´
                if (firstChar !== currentGroup && !filter) {
                    currentGroup = firstChar;
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'contact-group-title';
                    groupTitle.innerText = currentGroup;
                    list.appendChild(groupTitle);
                }

                const div = document.createElement('div');
                div.className = 'contact-row';
                div.innerHTML = `
                    <img src="${c.avatar || ''}" class="contact-avatar">
                    <div class="contact-info">
                        <div class="contact-name">${c.name}</div>
                        <div class="contact-phone">${c.phone}</div>
                    </div>
                    <div style="color:#ddd; font-size:18px;">â“˜</div> 
                `;
                div.onclick = () => openContactOptions(c);
                list.appendChild(div);
            });
        }

        // æ·»åŠ æµç¨‹ï¼šä»QQè°ƒå–
        async function openSelectCharModal() {
            const raw = await dbGet(DB_QQ_KEY);
            const qqData = (typeof raw === 'string') ? JSON.parse(raw) : (raw || []);
            const list = document.getElementById('qqCharList');
            list.innerHTML = '';
            
            qqData.forEach(q => {
                if(q.type === 'group') return; 
                // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é€šè®¯å½•
                const exists = contacts.find(c => c.id === q.id);
                
                const div = document.createElement('div');
                div.className = `select-item ${exists ? 'disabled' : ''}`;
                div.innerHTML = `
                    <img src="${q.avatar||''}" class="select-avatar">
                    <span>${q.name}</span>
                    ${exists ? '<span style="font-size:10px;color:#999;margin-left:auto;">å·²æ·»åŠ </span>' : ''}
                `;
                if(!exists) {
                    div.onclick = () => {
                        closeModal('selectCharModal');
                        openEditContact(q);
                    };
                }
                list.appendChild(div);
            });
            openModal('selectCharModal');
        }

        function openEditContact(qqChar) {
            selectedContactId = qqChar.id; 
            document.getElementById('editModalTitle').innerText = 'æ·»åŠ è”ç³»äºº';
            document.getElementById('editName').value = qqChar.name;
            document.getElementById('editPhone').value = '';
            document.getElementById('editRingtone').value = '';
            document.getElementById('editName').dataset.avatar = qqChar.avatar || '';
            openModal('editContactModal');
        }

        function openModifyContact() {
            closeModal('contactOptionModal');
            const c = contacts.find(x => x.id === selectedContactId);
            if(!c) return;
            document.getElementById('editModalTitle').innerText = 'ä¿®æ”¹èµ„æ–™';
            document.getElementById('editName').value = c.name;
            document.getElementById('editName').dataset.avatar = c.avatar;
            document.getElementById('editPhone').value = c.phone;
            document.getElementById('editRingtone').value = c.ringtone || '';
            openModal('editContactModal');
        }

        function saveContact() {
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const ringtone = document.getElementById('editRingtone').value.trim();
            const avatar = document.getElementById('editName').dataset.avatar;

            if(!name || !phone) { showToast('è¯·å¡«å†™å§“åå’Œå·ç '); return; }

            const existingIndex = contacts.findIndex(c => c.id === selectedContactId);
            const newContact = { id: selectedContactId, name, phone, ringtone, avatar };

            if(existingIndex >= 0) contacts[existingIndex] = newContact;
            else contacts.push(newContact);
            
            saveData();
            renderContacts();
            closeModal('editContactModal');
        }

        function openContactOptions(c) {
            selectedContactId = c.id;
            document.getElementById('optContactName').innerText = c.name;
            // æ‰“å¼€åŒ…å«ä¿®æ”¹/åˆ é™¤æŒ‰é’®çš„å¼¹çª—
            openModal('contactOptionModal');
        }

        // ç‚¹å‡»â€œåˆ é™¤è”ç³»äººâ€æŒ‰é’®ï¼Œåªè´Ÿè´£å¼¹çª—è¯¢é—®
        function deleteContact() {
            closeModal('contactOptionModal'); // å…³é—­ä¸Šçº§èœå•
            setTimeout(() => {
                openModal('confirmDelContactModal'); // æ‰“å¼€ç¡®è®¤åˆ é™¤å¼¹çª—
            }, 300);
        }

        // çœŸæ­£çš„åˆ é™¤é€»è¾‘ (åœ¨ç¡®è®¤å¼¹çª—ç‚¹ç¡®å®šåæ‰§è¡Œ)
        function doRealDeleteContact() {
            contacts = contacts.filter(c => c.id !== selectedContactId);
            saveData();
            renderContacts(); // åˆ·æ–°åˆ—è¡¨ï¼Œè¢«åˆ é™¤çš„äººä¼šè‡ªåŠ¨ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
            
            // QQåˆ—è¡¨é‚£è¾¹æ˜¯é€šè¿‡åˆ¤æ–­ contacts é‡Œæœ‰æ²¡æœ‰ id æ¥å†³å®šæ˜¯å¦å˜ç°çš„
            // æ‰€ä»¥åˆ é™¤äº†è¿™é‡Œï¼Œé‚£è¾¹è‡ªåŠ¨å°±ä¼šå˜å›å¯æ·»åŠ çŠ¶æ€
            
            closeModal('confirmDelContactModal');
            showToast('è”ç³»äººå·²åˆ é™¤');
        }

        // --- æ‹¨å·é€»è¾‘ ---
        function pressKey(key) {
            if(dialNumber.length < 15) dialNumber += key;
            updateDialDisplay();
        }
        function deleteKey() {
            dialNumber = dialNumber.slice(0, -1);
            updateDialDisplay();
        }
        function updateDialDisplay() {
            document.getElementById('dialDisplay').innerText = dialNumber;
            document.getElementById('delBtn').style.opacity = dialNumber.length > 0 ? 1 : 0;
            document.getElementById('delBtn').style.pointerEvents = dialNumber.length > 0 ? 'auto' : 'none';
        }

        function tryCall() {
            if(!dialNumber) return;
            const target = contacts.find(c => c.phone === dialNumber);
            if(target) {
                startCall(target);
            } else {
                document.getElementById('alertMsg').innerText = "ç”¨æˆ·ä¸å­˜åœ¨";
                openModal('alertModal');
            }
        }

        // --- é€šè¯æ ¸å¿ƒé€»è¾‘ (Strict No-OOC) ---
        async function startCall(contact) {
            document.getElementById('callOverlay').style.display = 'flex';
            document.getElementById('callStatus').innerText = "æ­£åœ¨æ¥é€š...";
            document.getElementById('callTimer').innerText = "--:--";
            document.getElementById('callAvatar').src = contact.avatar || '';
            document.getElementById('callChatArea').innerHTML = ''; 
            
            if(contact.ringtone) {
                const audio = document.getElementById('ringtoneAudio');
                audio.src = contact.ringtone;
                try { audio.play(); } catch(e){}
            }

            // ã€å…³é”®é€»è¾‘ã€‘ä» QQ æ•°æ®æºè·å–äººè®¾å’Œä¸–ç•Œä¹¦
            const rawQQ = await dbGet(DB_QQ_KEY);
            const qqData = (typeof rawQQ === 'string') ? JSON.parse(rawQQ) : (rawQQ || []);
            
            const charData = qqData.find(q => q.id === contact.id);
            if(!charData) { endCall(); return; } 

            // å¤„ç†ä¸–ç•Œä¹¦
            let wbContent = "";
            let activeBookIds = charData.worldBookIds || [];
            // å…¼å®¹å•é€‰
            if (charData.worldBookId && !activeBookIds.includes(charData.worldBookId)) {
                activeBookIds.push(charData.worldBookId);
            }

            if(activeBookIds.length > 0) {
                 const rawWB = await dbGet(DB_WB_KEY);
                 const allBooks = (typeof rawWB === 'string') ? JSON.parse(rawWB) : (rawWB || []);
                 // æ‰¾åˆ°æ‰€æœ‰IDåŒ¹é…çš„ä¹¦ç±å†…å®¹
                 const relBooks = allBooks.filter(b => activeBookIds.includes(b.id));
                 wbContent = relBooks.map(b => `[World Info: ${b.name}]\n${b.content}`).join('\n\n');
            }

            activeCall = {
                charId: contact.id,
                startTime: 0,
                timerInterval: null,
                chatHistory: [], 
                persona: charData.persona || "Default Persona",
                worldBook: wbContent,
                charName: charData.name,
                userNick: charData.userNickName || "User",
                userPersona: charData.userPersona || ""
            };

            // ç¬¬ä¸€å¥Promptï¼Œä¸¥æ ¼éµå®ˆOOCè¦æ±‚
            const systemPrompt = `
[SYSTEM INSTRUCTION]
You are acting as the character "${activeCall.charName}" in a phone call with "${activeCall.userNick}".
Current Date/Time: ${new Date().toLocaleString()}.

[CHARACTER SETTINGS]
Name: ${activeCall.charName}
Persona: ${activeCall.persona}
World Context:
${activeCall.worldBook}

[USER INFO]
Name: ${activeCall.userNick}
Persona: ${activeCall.userPersona}

[CALL RULES]
1. This is a VOICE CALL. Do NOT describe physical actions (like *waves hand*).
2. REQUIRED: Describe sounds in brackets using CHINESE, e.g. (è½»ç¬‘), (æ²‰é»˜), (æ‰“å­—å£°), (èƒŒæ™¯å™ªéŸ³).
3. Dialogue MUST be enclosed in double quotes "".
4. NO OOC (Out Of Character). Stay strictly within the persona.
5. Language: Speak in the character's native language (mostly Chinese).
6. Provide the FIRST SENTENCE to start the call.
            `;

            try {
                // æ¥é€šå‰ç­‰å¾…
                const firstMsg = await callLLM([{role: "system", content: systemPrompt}]);
                
                stopRingtone();
                
                activeCall.startTime = Date.now();
                activeCall.timerInterval = setInterval(updateCallTimer, 1000);
                updateCallTimer();
                
                appendCallMsg(activeCall.charName, firstMsg, 'them');
                activeCall.chatHistory.push({role: "assistant", content: firstMsg});

            } catch(e) {
                console.error(e);
                stopRingtone();
                document.getElementById('callStatus').innerText = "æ¥é€šå¤±è´¥";
                setTimeout(closeCallOverlay, 2000);
            }
        }

        async function handleUserSpeak() {
            const input = document.getElementById('speechInput');
            const text = input.value.trim();
            if(!text || !activeCall) return;

            appendCallMsg("Me", text, 'me');
            activeCall.chatHistory.push({role: "user", content: text});
            input.value = '';

            // æ€è€ƒçŠ¶æ€ UI
            const loadingId = appendCallMsg(activeCall.charName, "å¯¹æ–¹æ­£åœ¨æ€è€ƒ...", 'them', true);

            // æŒç»­å¯¹è¯ Prompt
            const systemPrompt = `
[CONTINUE CALL]
Character: ${activeCall.charName}
Persona: ${activeCall.persona}
World Book: ${activeCall.worldBook}

[STRICT RULES]
1. NO OOC. Strictly follow the character's personality.
2. Output ONLY the dialogue in double quotes "".
3. Describe sounds in brackets () using CHINESE (e.g. (å¹æ°”)).
4. NO physical actions.
            `;

            const messages = [
                {role: "system", content: systemPrompt},
                ...activeCall.chatHistory
            ];

            try {
                const reply = await callLLM(messages);
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
                
                appendCallMsg(activeCall.charName, reply, 'them');
                activeCall.chatHistory.push({role: "assistant", content: reply});
            } catch(e) {
                const loader = document.getElementById(loadingId);
                if(loader) loader.innerText = "(ä¿¡å·ä¸­æ–­)";
            }
        }

        // --- æŒ‚æ–­ä¸è®°å¿†å½’æ¡£ ---
        async function endCall() {
            const savedCharId = activeCall ? activeCall.charId : null; // ã€æ–°å¢ã€‘å…ˆå¤‡ä»½IDï¼Œé˜²æ­¢åé¢activeCallå˜ç©º
            if(!activeCall) { closeCallOverlay(); return; }

            clearInterval(activeCall.timerInterval);
            stopRingtone();

            // è®°å½•åˆ°æœ€è¿‘é€šè¯
            const durationSec = Math.floor((Date.now() - activeCall.startTime) / 1000);
            recents.unshift({
                name: activeCall.charName,
                duration: formatTime(durationSec),
                subDate: new Date().toLocaleString(),
                avatar: document.getElementById('callAvatar').src
            });
            saveData();
            if(currentTab === 'recents') renderRecents();

            // æ˜¾ç¤ºå½’æ¡£å¼¹çª—
            openModal('archivingModal');

            // æ€»ç»“å¹¶ä¿å­˜è®°å¿†
            if(activeCall.chatHistory.length > 1) {
                try {
                    const summaryPrompt = `
ä»»åŠ¡ï¼šæ€»ç»“æœ¬æ¬¡ç”µè¯é€šè¯å†…å®¹ï¼Œä½œä¸ºè§’è‰²çš„é•¿æœŸè®°å¿†ã€‚
è§’è‰²ï¼š${activeCall.charName}
å¯¹è¯å†…å®¹ï¼š
${activeCall.chatHistory.map(m => m.role + ": " + m.content).join('\n')}

è¦æ±‚ï¼š
1. åŒ…å«æ—¶é—´ã€äººç‰©ã€æ ¸å¿ƒäº‹ä»¶ã€‚
2. ç®€æ´ï¼ˆ200å­—ä»¥å†…ï¼‰ã€‚
3. è¯­æ°”å®¢è§‚ã€‚
                    `;
    
                    const summary = await callLLM([
                        {role: "system", content: "You are a memory archiver."},
                        {role: "user", content: summaryPrompt}
                    ]);
    
                    const finalMemory = `[ç”µè¯è®°å¿† ${new Date().toLocaleString()}] ${summary}`;
    
                    // å†™å…¥ QQ æ•°æ®åº“ (char_detail.htmlçš„æ•°æ®æº)
                    const rawQQ = await dbGet(DB_QQ_KEY);
                    const qqData = (typeof rawQQ === 'string') ? JSON.parse(rawQQ) : (rawQQ || []);
                    
                    const targetIdx = qqData.findIndex(q => q.id === savedCharId);
                    if(targetIdx !== -1) {
                        if(!qqData[targetIdx].longTermMemories) qqData[targetIdx].longTermMemories = [];
                        qqData[targetIdx].longTermMemories.push(finalMemory);
                        // å­˜å›æ•°æ®åº“
                        await dbSet(DB_QQ_KEY, JSON.stringify(qqData));
                        phoneChannel.postMessage({ type: 'refresh_list' });
                    }
    
                } catch(e) {
                    console.error("Summary failed", e);
                    showToast("å½’æ¡£å¤±è´¥: " + (e.message || "æœªçŸ¥é”™è¯¯")); 
                }
            }

            setTimeout(() => {
                closeModal('archivingModal');
                closeCallOverlay();
                activeCall = null;
            }, 1500); 
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function stopRingtone() {
            const audio = document.getElementById('ringtoneAudio');
            audio.pause(); audio.currentTime = 0;
        }

        function updateCallTimer() {
            if(!activeCall || !activeCall.startTime) return;
            const diff = Math.floor((Date.now() - activeCall.startTime) / 1000);
            document.getElementById('callTimer').innerText = formatTime(diff);
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function appendCallMsg(name, text, side, isLoading=false) {
            const area = document.getElementById('callChatArea');
            const div = document.createElement('div');
            div.className = `call-msg ${side}`;
            div.innerText = text; 
            if(isLoading) div.id = 'msg-loading-' + Date.now();
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
            return div.id;
        }
        
        function closeCallOverlay() {
            document.getElementById('callOverlay').style.display = 'none';
        }

        function renderRecents() {
            const list = document.getElementById('recentsListEl');
            list.innerHTML = '';
            recents.forEach(r => {
                const div = document.createElement('div');
                div.className = 'recent-item';
                div.innerHTML = `
                    <div class="recent-main">
                        <div class="recent-name">${r.name}</div>
                        <div class="recent-info">
                            <span>ğŸ“² å‘¼å‡º</span>
                            <span>| ${r.duration}</span>
                        </div>
                    </div>
                    <div class="recent-time">${r.subDate.split(' ')[0]}</div>
                `; 
                list.appendChild(div);
            });
        }
        
        function doClearRecents() {
            recents = [];
            saveData();
            renderRecents();
            closeModal('confirmClearModal');
        }

        // --- API è°ƒç”¨ (å¤åˆ» love_star é€»è¾‘) ---
        async function callLLM(messages) {
            // 1. è¯»å–é…ç½®
            let config = await dbGet('qq_ai_config');

            // é˜²å¾¡ï¼šå¦‚æœè¯»å‡ºæ¥æ˜¯å­—ç¬¦ä¸²ï¼ˆæŸäº›æ—§ç‰ˆæ•°æ®çš„æ®‹ç•™ï¼‰ï¼Œå°è¯•è§£æ
            if (config && typeof config === 'string') {
                try { config = JSON.parse(config); } catch(e) {}
            }

            // 2. å…¼å®¹æ—§ç‰ˆé…ç½®
            if (!config) {
                const presetsRaw = await dbGet(API_KEY_STORAGE);
                const currentId = await dbGet(API_ID_STORAGE);
                if (presetsRaw && currentId) {
                    const presets = (typeof presetsRaw === 'string') ? JSON.parse(presetsRaw) : presetsRaw;
                    config = presets.find(p => p.id == currentId);
                }
            }

            if(!config || !config.url || !config.key) {
                document.getElementById('callStatus').innerText = "é…ç½®ç¼ºå¤±";
                throw new Error("No API Config");
            }

            // 3. å¤„ç† URL (å®Œå…¨ç…§æ¬ love_star)
            let cleanUrl = config.url.trim().replace(/\/+$/, '');
            let fetchUrl = '';
            if (cleanUrl.endsWith('/v1')) { fetchUrl = cleanUrl + '/chat/completions'; }
            else if (cleanUrl.endsWith('/chat/completions')) { fetchUrl = cleanUrl; }
            else { fetchUrl = cleanUrl + '/v1/chat/completions'; }

            // 4. è¯·æ±‚ä½“ (å»æ‰äº† max_tokens å’Œ streamï¼Œé˜²æ­¢ api æŠ¥é”™)
            const payload = {
                model: config.model || 'gpt-3.5-turbo',
                messages: messages,
                temperature: Number(config.temperature) || 0.85
            };

            try {
                const res = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    },
                    body: JSON.stringify(payload)
                });

                if(!res.ok) {
                    // è®©é”™è¯¯æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼Œæ–¹ä¾¿ä½ çœ‹
                    document.getElementById('callStatus').innerText = `APIé”™è¯¯: ${res.status}`;
                    throw new Error(`API Error: ${res.status}`);
                }

                const data = await res.json();
                if(!data.choices || data.choices.length === 0) {
                    throw new Error("APIè¿”å›ç©ºå†…å®¹");
                }
                return data.choices[0].message.content;

            } catch(e) {
                console.error(e);
                // å¦‚æœæ˜¯ç½‘ç»œé—®é¢˜ï¼Œç•Œé¢ä¹Ÿä¼šæ˜¾ç¤º
                if(document.getElementById('callStatus').innerText === "æ­£åœ¨æ¥é€š...") {
                    document.getElementById('callStatus').innerText = "è¿æ¥ä¸­æ–­";
                }
                throw e;
            }
        }

        // --- é€šç”¨å¼¹çª—/UIå‡½æ•° ---
        function openModal(id) {
            const el = document.getElementById(id);
            el.style.display = 'flex';
            setTimeout(() => el.classList.add('show'), 10);
        }
        function closeModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('show');
            setTimeout(() => el.style.display = 'none', 300);
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>
</html>
