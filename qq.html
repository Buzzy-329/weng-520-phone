<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QQ Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <style>
        /* --- 基础设置 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background-color: #f2f2f6;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }
        ::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

        /* --- 顶部栏 --- */
        .header {
            height: 90px;
            padding: 45px 20px 10px 20px; 
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
        }
        .header-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: background 0.2s; color: #333;
            z-index: 102;
        }
        .header-btn:active { background: rgba(0,0,0,0.1); }
        .header-right { display: flex; gap: 12px; z-index: 102; }
        
        .header-title-center {
            position: absolute; left: 50%; top: 45px;
            transform: translateX(-50%);
            height: 40px; display: flex; align-items: center;
            font-size: 18px; font-weight: 600; color: #333;
            pointer-events: none;
        }

        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-exit { stroke: #007AFF; }

        /* --- 列表视图 --- */
        .view-list {
            flex: 1; 
            padding-top: 90px;
            padding-bottom: 70px;
            overflow-y: auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .empty-state {
            margin-top: 150px; color: #999; font-size: 14px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .chat-item {
            width: 100%; padding: 16px 20px;
            background: #fff;
            display: flex; align-items: center; gap: 14px;
            border-bottom: 1px solid #f0f0f0; cursor: pointer;
            transition: background 0.2s; position: relative;
        }
        .chat-item:active { background: #f9f9f9; }
        
        .chat-avatar { 
            width: 50px; height: 50px; border-radius: 50%; 
            background: #eee; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .bear-svg-list { width: 70%; height: 70%; fill: #fff; }

        .chat-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .chat-name { font-size: 17px; font-weight: 600; color: #333; margin-bottom: 4px; display: flex; align-items: center; gap:5px; line-height: 1.2;}
        .group-tag { font-size: 10px; background: #007AFF; color: white; padding: 1px 4px; border-radius: 4px; font-weight: normal;}
        .chat-preview { font-size: 14px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; }

        /* --- 底部导航栏 --- */
        .tab-bar {
            height: 60px; width: 100%;
            background: #f9f9f9; border-top: 1px solid #e0e0e0;
            position: fixed; bottom: 0; left: 0; z-index: 100;
            display: flex; align-items: center; justify-content: space-around;
            padding-bottom: 10px;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; color: #999; width: 33.33%; height: 100%; cursor: pointer;
        }
        .tab-item.active { color: #ffb7c5; }
        .tab-icon { width: 28px; height: 28px; stroke-width: 2; }
        .tab-text { font-size: 10px; font-weight: 600; }

        /* --- SVG --- */
        .bear-svg { width: 100%; height: 100%; }

        /* --- 弹窗通用 --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 500;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-card {
            background: rgba(255,255,255,0.98); width: 80%; max-width: 320px;
            border-radius: 24px; padding: 25px;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            animation: popIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn { from{transform:scale(0.85);opacity:0;} to{transform:scale(1);opacity:1;} }
        
        .modal-title { font-size: 18px; font-weight: 600; text-align: center; color: #333; }
        .modal-input {
            width: 100%; padding: 12px; background: #f2f2f6; border: none;
            border-radius: 12px; font-size: 16px; text-align: center; color: #333;
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .m-btn {
            flex: 1; padding: 14px; border-radius: 14px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .m-btn:active { opacity: 0.7; }
        .m-btn.cancel { background: #f2f2f6; color: #888; }
        .m-btn.confirm { background: #333; color: #fff; }
        .m-btn.full-width { width: 100%; }

        /* 菜单 & 列表选择 */
        .menu-option { padding: 16px; background: #fff; border-bottom: 1px solid #eee; text-align: center; cursor: pointer; }
        .menu-option:first-child { border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .menu-option:last-child { border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; border-bottom: none; }
        .group-select-list { max-height: 250px; overflow-y: auto; padding: 5px; }
        .group-select-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: #fff; border-radius: 10px; }
        .group-select-item.selected { background: #eef6ff; }
        .select-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd; }
        .group-select-item.selected .select-check { background: #007AFF; border-color: #007AFF; }

        /* --- 新增：未读红点样式 --- */
        .unread-badge {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            background-color: #FF3B30; color: #fff;
            font-size: 12px; font-weight: 600;
            min-width: 18px; height: 18px; line-height: 18px;
            border-radius: 9px; text-align: center;
            padding: 0 5px; z-index: 5;
            box-shadow: 0 2px 4px rgba(255, 59, 48, 0.2);
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-btn" onclick="exitToHome()">
            <svg class="icon icon-exit" viewBox="0 0 24 24"><path d="M3 12h18M3 12l6-6m-6 6l6 6"/></svg>
        </div>
        <div class="header-title-center">消息</div>
        <div class="header-right">
            <div class="header-btn" onclick="startGroupCreation()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </div>
            <div class="header-btn" onclick="showMenuModal()">
                <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
        </div>
    </div>

    <div class="view-list" id="chatList">
        <div class="empty-state" id="emptyTip">
            <svg class="icon" style="width:48px;height:48px;color:#ddd;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 15h8M9 9h.01M15 9h.01"/></svg>
            <span>还没有角色，去右上角“+”号创建吧</span>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="tab-bar">
        <div class="tab-item active">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <span class="tab-text">聊天</span>
        </div>
        <div class="tab-item" onclick="window.location.href='qq_address.html'">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
            <span class="tab-text">通讯录</span>
        </div>
        <div class="tab-item" onclick="window.location.href='qq_mine.html'">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span class="tab-text">我的</span>
        </div>
    </div>

    <!-- 弹窗：菜单 -->
    <div class="modal-overlay" id="menuModal" onclick="closeModal('menuModal', event)">
        <div class="modal-card">
            <div class="modal-title">添加角色</div>
            <div style="display:flex; flex-direction:column; border-radius:20px; overflow:hidden;">
                <div class="menu-option" onclick="openInputModal('char')">手动创建</div>
                <div class="menu-option" onclick="document.getElementById('fileInput').click()">导入角色卡</div>
            </div>
            <div class="menu-option" style="margin-top:10px; border-radius:14px; color:#FF3B30;" onclick="document.getElementById('menuModal').style.display='none'">取消</div>
        </div>
    </div>

    <!-- 弹窗：输入名称 -->
    <div class="modal-overlay" id="inputModal">
        <div class="modal-card">
            <div class="modal-title" id="inputModalTitle">名称</div>
            <input type="text" class="modal-input" id="nameInput" placeholder="" maxlength="12">
            <div class="modal-btns">
                <button class="m-btn cancel" onclick="document.getElementById('inputModal').style.display='none'">取消</button>
                <button class="m-btn confirm" onclick="confirmCreation()">完成</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：群聊选择 -->
    <div class="modal-overlay" id="groupSelectModal" onclick="closeModal('groupSelectModal', event)">
        <div class="modal-card" style="max-height:400px"><div class="modal-title">发起群聊</div><div class="group-select-list" id="groupSelectList"></div><button class="m-btn confirm full-width" onclick="goToGroupNaming()">下一步</button></div>
    </div>

    <!-- 弹窗：错误提示 -->
    <div class="modal-overlay" id="errorModal">
        <div class="modal-card"><div class="modal-title" style="color:#FF3B30">提示</div><div class="modal-msg" id="errorMsgText"></div><button class="m-btn confirm full-width" onclick="document.getElementById('errorModal').style.display='none'">好的</button></div>
    </div>

    <input type="file" id="fileInput" hidden accept=".json, image/png, .png" onchange="handleFileSelect(this)">

    <script>
        const appChannel = new BroadcastChannel('buzzy_sync_channel');
        let dbPromise;
        function initDB() {
            if (!dbPromise) {
    dbPromise = idb.openDB('QQ_DB_2026', 1, {
        upgrade(db) {
            // 这里只做一件事：如果没有 keyval 表，就建一个
            if (!db.objectStoreNames.contains('keyval')) {
                db.createObjectStore('keyval');
            }
        },
    });
}
            return dbPromise;
        }
        async function dbGet(key) {
            const db = await initDB();
            return await db.get('keyval', key);
        }
        async function dbSet(key, val) {
            const db = await initDB();
            return await db.put('keyval', val, key);
        }
        const DB_KEY = 'qq_app_data_pro_max_final';
        let characters = []; 
        const BEAR_SVG = `<svg viewBox="0 0 100 100" class="bear-svg"><circle cx="50" cy="50" r="50" fill="#f0f0f5"/><circle cx="20" cy="25" r="12" fill="#d1d1d6"/><circle cx="80" cy="25" r="12" fill="#d1d1d6"/><circle cx="50" cy="55" r="35" fill="#e5e5ea"/><circle cx="38" cy="50" r="4" fill="#8e8e93"/><circle cx="62" cy="50" r="4" fill="#8e8e93"/><ellipse cx="50" cy="65" rx="8" ry="6" fill="#fff"/><circle cx="50" cy="63" r="3" fill="#333"/></svg>`;

        let creationMode = 'char';
        let selectedGroupMembers = new Set();

        async function loadData() {
            // 使用新的 dbGet 读取
            const stored = await dbGet(DB_KEY);
            if (stored) { 
                try {
                    // 如果存的是字符串就解析，如果是对象直接用（idb特性）
                    characters = typeof stored === 'string' ? JSON.parse(stored) : stored;
                    renderList();
                } catch(e) { console.error("读取失败", e); }
            }
        }

        async function saveData() { 
            // 1. 保存数据到数据库
            await dbSet(DB_KEY, JSON.stringify(characters)); 
            // 2. 【新增】广播通知：告诉所有其他窗口“列表刷新了”
            appChannel.postMessage({ type: 'refresh_list' });
        }

        function exitToHome() { try { window.parent.closeApp(); } catch(e){} }
        function closeModal(id, e) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }
        
        function goToChat(id) {
            window.parent.openApp(`chat_window.html?id=${id}`);
        }

        function handleFileSelect(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    let newChar;
                    if(file.name.toLowerCase().endsWith('.png')) {
                        newChar = { id: Date.now().toString(), type: 'char', name: file.name.replace('.png', ''), history: [{role: 'system', content: '导入成功', timestamp: Date.now()}] };
                    } else {
                        const json = JSON.parse(e.target.result);
                        newChar = { id: Date.now().toString(), type: 'char', name: json.name || "导入角色", history: [] };
                        if(json.first_mes) newChar.history.push({role: 'assistant', content: json.first_mes, timestamp: Date.now()});
                    }
                    characters.unshift(newChar); 
        await saveData(); // <--- 关键修改：加上 await
        renderList(); 
        document.getElementById('menuModal').style.display = 'none';
    } catch(err) { alert("失败：" + err.message); }
};
            if(file.name.toLowerCase().endsWith('.png')) reader.readAsDataURL(file); else reader.readAsText(file);
            input.value = ''; 
        }

        function showMenuModal() { document.getElementById('menuModal').style.display = 'flex'; }
        function openInputModal(mode) { creationMode = mode; document.getElementById('menuModal').style.display = 'none'; document.getElementById('groupSelectModal').style.display = 'none'; document.getElementById('inputModal').style.display = 'flex'; setTimeout(()=>document.getElementById('nameInput').focus(),100); }
        
        function startGroupCreation() { 
            if(characters.length === 0) { document.getElementById('errorMsgText').innerText = "无角色"; document.getElementById('errorModal').style.display = 'flex'; return; } 
            selectedGroupMembers.clear(); renderGroupSelectList(); document.getElementById('groupSelectModal').style.display = 'flex'; 
        }
        
        function renderGroupSelectList() { 
            const list = document.getElementById('groupSelectList'); list.innerHTML = ''; 
            characters.forEach(char => { 
                if(char.type === 'group') return; 
                let avatarHtml = char.avatar ? `<img src="${char.avatar}" style="width:100%;height:100%;object-fit:cover;">` : BEAR_SVG;
                const item = document.createElement('div'); item.className = 'group-select-item'; 
                item.onclick = () => toggleGroupSelection(item, char.id); 
                item.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div style="width:32px;height:32px;border-radius:50%;background:#ddd;display:flex;justify-content:center;align-items:center;overflow:hidden">${avatarHtml}</div><span style="font-size:14px">${char.name}</span></div><div class="select-check"></div>`; 
                list.appendChild(item); 
            }); 
        }
        
        function toggleGroupSelection(el, id) { if(selectedGroupMembers.has(id)) { selectedGroupMembers.delete(id); el.classList.remove('selected'); } else { selectedGroupMembers.add(id); el.classList.add('selected'); } }
        function goToGroupNaming() { openInputModal('group'); }
        
        // 1. 在 function 后面加上 async
async function confirmCreation() { 
            const name = document.getElementById('nameInput').value.trim(); 
            if(!name) return; 
            
            const newId = Date.now().toString(); 
            let newObj = creationMode === 'char' 
                ? { id: newId, type: 'char', name: name, history: [], thoughtsHistory: [] } 
                : { id: newId, type: 'group', name: name, members: Array.from(selectedGroupMembers), history: [{ role: 'system', content: `"${name}" 创建成功`, timestamp: Date.now() }] }; 
            
            // 先加入内存数组
            characters.unshift(newObj); 
            
            try {
                // 尝试写入数据库
                await saveData(); 
                
                // 成功后：刷新列表、关弹窗、跳转
                renderList(); 
                document.getElementById('inputModal').style.display = 'none'; 
                goToChat(newId); 
            } catch (err) {
                // 如果出错，弹出提示，而不是卡死不动
                alert("保存失败，无法跳转: " + err);
                console.error(err);
            }
        }

        function renderList() { 
            const list = document.getElementById('chatList'); const emptyTip = document.getElementById('emptyTip'); 
            // 清空列表
            Array.from(list.children).forEach(c => { if(c !== emptyTip) c.remove(); }); 
            
            // 如果没角色显示空状态
            if(characters.length === 0) { emptyTip.style.display = 'flex'; return; } 
            emptyTip.style.display = 'none'; 
            
            // 开始遍历角色 (注意：这里只需要这一层循环)
            characters.forEach(char => { 
                const item = document.createElement('div'); item.className = 'chat-item'; 
                
                // 处理最后一条消息
                let lastMsg = '暂无消息'; 
                if (char.history.length > 0) { const m = char.history[char.history.length-1]; lastMsg = m.isRecall ? "撤回了一条消息" : m.content; } 
                
                // 处理群聊标签
                const isGroup = char.type === 'group'; 
                const groupTag = isGroup ? '<span class="group-tag">群聊</span>' : ''; 
                
                // 处理头像
                let avatarContent;
                if(char.avatar) {
                    avatarContent = `<img src="${char.avatar}">`;
                } else {
                    avatarContent = `<div class="bear-svg-list">${BEAR_SVG}</div>`;
                }

                // --- 生成未读红点 HTML ---
                let badgeHtml = '';
                if (char.unread && char.unread > 0) {
                    // 如果超过99条显示99+
                    const countText = char.unread > 99 ? '99+' : char.unread;
                    badgeHtml = `<div class="unread-badge">${countText}</div>`;
                }
                // ------------------------

                // 组装 HTML
                item.innerHTML = `<div class="chat-avatar" style="background:${isGroup?'#A0CFFF':'#E0E0E0'}">${avatarContent}</div><div class="chat-info"><div class="chat-name">${char.name} ${groupTag}</div><div class="chat-preview">${lastMsg}</div></div> ${badgeHtml}`; 
                
                // 点击跳转
                item.onclick = () => goToChat(char.id);
                list.appendChild(item); 
            }); 
        }

        // 监听刷新
        window.addEventListener('message', (e) => {
            if(e.data && e.data.type === 'refresh_list') {
                loadData(); // 收到指令才刷新
            }
        });
        
        // 等待所有资源加载完毕后再读取数据
        // --- 【新增】监听跨窗口同步信号 ---
        appChannel.onmessage = (event) => {
            const data = event.data;
            // 如果收到刷新指令，重新从数据库读取数据
            if (data && data.type === 'refresh_list') {
                loadData();
            }
        };
window.onload = function() {
    loadData();
};
    </script>
</body>
</html>
