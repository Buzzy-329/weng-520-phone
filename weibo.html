<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect Heart - Forum</title>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* æ ¸å¿ƒè¦æ±‚ï¼šå…¨å±€å½»åº•éšè—æ»šåŠ¨æ¡ï¼Œä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
        ::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: linear-gradient(180deg, #fff0f5 0%, #ffe4e1 100%);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            color: #5d5d5d;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- é¡¶éƒ¨å¯¼èˆª --- */
        .nav-bar {
            padding: 50px 24px 20px 24px;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
            background: transparent;
            position: absolute; top: 0; left: 0; right: 0;
            pointer-events: none; /* è®©åº•ä¸‹å†…å®¹ä¸é˜»æŒ¡ï¼Œä½†æŒ‰é’®è¦å¼€å¯ */
        }
        
        .back-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2);
            font-size: 18px; color: #888; 
            transition: transform 0.2s;
            pointer-events: auto;
        }
        .back-btn:active { transform: scale(0.9); }
        
        .page-title {
            font-size: 18px; font-weight: 600; letter-spacing: 0.5px; color: #7a6a6a;
            pointer-events: auto;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50%;
        }
        .right-action { 
            pointer-events: auto; display: flex; gap: 8px; 
        }

        .action-chip {
            padding: 6px 12px; background: rgba(255,255,255,0.7);
            border-radius: 20px; font-size: 12px; font-weight: 600; color: #ffb7b2;
            box-shadow: 0 2px 8px rgba(255,183,178,0.2); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .action-chip:active { transform: scale(0.95); background: #fff; }

        /* --- ä¸»å†…å®¹åŒº --- */
        .content-area {
            flex: 1; padding: 0 24px;
            margin-top: 100px;
            margin-bottom: 70px;
            overflow-y: auto; 
            display: flex; flex-direction: column; gap: 15px;
        }

        /* --- å¡ç‰‡æ ·å¼ --- */
        .card {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 24px; padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(230, 200, 200, 0.2);
            transition: transform 0.1s; cursor: pointer;
            display: flex; flex-direction: column; gap: 8px;
        }
        .card:active { transform: scale(0.98); background: #fff; }

        .card-header { display: flex; align-items: center; gap: 10px; }
        .card-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #eee; }
        .card-user { font-size: 13px; color: #999; font-weight: 600; }
        .card-title { font-size: 16px; font-weight: 700; color: #444; line-height: 1.3; }
        .card-preview { font-size: 13px; color: #777; line-height: 1.5; opacity: 0.8; 
                        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .bear-icon {
            width: 28px; height: 28px; border-radius: 50%; background: #ddd;
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; position: relative;
        }

        /* åŒäººä¸€çº§åˆ†ç±»å¡ç‰‡ */
        .category-card {
            height: 100px; background: linear-gradient(135deg, #fff 0%, #fff0f5 100%);
            border-radius: 24px; display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: #ffb7b2;
            box-shadow: 0 5px 15px rgba(255,183,178,0.2);
            cursor: pointer; transition: transform 0.2s;
        }
        .category-card:active { transform: scale(0.95); }

        /* --- åº•éƒ¨ Tab æ  --- */
        .tab-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 65px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
            z-index: 20; padding-bottom: 10px;
        }
        .tab-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #ccc; font-size: 10px; gap: 4px; cursor: pointer;
        }
        .tab-item.active { color: #ffb7b2; }
        .tab-icon { font-size: 22px; }

        /* --- è¯¦æƒ…é¡µ (å…¨å±è¦†ç›–) --- */
        .full-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fffafa; z-index: 50;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .full-page.show { transform: translateX(0); }
        .detail-body {
            flex: 1; overflow-y: auto; padding: 0 24px; padding-top: 100px; padding-bottom: 80px;
        }
        
        .detail-title { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 15px; line-height: 1.3; }
        .detail-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .detail-content { font-size: 16px; line-height: 1.8; color: #444; white-space: pre-wrap; }
        
        .action-row { display: flex; justify-content: flex-end; gap: 20px; margin-top: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .act-btn { display: flex; align-items: center; gap: 5px; color: #ccc; font-size: 14px; cursor: pointer; }
        .act-btn.liked { color: #ff6b81; }
        .act-btn.collected { color: #f1c40f; }

        .comment-area { margin-top: 20px; }
        .comment-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .cmt-avatar { width: 30px; height: 30px; border-radius: 50%; background: #eee; flex-shrink: 0; }
        .cmt-box { flex: 1; background: #f2f2f2; padding: 8px 12px; border-radius: 12px; font-size: 13px; color: #333; }
        .cmt-user { font-weight: 700; color: #666; font-size: 12px; margin-bottom: 3px; }

        .bottom-input {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 10px 15px; background: #fff;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding-bottom: 20px;
        }
        .input-f { flex: 1; background: #f5f5f5; border: none; padding: 10px 15px; border-radius: 20px; }
        .send-t { color: #ffb7b2; font-weight: 700; font-size: 14px; padding: 5px; cursor: pointer;}

        /* --- ä¸ªäººä¸­å¿ƒ --- */
        .mine-header { position: relative; margin-bottom: 20px; }
        .mine-bg { width: 100%; height: 140px; background: #ddd; border-radius: 16px; object-fit: cover; }
        .mine-avatar { 
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff; 
            background: #fff; position: absolute; left: 20px; bottom: -25px; object-fit: cover;
        }
        .mine-info { margin-left: 100px; padding-top: 5px; }
        .mine-name { font-size: 18px; font-weight: 700; }
        .mine-bio { font-size: 12px; color: #888; margin-top: 4px; }
        .mine-stats { display: flex; gap: 15px; font-size: 12px; color: #666; margin-top: 5px; }

        /* æ–°å¢ï¼šä¸ªäººä¸­å¿ƒå³ä¸Šè§’æ¸…ç©ºæŒ‰é’® */
        .clear-cache-btn {
            position: absolute; top: 10px; right: 15px;
            font-size: 12px; color: #fff; background: rgba(0,0,0,0.3);
            padding: 4px 10px; border-radius: 15px; cursor: pointer; z-index: 5;
        }
        
        /* æ–°å¢ï¼šåˆ é™¤ç¡®è®¤å¼¹çª—çš„æŒ‰é’®æ ·å¼ */
        .del-btn { flex:1; padding:10px; border:none; border-radius:12px; font-weight:bold; }
        .del-cancel { background:#f0f0f0; color:#888; }
        .del-confirm { background:#ff6b81; color:#fff; }
        
        /* --- å¼¹çª—ä¸é®ç½© --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal-mask.show { display: flex; }
        .modal-body {
            background: #fff; width: 85%; max-width: 320px; border-radius: 24px; padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
            max-height: 80vh;
        }
        
        /* ç”Ÿæˆä¸­å¼¹çª—ç‰¹åˆ«æ ·å¼ */
        .loading-modal {
            background: rgba(255,255,255,0.95); width: 160px; height: 160px;
            border-radius: 30px; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,183,178,0.3);
            border-top-color: #ffb7b2; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* è§’è‰²å¤šé€‰åˆ—è¡¨ */
        .role-list { 
            max-height: 300px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 10px; 
            padding-right: 5px;
        }
        .role-item { 
            padding: 10px; border-radius: 12px; background: #f9f9f9; 
            display: flex; align-items: center; gap: 10px; cursor: pointer; 
            border: 2px solid transparent; transition: all 0.2s;
        }
        .role-item.selected { background: #fff0f5; border-color: #ffb7b2; }
        .role-check {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd;
            display: flex; justify-content: center; align-items: center;
            margin-left: auto;
        }
        .role-item.selected .role-check { background: #ffb7b2; border-color: #ffb7b2; }
        .role-check::after { content: 'âœ“'; color: #fff; font-size: 12px; display: none; }
        .role-item.selected .role-check::after { display: block; }

        /* Toast */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: #fff; padding: 12px 20px; border-radius: 20px;
            font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 300;
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="nav-bar">
        <div class="back-btn" onclick="handleBack()">â†</div>
        <div class="page-title" id="pageTitle">åŒäººä¸“åŒº</div>
        <div class="right-action" id="headerAction">
            <!-- åŠ¨æ€æŒ‰é’® -->
        </div>
    </div>

    <!-- å†…å®¹åŒº -->
    <div class="content-area" id="mainContent">
        <!-- åŠ¨æ€æ³¨å…¥ -->
    </div>

    <!-- åŠ è½½ä¸­å¼¹çª— (æ‰€æœ‰APIç”Ÿæˆéƒ½ç”¨è¿™ä¸ª) -->
    <div class="modal-mask" id="loadingModal" style="z-index: 500;">
        <div class="loading-modal">
            <div class="loading-spinner"></div>
            <div style="font-size:14px; color:#999; font-weight:600;">å†…å®¹ç”Ÿæˆä¸­...</div>
        </div>
    </div>

    <!-- åº•éƒ¨ Tab -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('fanfic')">
            <span class="tab-icon">ğŸ“–</span>
            <span>åŒäºº</span>
        </div>
        <div class="tab-item" onclick="switchTab('home')">
            <span class="tab-icon">ğŸ </span>
            <span>ä¸»é¡µ</span>
        </div>
        <div class="tab-item" onclick="switchTab('dm')">
            <span class="tab-icon">ğŸ’¬</span>
            <span>ç§ä¿¡</span>
        </div>
        <div class="tab-item" onclick="switchTab('mine')">
            <span class="tab-icon">ğŸ‘¤</span>
            <span>æˆ‘çš„</span>
        </div>
    </div>

    <!-- æ–‡ç« è¯¦æƒ…é¡µ -->
    <div class="full-page" id="articleView">
        <div class="nav-bar">
            <div class="back-btn" onclick="closeArticle()">â†</div>
            <div class="page-title">å¸–å­è¯¦æƒ…</div>
            <div style="width:40px"></div>
        </div>
        <div class="detail-body">
            <div class="detail-title" id="artTitle">æ ‡é¢˜</div>
            <div class="detail-meta">
                <img src="" class="card-avatar" id="artAvatar">
                <span style="font-size:13px; color:#666;" id="artAuthor">Author</span>
            </div>
            <div class="detail-content" id="artContent">æ­£æ–‡...</div>
            
            <div class="action-row">
                <div class="act-btn" id="btnLike" onclick="toggleLike()">
                    <span style="font-size:18px">â¤</span> <span id="numLike">0</span>
                </div>
                <div class="act-btn" id="btnCollect" onclick="toggleCollect()">
                    <span style="font-size:18px">â˜…</span> <span id="numCollect">0</span>
                </div>
                <div class="act-btn" onclick="openForwardSelect()">
                    <span style="font-size:18px">â†ª</span> è½¬å‘
                </div>
            </div>

            <div class="comment-area" id="commentList">
                <!-- è¯„è®ºåŒº -->
            </div>
        </div>
        <div class="bottom-input">
            <input type="text" class="input-f" id="commentInput" placeholder="å‘æ¡è¯„è®º...">
            <div class="send-t" onclick="sendUserComment()">å‘é€</div>
            <div class="send-t" onclick="generateMoreComments()" style="color:#aaa; font-weight:normal; margin-left:5px;">ç”Ÿæˆè¯„è®º</div>
        </div>
    </div>

    <!-- ç§ä¿¡èŠå¤©é¡µ -->
    <div class="full-page" id="chatView" style="background:#f2f2f2;">
        <div class="nav-bar" style="background:rgba(255,255,255,0.95);">
            <div class="back-btn" onclick="document.getElementById('chatView').classList.remove('show')">â†</div>
            <div class="page-title" id="chatTarget">Name</div>
            <div style="width:40px"></div>
        </div>
        <!-- ä¿®æ­£ï¼špadding-top è°ƒå¤§ï¼Œé˜²æ­¢è¢«é®æŒ¡ -->
        <div class="detail-body" id="chatHistory" style="padding-top:130px; display:flex; flex-direction:column; gap:10px;">
            <!-- æ°”æ³¡ -->
        </div>
        <div class="bottom-input">
            <input type="text" class="input-f" id="dmInput" placeholder="å‘æ¶ˆæ¯...">
            <div class="send-t" onclick="sendDM()">å‘é€</div>
            <div class="send-t" onclick="replyDM()" style="color:#888; margin-left:5px;">å›å¤</div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¤šé€‰è§’è‰² (ç”¨äºç”Ÿæˆ/è½¬å‘) -->
    <div class="modal-mask" id="roleModal">
        <div class="modal-body">
            <div style="text-align:center; font-weight:bold; color:#444;" id="roleModalTitle">é€‰æ‹©è§’è‰²</div>
            <div class="role-list" id="roleListContainer">
                <!-- åˆ—è¡¨ -->
            </div>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <button onclick="closeRoleModal()" style="flex:1; padding:10px; border:none; background:#f0f0f0; color:#888; border-radius:12px;">å–æ¶ˆ</button>
                <button onclick="confirmRoleSelection()" style="flex:1; padding:10px; border:none; background:#ffb7b2; color:#fff; border-radius:12px;">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå‘å¸ƒå¸–å­ -->
    <div class="modal-mask" id="publishModal">
        <div class="modal-body">
            <div style="text-align:center; font-weight:bold;">å‘å¸ƒåŠ¨æ€</div>
            <input type="text" id="pubTitle" class="input-f" style="background:#fff; border:1px solid #eee;" placeholder="æ ‡é¢˜">
            <textarea id="pubContent" class="input-f" style="background:#fff; border:1px solid #eee; height:100px; resize:none;" placeholder="æ­£æ–‡å†…å®¹..."></textarea>
            <!-- æè¿°å›¾ç‰‡ç”»é¢ (å¯é€‰) -->
            <input type="text" id="pubImgDesc" class="input-f" style="background:#fff; border:1px solid #eee;" placeholder="é…å›¾ç”»é¢æè¿° (å¯é€‰)">
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('publishModal').classList.remove('show')" style="flex:1; padding:10px; border:none; background:#f0f0f0; border-radius:12px;">å–æ¶ˆ</button>
                <button onclick="doPublish()" style="flex:1; padding:10px; border:none; background:#ffb7b2; color:#fff; border-radius:12px;">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šåˆ é™¤ç¡®è®¤ -->
    <div class="modal-mask" id="deleteModal">
        <div class="modal-body" style="width:260px;">
            <div style="text-align:center; font-weight:bold; font-size:16px;">æç¤º</div>
            <div style="text-align:center; color:#666; font-size:14px; margin:10px 0;">ç¡®å®šè¦åˆ é™¤è¿™æ¡å†…å®¹å—ï¼Ÿ</div>
            <div style="display:flex; gap:10px;">
                <button class="del-btn del-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="del-btn del-confirm" onclick="confirmDeleteAction()">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">æç¤º</div>

    <script>
        // --- å…¨å±€çŠ¶æ€ ---
        // --- æ ¸å¿ƒï¼šæ•°æ®åº“ä¸é€šä¿¡ ---
        const forumChannel = new BroadcastChannel('buzzy_sync_channel');
        
        let dbPromise;
        function initDB() {
            if (!dbPromise) {
    dbPromise = idb.openDB('QQ_DB_2026', 1, {
        upgrade(db) {
            // è¿™é‡Œåªåšä¸€ä»¶äº‹ï¼šå¦‚æœæ²¡æœ‰ keyval è¡¨ï¼Œå°±å»ºä¸€ä¸ª
            if (!db.objectStoreNames.contains('keyval')) {
                db.createObjectStore('keyval');
            }
        },
    });
}
            return dbPromise;
        }
        async function dbGet(key) {
            const db = await initDB();
            return await db.get('keyval', key);
        }
        async function dbSet(key, val) {
            const db = await initDB();
            return await db.put('keyval', val, key);
        }
        const DB_KEY = 'qq_app_data_pro_max_final';
        const WB_KEY = 'wb_books';
        const SETTING_KEY = 'aiPhone_presets';
        const SETTING_ID_KEY = 'aiPhone_currentId';

        let STATE = {
            currentTab: 'fanfic',
            fanficMode: 'categories', // 'categories' (ä¸€çº§é¡µé¢) æˆ– 'list' (äºŒçº§é¡µé¢)
            currentFanficCat: '', // å½“å‰é€‰ä¸­çš„åŒäººé¢˜æ
            user: {
                name: 'User', bg: '', avatar: '', bio: 'ç­¾å...',
                following: 520, fans: 1314
            },
            data: {
                fanfic: {}, // { 'ABO': [articles], 'æ—¥å¸¸': [] }
                home: [],
                dms: [],
                myPosts: [],
                favs: []
            },
            selectedRoles: [],
            roles: [],
            currArticle: null
        };

        // --- åˆå§‹åŒ– ---
        window.onload = async () => {
            await loadLocalData();
            await loadRoles();
            switchTab('fanfic'); 
        };

        // å¤„ç†å·¦ä¸Šè§’è¿”å›é€»è¾‘
        function handleBack() {
            // å¦‚æœåœ¨åŒäººçš„äºŒçº§é¡µé¢ï¼Œè¿”å›åˆ°ä¸€çº§åˆ†ç±»
            if (STATE.currentTab === 'fanfic' && STATE.fanficMode === 'list') {
                renderFanficCategories();
            } else {
                // é€€å‡ºApp
                if (window.parent && window.parent.closeApp) window.parent.closeApp();
                else history.back();
            }
        }

        function showLoading(show) {
            document.getElementById('loadingModal').className = show ? 'modal-mask show' : 'modal-mask';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        // --- æ•°æ®åŠ è½½ ---
        async function loadLocalData() {
            // ä» QQ_DB_V3 è¯»å–è®ºå›ä¸“å±æ•°æ®
            const parsed = await dbGet('forum_full_data'); 
            if (parsed) {
                // å…¼å®¹æ—§æ•°æ®æ ¼å¼ï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²åˆ™è§£æï¼Œå¦‚æœæ˜¯å¯¹è±¡ç›´æ¥ç”¨ï¼‰
                const dataObj = (typeof parsed === 'string') ? JSON.parse(parsed) : parsed;
                STATE.data = { ...STATE.data, ...dataObj.data };
                STATE.user = { ...STATE.user, ...dataObj.user };
            }
        }
        async function saveData() {
            // å­˜å…¥ QQ_DB_V3
            await dbSet('forum_full_data', {
                data: STATE.data,
                user: STATE.user
            });
        }

        async function loadRoles() {
            // ä» QQ_DB_V3 è¯»å–è§’è‰²åˆ—è¡¨ (åŒ…å«äººè®¾ã€ä¸–ç•Œä¹¦IDç­‰)
            const raw = await dbGet(DB_KEY);
            if (raw) {
                let allChars = [];
                try {
                    allChars = (typeof raw === 'string') ? JSON.parse(raw) : raw;
                } catch(e) {}
                STATE.roles = allChars.filter(r => r.type === 'char');
            } else {
                STATE.roles = [];
            }
        }

        // --- API æ ¸å¿ƒ ---
        async function callAI(systemPrompt, userPrompt) {
            // 1. å°è¯•è¯»å–æ–°çš„ç»Ÿä¸€é…ç½®
            let config = await dbGet('qq_ai_config');
            
            // 2. å¦‚æœæ²¡è¯»åˆ°ï¼Œå°è¯•è¯»å–æ—§çš„é¢„è®¾åˆ—è¡¨ (å…¼å®¹é€»è¾‘)
            if (!config) {
                const presetsRaw = await dbGet(SETTING_KEY); // SETTING_KEY defined at top
                const curId = await dbGet(SETTING_ID_KEY);
                if (presetsRaw && curId) {
                    const presets = (typeof presetsRaw === 'string') ? JSON.parse(presetsRaw) : presetsRaw;
                    config = presets.find(p => p.id == curId);
                }
            }

            if (!config || !config.url || !config.key) {
                showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API");
                return null;
            }

            try {
                let url = config.url.endsWith('/') ? config.url.slice(0,-1) : config.url;
                if(!url.endsWith('/v1')) url += '/v1';

                const res = await fetch(`${url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.key}` },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: config.temperature || 0.8
                    })
                });
                const json = await res.json();
                return json.choices[0].message.content;
            } catch (e) {
                console.error(e);
                showToast("APIè¿æ¥å¤±è´¥");
                return null;
            }
        }

        // --- Tab åˆ‡æ¢ ---
        function switchTab(tab) {
            STATE.currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
            document.querySelector(`.tab-item[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            const content = document.getElementById('mainContent');
            const headerAction = document.getElementById('headerAction');
            const title = document.getElementById('pageTitle');
            content.innerHTML = ''; headerAction.innerHTML = '';
            
            if (tab === 'fanfic') {
                title.innerHTML = 'åŒäººä¸“åŒº';
                // é»˜è®¤æ˜¾ç¤ºåˆ†ç±»åˆ—è¡¨
                renderFanficCategories();
            } else if (tab === 'home') {
                title.innerHTML = `<input id="homeSearch" placeholder="æœç´¢å…³é”®è¯..." style="border:none; background:transparent; font-size:16px; width:120px;">`;
                headerAction.innerHTML = `
                    <div class="action-chip" onclick="searchHome()">ğŸ”</div>
                    <div class="action-chip" onclick="openRoleSelect('home')">é€‰è§’</div>
                    <div class="action-chip" onclick="genHome()">ç”Ÿæˆ</div>
                `;
                renderHomeUI(content);
            } else if (tab === 'dm') {
                title.innerHTML = 'ç§ä¿¡åˆ—è¡¨';
                headerAction.innerHTML = `<div class="action-chip" onclick="genDM()">ç”Ÿæˆç§ä¿¡</div>`;
                renderDMList(content);
            } else if (tab === 'mine') {
                title.innerHTML = 'ä¸ªäººä¸­å¿ƒ';
                renderMineUI(content);
            }
        }

        // --- åŒäººæ¿å— ---
        
        // 1. æ¸²æŸ“ä¸€çº§åˆ†ç±»å¡ç‰‡
        function renderFanficCategories() {
            STATE.fanficMode = 'categories';
            const content = document.getElementById('mainContent');
            document.getElementById('headerAction').innerHTML = ''; // ä¸€çº§é¡µé¢æ²¡æœ‰æŒ‰é’®
            document.getElementById('pageTitle').innerText = 'åŒäººä¸“åŒº';

            const cats = ['æ—¥å¸¸', 'ABO', 'éƒ½å¸‚', 'é’æ˜¥æ–‡å­¦', 'èº«ä½“äº’æ¢'];
            let html = `<div style="display:flex; flex-direction:column; gap:15px;">`;
            cats.forEach(c => {
                html += `<div class="category-card" onclick="openFanficList('${c}')">${c}</div>`;
            });
            html += `</div>`;
            content.innerHTML = html;
        }

        // 2. è¿›å…¥å…·ä½“åˆ†ç±»çš„äºŒçº§åˆ—è¡¨
        function openFanficList(category) {
            STATE.fanficMode = 'list';
            STATE.currentFanficCat = category;
            
            document.getElementById('pageTitle').innerText = category;
            document.getElementById('headerAction').innerHTML = `
                <div class="action-chip" onclick="openRoleSelect('fanfic')">é€‰è§’è‰²</div>
                <div class="action-chip" onclick="genFanfic()">ç”Ÿæˆ</div>
            `;
            
            const content = document.getElementById('mainContent');
            content.innerHTML = `<div id="fanficList" style="display:flex;flex-direction:column;gap:15px;"></div>`;
            
            renderCards('fanficList', STATE.data.fanfic[category] || []);
        }

        async function getWorldBooksContent(role) {
            // ä» QQ_DB_V3 è¯»å–ä¸–ç•Œä¹¦åº“
            let books = await dbGet(WB_KEY);
            if (!books) return "";
            
            // å…¼å®¹å¤„ç†
            books = (typeof books === 'string') ? JSON.parse(books) : books;
            
            if (!role.worldBookIds || role.worldBookIds.length === 0) return "";
            
            // ç­›é€‰å¹¶æå–å†…å®¹
            const contents = books.filter(b => role.worldBookIds.includes(b.id)).map(b => b.content);
            return contents.join('\n\n');
        }

        // æ„å»ºå¤šè§’è‰² Prompt
        async function buildMultiCharPrompt() {
            const promises = STATE.selectedRoles.map(async r => {
                const wb = await getWorldBooksContent(r);
                return `ã€å€™é€‰è§’è‰²ã€‘
                åå­—: ${r.name}
                è§’è‰²äººè®¾: ${r.persona || 'æ— '}
                ç”¨æˆ·(${r.userNickName||'User'})äººè®¾: ${r.userPersona || 'æ— '}
                ä¸–ç•Œä¹¦: ${wb}`;
            });
            const results = await Promise.all(promises);
            return results.join('\n----------------\n');
        }

        async function genFanfic() {
            if (STATE.selectedRoles.length === 0) return showToast("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’é€‰è§’è‰²ï¼");
            
            showLoading(true);

            const charsInfo = await buildMultiCharPrompt();
            const category = STATE.currentFanficCat;

            // ä¸¥æ ¼çš„ Prompt é€»è¾‘
            let strictReq = "";
            if (category === 'æ—¥å¸¸') strictReq = "å¿…é¡»å®Œå…¨è´´åˆè§’è‰²å’Œç”¨æˆ·çš„æ—¥å¸¸ç›¸å¤„ï¼Œæ¸©é¦¨æˆ–å¹³æ·¡ã€‚ç¦æ­¢OOCã€‚";
            else if (category === 'ABO') strictReq = "ã€ç»å¯¹å¼ºåˆ¶ã€‘å¿…é¡»æ˜¯ABOä¸–ç•Œè§‚ï¼å¿…é¡»ç»™ç”¨æˆ·å’Œè§’è‰²åˆ†é…Alpha/Omega/Betaå±æ€§å¹¶æå†™ä¿¡æ¯ç´ ã€‚ä¸¥ç¦åæ”»ã€‚";
            else if (category === 'éƒ½å¸‚') strictReq = "èƒŒæ™¯å¿…é¡»æ˜¯ç°ä»£éƒ½å¸‚ã€‚åŒ…å«èŒåœºã€å®¶åº­ã€çˆ±æƒ…ç­‰å…ƒç´ ã€‚";
            else if (category === 'é’æ˜¥æ–‡å­¦') strictReq = "ã€ç»å¯¹å¼ºåˆ¶ã€‘èƒŒæ™¯å¿…é¡»æ˜¯é«˜ä¸­æ ¡å›­ã€‚ä¸¤äººæ˜¯åŒå­¦ã€‚å¼ºè°ƒé’æ¶©ã€æš—æ‹ã€å°‘å¹´æ„Ÿã€‚";
            else if (category === 'èº«ä½“äº’æ¢') strictReq = "ã€ç»å¯¹å¼ºåˆ¶ã€‘å¿…é¡»åŒ…å«ä¸¤äººèº«ä½“äº’æ¢çš„æƒ…èŠ‚å’Œä¹‹åçš„ç”Ÿæ´»ã€‚";

            // æ ¸å¿ƒä¿®æ­£ï¼šå¼ºè°ƒ CPã€å¹³è¡Œæ—¶ç©ºã€ç¬¬ä¸‰äººç§°
            const prompt = `
            ç”Ÿæˆ4ç¯‡åŒäººè®ºå›æ–‡ç« (JSON Array)ã€‚
            ä¸»é¢˜ï¼š${category}
            
            ä»ä»¥ä¸‹å€™é€‰è§’è‰²ä¸­ï¼Œæ¯ç¯‡æ–‡ç« éšæœºé€‰ä¸€ç»„CPï¼ˆè§’è‰²+ç”¨æˆ·ï¼‰ï¼š
            ${charsInfo}

            ã€å†…å®¹è¦æ±‚ã€‘
            1. è¿™æ˜¯ä¸€ä¸ªç£•CPçš„åŒäººè®ºå›ï¼Œå†…å®¹å¿…é¡»æ˜¯å¹³è¡Œæ—¶ç©ºçš„å°æ•…äº‹ã€‚
            2. ã€è§†è§’ã€‘ï¼šç¬¬ä¸‰äººç§°ä¸Šå¸è§†è§’ã€‚
            3. ã€ä¸»è§’ã€‘ï¼šå¿…é¡»æ˜¯ã€ç”¨æˆ·ã€‘å’Œã€è§’è‰²ã€‘è¿™å¯¹CPã€‚
            4. ${strictReq} (è¿™ä¸€ç‚¹å¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œä¸å¯è·‘é¢˜ï¼)
            
            ã€æ ¼å¼ã€‘
            [{"author":"éšæœºè·¯äººID","title":"æ ‡é¢˜","snippet":"æ‘˜è¦(100å­—)","content":"600-900å­—æ­£æ–‡","likes":100,"collects":20,"comments":[{"user":"è·¯äººA","text":"è¯„è®º"}]}]
            `;
            
            const res = await callAI("ä½ æ˜¯ä¸€ä¸ªåŒäººæ–‡ç”Ÿæˆå™¨ï¼Œåªè¾“å‡ºJSONï¼Œæ— Markdownã€‚", prompt);
            
            showLoading(false);

            if (res) {
                try {
                    const list = JSON.parse(res.replace(/```json/g,'').replace(/```/g,''));
                    if(!STATE.data.fanfic) STATE.data.fanfic = {};
                    STATE.data.fanfic[category] = list; 
                    saveData();
                    // åˆ·æ–°å½“å‰åˆ—è¡¨
                    renderCards('fanficList', list);
                } catch(e){ showToast("ç”Ÿæˆæ ¼å¼é”™è¯¯"); }
            }
        }

        // --- ä¸»é¡µæ¿å— ---
        function renderHomeUI(box) {
            box.innerHTML = `<div id="homeList" style="display:flex;flex-direction:column;gap:15px;"></div>`;
            renderCards('homeList', STATE.data.home || []);
        }

        async function genHome() {
            if (STATE.selectedRoles.length === 0) return showToast("è¯·å…ˆé€‰è§’è‰²");
            
            showLoading(true);
            
            const charsInfo = await buildMultiCharPrompt();
            
            const prompt = `
            ç”Ÿæˆ6ç¯‡è®ºå›å¸–å­(JSON Array)ã€‚
            è¯·ä»ä¸‹é¢çš„ã€å€™é€‰è§’è‰²åˆ—è¡¨ã€‘ä¸­éšæœºé€‰æ‹©è§’è‰²ã€‚
            
            ${charsInfo}

            ã€æ¦‚ç‡åˆ†å¸ƒä¸è§†è§’è¦æ±‚ã€‘(ç”Ÿæˆ6æ¡)ï¼š
            1. 2æ¡ï¼šè·¯äººè§†è§’ï¼Œè®¨è®ºæˆ–å¶é‡ã€è§’è‰²ã€‘ã€‚
            2. 2æ¡ï¼šã€è§’è‰²æœ¬äººã€‘å‘å¸–ã€‚Authorå¿…é¡»æ˜¯è§’è‰²çš„çœŸå(Name)ã€‚ç¬¬ä¸€äººç§°ã€‚å†…å®¹å…³äºç”Ÿæ´»æˆ–ç”¨æˆ·ã€‚
            3. 2æ¡ï¼šçº¯è·¯äººæ°´è´´ã€‚æ±‚åŠ©/åˆ†äº«/åæ§½ï¼Œä¸è§’è‰²å®Œå…¨æ— å…³ï¼Œè¦æœ‰æ´»äººæ„Ÿã€‚

            ã€é‡è¦ã€‘å¿…é¡»ç”Ÿæˆ comments å­—æ®µï¼Œæ ¼å¼ä¸º [{"user":"ç½‘å","text":"è¯„è®ºå†…å®¹"}]ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼
            æ¯ç¯‡å†…å®¹600å­—ä»¥ä¸Šã€‚
            æ ¼å¼ï¼š[{"author":"åå­—","title":"æ ‡é¢˜","snippet":"æ‘˜è¦","content":"æ­£æ–‡","likes":0,"collects":0,"comments":[{"user":"A","text":"B"}]}]
            `;
            const res = await callAI("JSON only.", prompt);
            
            showLoading(false);

            if(res) {
                try {
                    // åªè¦6æ¡ä¸­çš„å‰4æ¡å±•ç¤º
                    const list = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'')).slice(0,4);
                    STATE.data.home = list;
                    saveData();
                    renderHomeUI(document.getElementById('mainContent'));
                } catch(e) { showToast("è§£æå¤±è´¥"); }
            }
        }

        async function searchHome() {
            const kw = document.getElementById('homeSearch').value;
            if(!kw) return;
            showLoading(true);
            const res = await callAI("JSON only", `ç”Ÿæˆ4ç¯‡å…³äº"${kw}"çš„å¸–å­ã€‚JSONæ ¼å¼åŒä¸Šï¼Œå¿…é¡»åŒ…å«commentsæ•°ç»„ã€‚`);
            showLoading(false);
            if(res) {
                try {
                    const list = JSON.parse(res.replace(/```json/g,'').replace(/```/g,''));
                    renderCards('homeList', list);
                } catch(e){}
            }
        }

        // --- æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---
        function renderCards(containerId, list) {
            const box = document.getElementById(containerId);
            box.innerHTML = '';
            if(!list || list.length === 0) {
                box.innerHTML = `<div style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— å†…å®¹</div>`;
                return;
            }
            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                
                // ç‚¹å‡»è¿›å…¥è¯¦æƒ…
                div.onclick = () => openArticle(item); 
                
                // --- æ–°å¢ï¼šå³æ»‘åˆ é™¤æ£€æµ‹ ---
                if (item.isUserPost) {
                    let startX = 0;
                    let startY = 0;
                    div.addEventListener('touchstart', (e) => {
                        startX = e.changedTouches[0].clientX;
                        startY = e.changedTouches[0].clientY;
                    });
                    div.addEventListener('touchend', (e) => {
                        const endX = e.changedTouches[0].clientX;
                        const endY = e.changedTouches[0].clientY;
                        // åˆ¤æ–­ï¼šXè½´å‘å³æ»‘åŠ¨è¶…è¿‡60pxï¼Œä¸”Yè½´åç§»å°äº30pxï¼ˆé˜²è¯¯è§¦ï¼‰
                        if (endX - startX > 60 && Math.abs(endY - startY) < 30) {
                            openDeleteModal(item);
                        }
                    });
                }
                // -----------------------

                const isUser = item.isUserPost;
                const ava = isUser ? STATE.user.avatar : ''; 
                const name = isUser ? STATE.user.name : item.author;
                
                const iconHtml = isUser ? `<div class="bear-icon">ğŸ»</div>` : `<img src="${ava}" class="card-avatar" onerror="this.style.background='#ffb7b2'">`;

                div.innerHTML = `
                    <div class="card-header">${iconHtml} <span class="card-user">${name}</span></div>
                    <div class="card-title">${item.title}</div>
                    <div class="card-preview">${item.snippet || item.content.substring(0,60)}...</div>
                `;
                box.appendChild(div);
            });
        }

        // --- æ–‡ç« è¯¦æƒ… ---
        function openArticle(item) {
            STATE.currArticle = item;
            const v = document.getElementById('articleView');
            document.getElementById('artTitle').innerText = item.title;
            document.getElementById('artAuthor').innerText = item.isUserPost ? STATE.user.name : item.author;
            document.getElementById('artContent').innerText = item.content;
            
            const avaImg = document.getElementById('artAvatar');
            if(item.isUserPost) {
                avaImg.style.display = 'none'; 
            } else {
                avaImg.style.display = 'block';
                avaImg.src = ''; 
            }

            document.getElementById('numLike').innerText = item.likes || 0;
            document.getElementById('numCollect').innerText = item.collects || 0;

            document.getElementById('btnLike').className = item.isLiked ? 'act-btn liked' : 'act-btn';
            document.getElementById('btnCollect').className = isFav(item) ? 'act-btn collected' : 'act-btn';

            // æ¸²æŸ“è¯„è®º (é˜² undefined é€»è¾‘)
            renderComments(item.comments || []);
            v.classList.add('show');
        }
        function closeArticle() {
            document.getElementById('articleView').classList.remove('show');
            if(STATE.currentTab === 'mine') renderMineUI(document.getElementById('mainContent'));
        }

        function renderComments(arr) {
            const box = document.getElementById('commentList');
            box.innerHTML = '';
            arr.forEach(c => {
                // å…¼å®¹æ€§å¤„ç†ï¼Œé˜²æ­¢ API è¿”å›æ ¼å¼ä¸å½“
                const name = c.user || 'è·¯äºº';
                const txt = c.text || c; // å¦‚æœè¿”å›çš„æ˜¯çº¯å­—ç¬¦ä¸²
                
                box.innerHTML += `
                    <div class="comment-row">
                        <div class="cmt-avatar"></div>
                        <div class="cmt-box">
                            <div class="cmt-user">${name}</div>
                            <div>${txt}</div>
                        </div>
                    </div>
                `;
            });
        }

        function toggleLike() {
            if(STATE.currArticle.isUserPost) return;
            STATE.currArticle.isLiked = !STATE.currArticle.isLiked;
            STATE.currArticle.likes = (STATE.currArticle.likes || 0) + (STATE.currArticle.isLiked ? 1 : -1);
            document.getElementById('numLike').innerText = STATE.currArticle.likes;
            document.getElementById('btnLike').className = STATE.currArticle.isLiked ? 'act-btn liked' : 'act-btn';
            saveData();
        }

        function isFav(item) { return STATE.data.favs.some(f => f.title === item.title && f.content === item.content); }
        function toggleCollect() {
            const item = STATE.currArticle;
            const idx = STATE.data.favs.findIndex(f => f.title === item.title && f.content === item.content);
            if(idx >= 0) {
                STATE.data.favs.splice(idx, 1);
                document.getElementById('btnCollect').className = 'act-btn';
            } else {
                STATE.data.favs.push(item);
                document.getElementById('btnCollect').className = 'act-btn collected';
            }
            saveData();
        }

        function sendUserComment() {
            const txt = document.getElementById('commentInput').value;
            if(!txt) return;
            if(!STATE.currArticle.comments) STATE.currArticle.comments = [];
            STATE.currArticle.comments.push({user: STATE.user.name + "(æˆ‘)", text: txt});
            document.getElementById('commentInput').value = '';
            renderComments(STATE.currArticle.comments);
            
            // äº’åŠ¨ç”Ÿæˆ
            showLoading(true);
            callAI("JSON string array of comments", `ç”¨æˆ·è¯„è®ºäº†"${txt}"ã€‚è¯·ç”Ÿæˆ3æ¡è·¯äººå›å¤ï¼Œè¦äº’åŠ¨ï¼Œä¾‹å¦‚"æ¥¼ä¸Š+1"ã€‚æ ¼å¼:["User:Msg"]`).then(res => {
                showLoading(false);
                if(res) {
                    try {
                        const arr = JSON.parse(res.replace(/```json/g,'').replace(/```/g,''));
                        arr.forEach(s => {
                            const p = s.split(/[:ï¼š]/);
                            STATE.currArticle.comments.push({user: p[0]||'è·¯äºº', text: p[1]||s});
                        });
                        renderComments(STATE.currArticle.comments);
                        saveData();
                    } catch(e){}
                }
            });
            saveData();
        }

        async function generateMoreComments() {
            showLoading(true);
            const res = await callAI("JSON array", `ä¸ºè¿™ç¯‡å¸–å­ç”Ÿæˆ5æ¡æ–°è¯„è®ºã€‚éšæœºç½‘åã€‚æ ¼å¼:[{"user":"å","text":"å†…å®¹"}]`);
            showLoading(false);
            if(res) { 
                try {
                    const arr = JSON.parse(res.replace(/```json/g,'').replace(/```/g,''));
                    if(!STATE.currArticle.comments) STATE.currArticle.comments = [];
                    arr.forEach(s => {
                        if(typeof s === 'string') STATE.currArticle.comments.push({user:'è·¯äºº', text:s});
                        else STATE.currArticle.comments.push(s);
                    });
                    renderComments(STATE.currArticle.comments);
                    saveData();
                } catch(e){}
            }
        }

        // --- è½¬å‘é€»è¾‘ (å†™å…¥ chat_history) ---
        function openForwardSelect() {
            openRoleSelect('forward');
        }

        async function doForward() {
            if (STATE.selectedRoles.length === 0) return showToast("è¯·å…ˆé€‰æ‹©è¦è½¬å‘çš„å¯¹è±¡");
            
            const art = STATE.currArticle;
            // 1. è¯»å–æœ€æ–°è§’è‰²æ•°æ®
            let allRolesRaw = await dbGet(DB_KEY);
            let allRoles = [];
            if (allRolesRaw) {
                allRoles = (typeof allRolesRaw === 'string') ? JSON.parse(allRolesRaw) : allRolesRaw;
            }
            
            // 2. éå†é€‰ä¸­çš„è§’è‰²å¹¶æ’å…¥æ¶ˆæ¯
            STATE.selectedRoles.forEach(selected => {
                const targetRole = allRoles.find(r => r.id === selected.id);
                if (targetRole) {
                    if(!targetRole.history) targetRole.history = [];
                    targetRole.history.push({
                        role: 'user',
                        // æ„é€ ç‰¹æ®Šçš„ forward æ¶ˆæ¯ç±»å‹ï¼Œç¡®ä¿ chat_window èƒ½è¯†åˆ«
                        content: `[è½¬å‘å¸–å­]\næ ‡é¢˜: ${art.title}\nä½œè€…: ${art.author}\næ‘˜è¦: ${art.snippet||art.content.substring(0,50)}...`,
                        msgType: 'forward', // å…³é”®ï¼šæ ‡è®°ä¸º forward ç±»å‹
                        type: 'forward',    // å…¼å®¹æ—§å­—æ®µ
                        timestamp: Date.now()
                    });
                    // å¢åŠ æœªè¯»æ•°
                    targetRole.unread = (targetRole.unread || 0) + 1;
                }
            });
            
            // 3. ä¿å­˜å›æ•°æ®åº“
            await dbSet(DB_KEY, JSON.stringify(allRoles));
            
            // 4. ã€å…³é”®ã€‘å¹¿æ’­é€šçŸ¥ï¼šå‘Šè¯‰ chat_window å’Œ qq åˆ—è¡¨åˆ·æ–°
            forumChannel.postMessage({ type: 'refresh_list' });
            // é€šçŸ¥ index æ›´æ–°çº¢ç‚¹
            forumChannel.postMessage({ type: 'refresh_qq_list_request' });

            showToast(`å·²è½¬å‘ç»™ ${STATE.selectedRoles.length} ä½å¥½å‹`);
            closeRoleModal();
        }

        // --- ç§ä¿¡æ¿å— ---
        async function genDM() {
            showLoading(true);
            // é‡ç‚¹ä¿®æ­£ï¼šè¦æ±‚åªç”Ÿæˆå¯¹æ–¹æ¶ˆæ¯
            const prompt = `
            ç”Ÿæˆ5ä¸ªç§ä¿¡å¯¹è¯åˆ—è¡¨ã€‚
            JSONæ ¼å¼: [{"name":"ç½‘å","msgs":[{"sender":"them","text":"ä½ å¥½"}]}]
            ã€é‡è¦ã€‘msgsæ•°ç»„ä¸­åªèƒ½åŒ…å«senderä¸º"them"çš„æ¶ˆæ¯(å³å¯¹æ–¹å‘æ¥çš„)ï¼Œç»å¯¹ä¸è¦ç”Ÿæˆç”¨æˆ·çš„å›å¤(sender:"me")ï¼
            å¯¹è¯é£æ ¼è¦æ—¥å¸¸ï¼ŒçŸ­å¥ä¸ºä¸»ã€‚
            `;
            const res = await callAI("JSON Only. No user messages.", prompt);
            showLoading(false);
            if(res) {
                try {
                    STATE.data.dms = JSON.parse(res.replace(/```json/g,'').replace(/```/g,''));
                    saveData();
                    renderDMList(document.getElementById('mainContent'));
                } catch(e) { showToast("ç”Ÿæˆå¤±è´¥"); }
            }
        }

        function renderDMList(box) {
            box.innerHTML = '';
            if(!STATE.data.dms.length) return box.innerHTML = '<div style="text-align:center;margin-top:20px;color:#ccc">æš‚æ— ç§ä¿¡</div>';
            STATE.data.dms.forEach((dm, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.flexDirection = 'row'; div.style.alignItems = 'center';
                const last = dm.msgs[dm.msgs.length-1].text;
                div.innerHTML = `
                    <div class="card-avatar" style="width:40px;height:40px;"></div>
                    <div style="flex:1">
                        <div style="font-weight:bold;color:#333">${dm.name}</div>
                        <div style="font-size:12px;color:#999;margin-top:2px;">${last}</div>
                    </div>
                `;
                div.onclick = () => openChat(dm);
                box.appendChild(div);
            });
        }

        let currDM = null;
        function openChat(dm) {
            currDM = dm;
            document.getElementById('chatTarget').innerText = dm.name;
            renderChatHistory();
            document.getElementById('chatView').classList.add('show');
        }
        function renderChatHistory() {
            const box = document.getElementById('chatHistory');
            box.innerHTML = '';
            currDM.msgs.forEach(m => {
                const isMe = m.sender === 'me';
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = isMe ? 'flex-end' : 'flex-start';
                row.innerHTML = `<div style="background:${isMe?'#ffb7b2':'#fff'}; color:${isMe?'#fff':'#333'}; padding:8px 12px; border-radius:12px; max-width:75%; font-size:14px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">${m.text}</div>`;
                box.appendChild(row);
            });
            box.scrollTop = box.scrollHeight;
        }
        function sendDM() {
            const t = document.getElementById('dmInput').value;
            if(!t) return;
            currDM.msgs.push({sender:'me', text:t});
            document.getElementById('dmInput').value = '';
            renderChatHistory();
            saveData();
        }
        async function replyDM() {
            const last = currDM.msgs[currDM.msgs.length-1].text;
            showLoading(true);
            const res = await callAI("Text only", `ä½ æ‰®æ¼”${currDM.name}ï¼Œç”¨æˆ·å‘äº†"${last}"ã€‚å›ä¸€å¥ç®€çŸ­çš„å¾®ä¿¡æ¶ˆæ¯ã€‚`);
            showLoading(false);
            if(res) {
                currDM.msgs.push({sender:'them', text:res});
                renderChatHistory();
                saveData();
            }
        }

        // --- æˆ‘çš„æ¿å— ---
        function renderMineUI(box) {
            const p = STATE.user;
            box.innerHTML = `
                <div class="mine-header">
                    <!-- æ–°å¢ï¼šæ¸…ç©ºç¼“å­˜æŒ‰é’® -->
                    <div class="clear-cache-btn" onclick="clearAllCache()">â™» æ¸…ç©ºç¼“å­˜</div>
                    
                    <img src="${p.bg}" class="mine-bg" onclick="editUser('bg')" onerror="this.style.background='#ccc'">
                    <img src="${p.avatar}" class="mine-avatar" onclick="editUser('avatar')" onerror="this.style.background='#fff'">
                    <div class="mine-info">
                        <div class="mine-name" onclick="editUser('name')">${p.name}</div>
                        <div class="mine-bio" onclick="editUser('bio')">${p.bio}</div>
                        <div class="mine-stats">
                            <span><b>${p.following}</b> å…³æ³¨</span>
                            <span><b>${p.fans}</b> ç²‰ä¸</span>
                        </div>
                    </div>
                </div>
                <div style="display:flex; border-bottom:1px solid #eee; margin-bottom:15px;">
    <div id="tab-mine-post" style="flex:1; text-align:center; padding:10px; font-weight:bold; color:#ffb7b2; border-bottom:2px solid #ffb7b2; cursor:pointer;" onclick="switchMineTab('post')">å‘å¸ƒ</div>
    <div id="tab-mine-fav" style="flex:1; text-align:center; padding:10px; color:#999; cursor:pointer;" onclick="switchMineTab('fav')">æ”¶è—</div>
</div>
                <div class="action-chip" style="width:120px; text-align:center; margin:0 auto 20px auto;" onclick="document.getElementById('publishModal').classList.add('show')">+ å‘å¸ƒ</div>
                <div style="font-size:12px;color:#ccc;text-align:center;margin-bottom:5px;">(å‘å¸ƒçš„å¸–å­å¯å³æ»‘åˆ é™¤)</div>
                <div id="myPostList" style="display:flex; flex-direction:column; gap:15px;"></div>
            `;
            renderCards('myPostList', STATE.data.myPosts);
        }

        function switchMineTab(type) {
    const postTab = document.getElementById('tab-mine-post');
    const favTab = document.getElementById('tab-mine-fav');
    
    if (type === 'post') {
        // æ ·å¼åˆ‡æ¢
        postTab.style.color = '#ffb7b2';
        postTab.style.borderBottom = '2px solid #ffb7b2';
        postTab.style.fontWeight = 'bold';
        
        favTab.style.color = '#999';
        favTab.style.borderBottom = 'none';
        favTab.style.fontWeight = 'normal';
        
        // å†…å®¹æ¸²æŸ“
        renderCards('myPostList', STATE.data.myPosts);
    } else {
        // æ ·å¼åˆ‡æ¢
        favTab.style.color = '#ffb7b2';
        favTab.style.borderBottom = '2px solid #ffb7b2';
        favTab.style.fontWeight = 'bold';
        
        postTab.style.color = '#999';
        postTab.style.borderBottom = 'none';
        postTab.style.fontWeight = 'normal';
        
        // å†…å®¹æ¸²æŸ“
        renderCards('myPostList', STATE.data.favs);
    }
}

        function editUser(key) {
            const v = prompt("ä¿®æ”¹(ä»…æ”¯æŒURLæˆ–æ–‡å­—):");
            if(v) { STATE.user[key] = v; saveData(); renderMineUI(document.getElementById('mainContent')); }
        }

        // --- å‘å¸ƒåŠŸèƒ½ ---
        async function doPublish() {
            const t = document.getElementById('pubTitle').value;
            const c = document.getElementById('pubContent').value;
            const imgDesc = document.getElementById('pubImgDesc').value; // å›¾ç‰‡ç”»é¢æè¿°

            if(!t || !c) return showToast("å†™ç‚¹ä»€ä¹ˆå§");

            const newPost = {
                title: t, content: c, author: STATE.user.name, isUserPost: true,
                likes: 0, collects: 0, comments: [], imgDesc: imgDesc
            };

            STATE.data.myPosts.unshift(newPost);
            
            // ä½¿ç”¨å›¾ç‰‡æè¿°ç”Ÿæˆè¯„è®º
            // ä¿®æ­£ï¼šå¦‚æœ imgDesc ä¸ºç©ºï¼ŒPrompt ä¼šç›¸åº”è°ƒæ•´
            const imgPart = imgDesc ? `é…å›¾ç”»é¢æè¿°: "${imgDesc}"ã€‚` : `æ²¡æœ‰é…å›¾ã€‚`;
            const prompt = `ç”¨æˆ·å‘è´´ã€‚æ ‡é¢˜:${t}ã€‚æ­£æ–‡:${c}ã€‚
            ${imgPart}
            è¯·ç”Ÿæˆ4æ¡ç½‘å‹è¯„è®ºã€‚äº’åŠ¨æ€§è¦å¼ºã€‚
            JSON arrayæ ¼å¼ï¼Œä¾‹å¦‚ ["è¯„è®º1", "è¯„è®º2"]ã€‚`;
            
            document.getElementById('publishModal').classList.remove('show');
            
            showLoading(true);
            const res = await callAI("JSON array", prompt);
            showLoading(false);

            if(res) {
                try {
                    const arr = JSON.parse(res.replace(/```json/g,'').replace(/```/g,''));
                    arr.forEach(txt => newPost.comments.push({user:'ç½‘å‹', text:txt}));
                } catch(e){}
            }
            saveData();
            renderMineUI(document.getElementById('mainContent'));
        }

        // --- è§’è‰²å¤šé€‰å¼¹çª—é€»è¾‘ ---
        let roleSelectMode = ''; // 'fanfic' | 'home' | 'forward'
        
        function openRoleSelect(mode) {
            roleSelectMode = mode;
            renderRoleSelectionList();
            document.getElementById('roleModal').classList.add('show');
        }

        function renderRoleSelectionList() {
            const box = document.getElementById('roleListContainer');
            box.innerHTML = '';
            STATE.roles.forEach(r => {
                const isSelected = STATE.selectedRoles.some(sel => sel.id === r.id);
                const div = document.createElement('div');
                div.className = `role-item ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `
                    <img src="${r.avatar||''}" style="width:30px;height:30px;border-radius:50%;background:#eee;object-fit:cover;">
                    <span>${r.name}</span>
                    <div class="role-check"></div>
                `;
                div.onclick = () => toggleRoleSelection(r);
                box.appendChild(div);
            });
        }

        function toggleRoleSelection(role) {
            const idx = STATE.selectedRoles.findIndex(sel => sel.id === role.id);
            if (idx >= 0) {
                STATE.selectedRoles.splice(idx, 1);
            } else {
                STATE.selectedRoles.push(role);
            }
            renderRoleSelectionList();
        }

        function confirmRoleSelection() {
            if (roleSelectMode === 'forward') {
                doForward();
            } else {
                showToast(`å·²é€‰ä¸­ ${STATE.selectedRoles.length} ä¸ªè§’è‰²`);
                closeRoleModal();
            }
        }
        
        function closeRoleModal() { document.getElementById('roleModal').classList.remove('show'); }

    // --- æ–°å¢ï¼šæ¸…ç©ºç¼“å­˜ä¸åˆ é™¤é€»è¾‘ ---
        
        // 1. æ¸…ç©ºé™¤â€œæˆ‘çš„â€ä»¥å¤–çš„æ‰€æœ‰æ•°æ®
        function clearAllCache() {
            if(!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”Ÿæˆçš„åŒäººæ–‡ç« ã€ä¸»é¡µæ¨èå’Œç§ä¿¡è®°å½•å—ï¼Ÿ\n(æ‚¨çš„å‘å¸ƒã€æ”¶è—å’Œäººè®¾å°†ä¿ç•™)")) return;
            
            // æ¸…ç©ºé€»è¾‘
            STATE.data.fanfic = {}; // æ¸…ç©ºåŒäºº
            STATE.data.home = [];   // æ¸…ç©ºä¸»é¡µ
            STATE.data.dms = [];    // æ¸…ç©ºç§ä¿¡
            
            saveData();
            showToast("ç¼“å­˜å·²æ¸…ç†ï¼Œç©ºé—´å·²é‡Šæ”¾");
            // åˆ·æ–°é¡µé¢çŠ¶æ€
            switchTab('mine'); 
        }

        // 2. åˆ é™¤å¸–å­çš„ç›¸å…³å˜é‡å’Œå‡½æ•°
        let itemToDelete = null;

        function openDeleteModal(item) {
            itemToDelete = item;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            itemToDelete = null;
        }

        function confirmDeleteAction() {
            if (!itemToDelete) return;

            // åœ¨æˆ‘çš„å‘å¸ƒé‡Œå¯»æ‰¾å¹¶åˆ é™¤
            const idx = STATE.data.myPosts.indexOf(itemToDelete);
            if (idx > -1) {
                STATE.data.myPosts.splice(idx, 1);
                saveData();
                renderMineUI(document.getElementById('mainContent'));
                showToast("å·²åˆ é™¤");
            }
            closeDeleteModal();
        }
    
    </script>
</body>
</html>
