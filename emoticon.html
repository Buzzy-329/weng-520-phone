<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoticon Panel</title>
    <style>
        * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    outline: none; 
    user-select: none; 
    -webkit-user-select: none; /* æ–°å¢è¿™ä¸€è¡Œï¼Œé€‚é…è‹¹æœå’Œæ‰‹æœºå†…æ ¸ */
}
        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: #fff; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* é¡¶éƒ¨æ“ä½œæ  */
        .top-bar {
            height: 50px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #f0f0f0; background: #fff; z-index: 10;
        }
        .top-btn { font-size: 14px; color: #333; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .top-btn:active { background: #f5f5f5; }
        .top-btn.cancel { color: #999; }
        .top-btn.primary { color: #007AFF; font-weight: 500; }

        /* æœç´¢æ  (é»˜è®¤éšè—) */
        .search-bar-wrap {
            height: 0; overflow: hidden; transition: height 0.2s; background: #f9f9f9; padding: 0 15px;
            display: flex; align-items: center;
        }
        .search-bar-wrap.active { height: 50px; border-bottom: 1px solid #eee; }
        .search-input-box {
            flex: 1; background: #fff; height: 32px; border-radius: 6px; display: flex; align-items: center; padding: 0 10px;
        }
        .search-input { border: none; width: 100%; font-size: 14px; color: #333; }
        .close-search { width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; color: #999; margin-left: 5px; cursor: pointer; }

        /* åˆ†ç±»æ  */
        .category-scroll {
            height: 44px; display: flex; align-items: center; overflow-x: auto; white-space: nowrap;
            padding: 0 10px; border-bottom: 1px solid #f0f0f0; background: #fff;
        }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-item {
            padding: 6px 14px; margin-right: 8px; font-size: 13px; color: #666; border-radius: 15px; background: #f5f5f7;
            position: relative; transition: all 0.2s;
            -webkit-user-select: none; 
    -webkit-touch-callout: none;
    user-select: none;
        }
        .cat-item.active { background: #007AFF; color: #fff; font-weight: 500; }
        .cat-close { 
            position: absolute; top: -5px; right: -5px; width: 16px; height: 16px; background: #FF3B30; color: #fff; 
            border-radius: 50%; font-size: 10px; display: flex; justify-content: center; align-items: center;
            border: 1px solid #fff; display: none; /* é»˜è®¤ä¸æ˜¾ç¤ºï¼Œåªæœ‰åœ¨ç‰¹å®šæ¨¡å¼æˆ–è€…é•¿æŒ‰åæ‰æ˜¾ç¤ºé€»è¾‘å¾…å®šï¼Œè¿™é‡Œç›´æ¥åšæˆç‚¹å‡»Xåˆ é™¤ */
        }
        .cat-item .del-btn {
            display: inline-flex; width: 16px; height: 16px; margin-left: 6px; background: rgba(0,0,0,0.2); 
            border-radius: 50%; justify-content: center; align-items: center; font-size: 10px; vertical-align: middle;
        }

        /* è¡¨æƒ…å†…å®¹åŒº */
        .content-area {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            align-content: start; transition: transform 0.2s;
        }
        /* æœç´¢æ¡†å‡ºç°æ—¶ï¼Œå†…å®¹åŒºç¨å¾®å¾€ä¸‹å‹ä¸€ç‚¹çš„è§†è§‰æ•ˆæœ (å…¶å®ä¸éœ€è¦paddingï¼Œå› ä¸ºSearchæ˜¯ç‹¬ç«‹å ä½çš„) */
        
        .emo-item {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; position: relative; cursor: pointer;
        }
        .emo-item:active { background: #f5f5f5; }
        .emo-img { width: 80%; height: 70%; object-fit: contain; pointer-events: none; }
        .emo-name { font-size: 10px; color: #888; margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        
        /* é€‰æ‹©æ¨¡å¼ç›¸å…³ */
        .select-circle {
            position: absolute; top: 4px; right: 4px; width: 18px; height: 18px; border: 1px solid #ccc; border-radius: 50%; background: rgba(255,255,255,0.8);
            display: none;
        }
        .selecting .select-circle { display: block; }
        .emo-item.selected .select-circle { background: #FF3B30; border-color: #FF3B30; }

        /* åº•éƒ¨é€‰æ‹©æ“ä½œæ  */
        .bottom-action-bar {
            height: 60px; background: #fff; border-top: 1px solid #eee; display: none; align-items: center; justify-content: space-around;
            padding-bottom: 10px; /* é¿å¼€åº•éƒ¨å®‰å…¨åŒº */
        }
        .bottom-action-bar.active { display: flex; }
        .action-icon-btn { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 10px; gap: 4px; }
        .action-svg { width: 24px; height: 24px; }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .modal-card {
            background: #fff; width: 80%; border-radius: 16px; padding: 20px;
            display: flex; flex-direction: column; gap: 15px; max-height: 80vh;
        }
        .modal-title { font-size: 17px; font-weight: 600; text-align: center; }
        .modal-input { width: 100%; padding: 10px; background: #f2f2f6; border: none; border-radius: 8px; font-size: 15px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .m-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 15px; font-weight: 500; cursor: pointer; }
        .m-btn.cancel { background: #f5f5f7; color: #888; }
        .m-btn.confirm { background: #007AFF; color: #fff; }
        
        /* è§’è‰²åˆ—è¡¨å¼¹çª— */
        .char-list { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; max-height: 300px; }
        .char-row { display: flex; align-items: center; padding: 8px; border-radius: 8px; background: #f9f9fc; }
        .char-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 10px; background: #ddd; }
        .char-name { flex: 1; font-size: 14px; color: #333; }
        .char-check { width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; }
        .char-row.selected .char-check { background: #34C759; border-color: #34C759; }

        /* åˆ†ç±»åˆ—è¡¨å¼¹çª— (ç”¨äºç®¡ç†å’Œç§»åŠ¨) */
        .cat-list-modal { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; max-height: 250px; }
        .cat-row-modal { padding: 12px; background: #f5f5f7; border-radius: 8px; text-align: center; color: #333; }
        .cat-row-modal:active { background: #e5e5ea; }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
</head>
<body>

    <!-- é¡¶éƒ¨åŠŸèƒ½æ  -->
    <div class="top-bar">
        <div class="top-btn cancel" onclick="closePanel()">å–æ¶ˆ</div>
        <div style="display:flex; gap:5px;">
            <div class="top-btn" onclick="toggleSearch()">æœç´¢</div>
            <div class="top-btn" onclick="openCatManager()">åˆ†ç±»</div>
            <div class="top-btn" onclick="toggleSelectMode()">é€‰æ‹©</div>
            <div class="top-btn primary" onclick="openImportModal()">å¯¼å…¥</div>
        </div>
    </div>

    <!-- æœç´¢æ¡† -->
    <div class="search-bar-wrap" id="searchBar">
        <div class="search-input-box">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢è¡¨æƒ…åŒ…..." oninput="handleSearch()">
        </div>
        <div class="close-search" onclick="toggleSearch()">Ã—</div>
    </div>

    <!-- åˆ†ç±»Tab -->
    <div class="category-scroll" id="catScroll">
        <!-- JSç”Ÿæˆ -->
    </div>

    <!-- è¡¨æƒ…åˆ—è¡¨ -->
    <div class="content-area" id="emoGrid">
        <!-- JSç”Ÿæˆ -->
    </div>

    <!-- åº•éƒ¨é€‰æ‹©æ“ä½œæ  -->
    <div class="bottom-action-bar" id="selectActionBar">
        <div class="action-icon-btn" onclick="handleSelectAll()">
            <div style="font-size:16px;">â˜‘</div>
            <div>å…¨é€‰</div>
        </div>
        <div class="action-icon-btn" onclick="openMoveModal()">
            <div style="font-size:16px;">âœ</div>
            <div>ç§»åŠ¨</div>
        </div>
        <div class="action-icon-btn" onclick="handleDeleteSelected()">
            <div style="font-size:16px; color:#FF3B30;">ğŸ—‘</div>
            <div style="color:#FF3B30;">åˆ é™¤</div>
        </div>
    </div>

    <!-- 1. åˆ†ç±»ç®¡ç†å¼¹çª— -->
    <div class="modal-overlay" id="catManagerModal">
        <div class="modal-card">
            <div class="modal-title">æ·»åŠ åˆ†ç±»</div>
            <input type="text" class="modal-input" id="newCatName" placeholder="è¾“å…¥åˆ†ç±»åç§°">
            <div class="modal-btns">
                <button class="m-btn cancel" onclick="closeModal('catManagerModal')">å–æ¶ˆ</button>
                <button class="m-btn confirm" onclick="addNewCategory()">æ·»åŠ </button>
            </div>
            <div style="font-size:12px; color:#999; text-align:center; margin-top:5px;">(ç‚¹å‡»é¡¶éƒ¨Tabä¸Šçš„å°å‰å·åˆ é™¤åˆ†ç±»)</div>
        </div>
    </div>

    <!-- 2. å¯¼å…¥å¼¹çª— -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-card">
            <div class="modal-title">å¯¼å…¥è¡¨æƒ…åŒ…</div>
            <div class="modal-btns" style="flex-direction:column;">
                <button class="m-btn confirm" onclick="importFromPaste()">ç²˜è´´æ–‡æœ¬ (URLåˆ—è¡¨)</button>
                <button class="m-btn confirm" onclick="importFromPhoto()">ç…§ç‰‡å›¾åº“ (æ¨¡æ‹Ÿ)</button>
                <button class="m-btn confirm" onclick="document.getElementById('fileInput').click()">æ–‡ä»¶ (.txt/.json)</button>
                <button class="m-btn cancel" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
            <input type="file" id="fileInput" style="display:none" accept=".txt,.json,.docx" onchange="handleFileImport(this)">
        </div>
    </div>

    <!-- 3. ç²˜è´´æ–‡æœ¬è¾“å…¥å¼¹çª— -->
    <div class="modal-overlay" id="pasteInputModal">
        <div class="modal-card">
            <div class="modal-title">ç²˜è´´æ–‡æœ¬</div>
            <textarea class="modal-input" id="pasteArea" rows="5" placeholder="æ ¼å¼ï¼šåç§°URL (ä¸€è¡Œä¸€ä¸ª)"></textarea>
            <div class="modal-btns">
                <button class="m-btn cancel" onclick="closeModal('pasteInputModal')">å–æ¶ˆ</button>
                <button class="m-btn confirm" onclick="processPasteImport()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- 4. ç…§ç‰‡å¯¼å…¥å‘½åå¼¹çª— -->
    <div class="modal-overlay" id="photoNameModal">
        <div class="modal-card">
            <div class="modal-title">è¡¨æƒ…åŒ…å‘½å</div>
            <input type="text" class="modal-input" id="photoNameInput" placeholder="ç»™è¿™ä¸ªè¡¨æƒ…èµ·ä¸ªåå­—">
            <div class="modal-btns">
                <button class="m-btn cancel" onclick="closeModal('photoNameModal')">å–æ¶ˆ</button>
                <button class="m-btn confirm" onclick="confirmPhotoImport()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- 5. ç»‘å®šè§’è‰²å¼¹çª— -->
    <div class="modal-overlay" id="bindCharModal">
        <div class="modal-card">
            <div class="modal-title">ç»‘å®šè§’è‰²</div>
            <div style="font-size:12px; color:#999; text-align:center;">é€‰ä¸­è§’è‰²å°†å¯ä»¥ä½¿ç”¨ "<span id="bindCatName"></span>" ä¸­çš„è¡¨æƒ…åŒ…</div>
            <div class="char-list" id="charListContainer"></div>
            <div class="modal-btns">
                <button class="m-btn cancel" onclick="closeModal('bindCharModal')">å–æ¶ˆ</button>
                <button class="m-btn confirm" onclick="saveCharBinding()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- 6. ç§»åŠ¨åˆ†ç±»å¼¹çª— -->
    <div class="modal-overlay" id="moveCatModal">
        <div class="modal-card">
            <div class="modal-title">ç§»åŠ¨åˆ°...</div>
            <div class="cat-list-modal" id="moveCatList"></div>
            <button class="m-btn cancel full-width" onclick="closeModal('moveCatModal')">å–æ¶ˆ</button>
        </div>
    </div>


    <script>
        let dbPromise;
function initDB() {
    if (!dbPromise) {
        dbPromise = idb.openDB('QQ_DB_2026', 1, {
            upgrade(db) {
                if (!db.objectStoreNames.contains('keyval')) {
                    db.createObjectStore('keyval');
                }
            },
        });
    }
    return dbPromise;
}
async function dbGet(key) {
    const db = await initDB();
    return await db.get('keyval', key);
}
async function dbSet(key, val) {
    const db = await initDB();
    return await db.put('keyval', val, key);
}
        const DB_KEY = 'qq_emoticon_db';
        const CHAR_DB_KEY = 'qq_app_data_pro_max_final';
        
        // æ•°æ®ç»“æ„ç¤ºä¾‹
        let db = {
            categories: [
                { id: 'all', name: 'å…¨éƒ¨', items: [] }, // è™šæ‹Ÿåˆ†ç±»ï¼Œä¸å­˜å‚¨itemsï¼Œå®æ—¶è®¡ç®—
                { id: 'uncategorized', name: 'æœªåˆ†ç±»', items: [] }
            ],
            bindings: {} // charId -> [catId1, catId2]
        };

        let currentCatId = 'all';
        let isSelectMode = false;
        let selectedIndices = new Set(); // å­˜å‚¨å½“å‰åˆ†ç±»ä¸‹è¢«é€‰ä¸­çš„ item index
        let longPressTimer = null;
        let tempPhotoUrl = ''; // æš‚å­˜å›¾ç‰‡å¯¼å…¥çš„URL
        let tempBindCatId = ''; // æš‚å­˜æ­£åœ¨ç»‘å®šçš„åˆ†ç±»ID

        // åˆå§‹åŒ–
        window.onload = async function() {
            await loadData();
            renderCategories();
            renderEmoticons();

            window.addEventListener('message', function(e) {
    if(e.data.action === 'refresh') {
        // å¿…é¡»ç­‰å¾… loadData è¯»å–å®Œï¼Œå†æ‰§è¡Œæ¸²æŸ“
        loadData().then(() => {
            renderCategories(); 
            renderEmoticons();
        });
    }
});
        };

        async function loadData() {
            // è¯»å–æ•°æ®ï¼Œå› ä¸º chat_window è¯»å–æ—¶å‡è®¾å®ƒæ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬å­˜å–éƒ½è¦ä¿æŒå­—ç¬¦ä¸²æ ¼å¼
            let loaded = await dbGet(DB_KEY); 
            
            if (loaded) { 
                // å¦‚æœè¯»å–åˆ°çš„æ˜¯å­—ç¬¦ä¸²ï¼ˆä¸ºäº†å…¼å®¹ chat_windowï¼‰ï¼Œåˆ™è§£æå®ƒ
                if (typeof loaded === 'string') {
                    try { loaded = JSON.parse(loaded); } catch(e) { loaded = null; }
                }
                
                if (loaded) {
                    if (!loaded.categories.find(c => c.id === 'uncategorized')) {
                        loaded.categories.unshift({ id: 'uncategorized', name: 'æœªåˆ†ç±»', items: [] });
                    }
                    db.categories = loaded.categories.filter(c => c.id !== 'all'); 
                    db.bindings = loaded.bindings || {};
                } else {
                    db.categories = [{ id: 'uncategorized', name: 'æœªåˆ†ç±»', items: [] }];
                }
            } else {
                // åˆå§‹åŒ–
                db.categories = [{ id: 'uncategorized', name: 'æœªåˆ†ç±»', items: [] }];
            }
        }

        async function saveData() {
            const toSave = {
                categories: db.categories,
                bindings: db.bindings
            };
            // å¿…é¡»å­˜ä¸ºå­—ç¬¦ä¸²ï¼Œå¦åˆ™ chat_window è¯»å–æ—¶ä¼šæŠ¥é”™
            await dbSet(DB_KEY, JSON.stringify(toSave)); 
        }

        function closePanel() {
            window.parent.postMessage({ action: 'closeEmoticon' }, '*');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ---

        function renderCategories() {
            const container = document.getElementById('catScroll');
            container.innerHTML = '';

            // 1. æ¸²æŸ“ "å…¨éƒ¨"
            const allBtn = createCatEl({ id: 'all', name: 'å…¨éƒ¨' }, false);
            container.appendChild(allBtn);

            // 2. æ¸²æŸ“å…¶ä»–
            db.categories.forEach(cat => {
                const el = createCatEl(cat, true);
                container.appendChild(el);
            });
        }

        function createCatEl(cat, canDelete) {
            const div = document.createElement('div');
            div.className = `cat-item ${currentCatId === cat.id ? 'active' : ''}`;
            div.innerText = cat.name;
            div.oncontextmenu = (e) => { e.preventDefault(); return false; }; 
            div.style.webkitTouchCallout = "none";
            div.style.userSelect = "none"; 

            // ç‚¹å‡»åˆ‡æ¢
            div.onclick = () => {
                currentCatId = cat.id;
                isSelectMode = false;
                renderCategories();
                renderEmoticons();
                toggleSelectMode(false); // åˆ‡æ¢åˆ†ç±»è‡ªåŠ¨é€€å‡ºé€‰æ‹©æ¨¡å¼
            };

            // é•¿æŒ‰ç»‘å®š
            div.ontouchstart = (e) => {
                longPressTimer = setTimeout(() => {
                    openBindCharModal(cat.id, cat.name);
                }, 800);
            };
            div.ontouchmove = () => clearTimeout(longPressTimer);
            div.ontouchend = () => clearTimeout(longPressTimer);

            // åˆ é™¤æŒ‰é’® (æœªåˆ†ç±»ä¸å¯åˆ )
            if (canDelete && cat.id !== 'uncategorized') {
                const del = document.createElement('span');
                del.className = 'del-btn';
                del.innerHTML = 'Ã—';
                del.onclick = (e) => {
                    e.stopPropagation();
                    deleteCategory(cat.id);
                };
                div.appendChild(del);
            }

            return div;
        }

        function getItemsForCurrentCat() {
            if (currentCatId === 'all') {
                // èšåˆæ‰€æœ‰ items
                let all = [];
                db.categories.forEach(c => all = all.concat(c.items));
                return all;
            } else {
                const cat = db.categories.find(c => c.id === currentCatId);
                return cat ? cat.items : [];
            }
        }

        function renderEmoticons() {
            const grid = document.getElementById('emoGrid');
            grid.innerHTML = '';
            
            let items = getItemsForCurrentCat();

            // æœç´¢è¿‡æ»¤
            const searchKw = document.getElementById('searchInput').value.trim();
            if (searchKw) {
                items = items.filter(i => i.name.includes(searchKw));
            }

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `emo-item ${isSelectMode ? 'selecting' : ''} ${selectedIndices.has(index) ? 'selected' : ''}`;
                div.innerHTML = `
                    <img src="${item.url}" class="emo-img" onerror="this.src='https://via.placeholder.com/100x100?text=Error'">
                    <div class="emo-name">${item.name}</div>
                    <div class="select-circle"></div>
                `;

                div.onclick = () => {
                    if (isSelectMode) {
                        if (selectedIndices.has(index)) selectedIndices.delete(index);
                        else selectedIndices.add(index);
                        renderEmoticons(); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
                    } else {
                        // å‘é€è¡¨æƒ…åŒ…
                        window.parent.postMessage({ action: 'sendEmoticon', url: item.url, name: item.name }, '*');
                    }
                };

                grid.appendChild(div);
            });
        }

        // --- åŠŸèƒ½é€»è¾‘ ---

        // æœç´¢
        function toggleSearch() {
            const bar = document.getElementById('searchBar');
            bar.classList.toggle('active');
            if (bar.classList.contains('active')) {
                document.getElementById('searchInput').focus();
            } else {
                document.getElementById('searchInput').value = '';
                renderEmoticons();
            }
        }
        function handleSearch() {
            renderEmoticons();
        }

        // åˆ†ç±»ç®¡ç†
        function openCatManager() {
            document.getElementById('newCatName').value = '';
            document.getElementById('catManagerModal').style.display = 'flex';
        }
        function addNewCategory() {
            const name = document.getElementById('newCatName').value.trim();
            if (name) {
                const id = 'cat_' + Date.now();
                db.categories.push({ id: id, name: name, items: [] });
                saveData();
                renderCategories();
            }
            closeModal('catManagerModal');
        }
        function deleteCategory(catId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»å—ï¼Ÿåˆ†ç±»å†…çš„è¡¨æƒ…åŒ…å°†ç§»è‡³â€œæœªåˆ†ç±»â€ã€‚')) return;
            
            const catIndex = db.categories.findIndex(c => c.id === catId);
            if (catIndex > -1) {
                const itemsToMove = db.categories[catIndex].items;
                const uncat = db.categories.find(c => c.id === 'uncategorized');
                if (uncat) {
                    uncat.items = uncat.items.concat(itemsToMove);
                }
                db.categories.splice(catIndex, 1);
                
                if (currentCatId === catId) currentCatId = 'all';
                saveData();
                renderCategories();
                renderEmoticons();
            }
        }

        // ç»‘å®šè§’è‰²é€»è¾‘
        async function openBindCharModal(catId, catName) {
            if (catId === 'all') return; // â€œå…¨éƒ¨â€ä¸èƒ½ç»‘å®š
            tempBindCatId = catId;
            document.getElementById('bindCatName').innerText = catName;
            
            // è¯»å–çˆ¶çº§ localStorage çš„è§’è‰²æ•°æ®
            const rawChars = await dbGet(CHAR_DB_KEY);
            const chars = rawChars ? JSON.parse(rawChars) : [];
            const container = document.getElementById('charListContainer');
            container.innerHTML = '';

            chars.forEach(char => {
                const row = document.createElement('div');
                // æ£€æŸ¥æ˜¯å¦å·²ç»‘å®š
                const boundCats = db.bindings[char.id] || [];
                const isBound = boundCats.includes(catId);
                
                row.className = `char-row ${isBound ? 'selected' : ''}`;
                row.innerHTML = `
                    <img src="${char.avatar}" class="char-avatar">
                    <div class="char-name">${char.name} <span style="color:#999;font-size:12px;">(${char.userNickName || 'æ— å¤‡æ³¨'})</span></div>
                    <div class="char-check"></div>
                `;
                
                row.onclick = () => {
                    row.classList.toggle('selected');
                };
                
                // é™„åŠ æ•°æ®æ–¹ä¾¿ä¿å­˜æ—¶è¯»å–
                row.dataset.charId = char.id;
                container.appendChild(row);
            });

            document.getElementById('bindCharModal').style.display = 'flex';
        }

        function saveCharBinding() {
            const rows = document.querySelectorAll('.char-row');
            rows.forEach(row => {
                const charId = row.dataset.charId;
                const isSelected = row.classList.contains('selected');
                
                if (!db.bindings[charId]) db.bindings[charId] = [];
                
                if (isSelected) {
                    if (!db.bindings[charId].includes(tempBindCatId)) {
                        db.bindings[charId].push(tempBindCatId);
                    }
                } else {
                    db.bindings[charId] = db.bindings[charId].filter(id => id !== tempBindCatId);
                }
            });
            saveData();
            closeModal('bindCharModal');
        }

        // é€‰æ‹©æ¨¡å¼é€»è¾‘
        function toggleSelectMode(forceState) {
            if (typeof forceState !== 'undefined') isSelectMode = forceState;
            else isSelectMode = !isSelectMode;

            selectedIndices.clear();
            const bar = document.getElementById('selectActionBar');
            
            if (isSelectMode) {
                bar.classList.add('active');
            } else {
                bar.classList.remove('active');
            }
            renderEmoticons();
        }
        
        function handleSelectAll() {
            const items = getItemsForCurrentCat();
            if (selectedIndices.size === items.length) {
                selectedIndices.clear();
            } else {
                items.forEach((_, idx) => selectedIndices.add(idx));
            }
            renderEmoticons();
        }

        function handleDeleteSelected() {
            if (selectedIndices.size === 0) return;
            if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­è¡¨æƒ…åŒ…ï¼Ÿ')) return;

            const items = getItemsForCurrentCat(); // å½“å‰è§†å›¾çš„items
            // æ³¨æ„ï¼šå¦‚æœæ˜¯ 'all' è§†å›¾ï¼Œåˆ é™¤æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºéœ€è¦çŸ¥é“åŸ item å±äºå“ªä¸ªåˆ†ç±»
            // ç®€å•å¤„ç†ï¼šå¦‚æœæ˜¯ 'all'ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¸²æŸ“ items æ—¶è®°å½•å®ƒæ‰€å±çš„åˆ†ç±»IDå’Œè¯¥åˆ†ç±»ä¸‹çš„index
            // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªå®ç°ï¼šé 'all' æ¨¡å¼ä¸‹çš„åˆ é™¤ã€‚å¦‚æœæ˜¯ 'all' æ¨¡å¼ï¼Œæç¤ºç”¨æˆ·å»å…·ä½“åˆ†ç±»åˆ é™¤ã€‚
            
            if (currentCatId === 'all') {
                alert('è¯·è¿›å…¥å…·ä½“åˆ†ç±»ï¼ˆå¦‚â€œæœªåˆ†ç±»â€ï¼‰è¿›è¡Œæ‰¹é‡åˆ é™¤æ“ä½œã€‚');
                return;
            }

            const cat = db.categories.find(c => c.id === currentCatId);
            // å€’åºåˆ é™¤é˜²æ­¢ç´¢å¼•é”™ä½
            const sortedIndices = Array.from(selectedIndices).sort((a, b) => b - a);
            sortedIndices.forEach(idx => {
                cat.items.splice(idx, 1);
            });

            selectedIndices.clear();
            saveData();
            renderEmoticons();
        }

        function openMoveModal() {
            if (selectedIndices.size === 0) return;
            if (currentCatId === 'all') {
                 alert('è¯·è¿›å…¥å…·ä½“åˆ†ç±»è¿›è¡Œæ‰¹é‡ç§»åŠ¨æ“ä½œã€‚');
                 return;
            }

            const list = document.getElementById('moveCatList');
            list.innerHTML = '';
            
            // æ˜¾ç¤ºé™¤äº† 'all' ä»¥å¤–çš„æ‰€æœ‰åˆ†ç±»
            db.categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'cat-row-modal';
                div.innerText = cat.name;
                div.onclick = () => moveSelectedTo(cat.id);
                list.appendChild(div);
            });
            
            document.getElementById('moveCatModal').style.display = 'flex';
        }

        function moveSelectedTo(targetCatId) {
            const sourceCat = db.categories.find(c => c.id === currentCatId);
            const targetCat = db.categories.find(c => c.id === targetCatId);
            
            const sortedIndices = Array.from(selectedIndices).sort((a, b) => b - a);
            sortedIndices.forEach(idx => {
                const item = sourceCat.items[idx];
                targetCat.items.push(item); // ç§»åŠ¨
                sourceCat.items.splice(idx, 1); // åˆ é™¤æº
            });
            
            selectedIndices.clear();
            saveData();
            closeModal('moveCatModal');
            renderEmoticons();
        }


        // --- å¯¼å…¥é€»è¾‘ ---
        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function importFromPaste() {
            closeModal('importModal');
            document.getElementById('pasteArea').value = '';
            document.getElementById('pasteInputModal').style.display = 'flex';
        }
        
        function processPasteImport() {
            const text = document.getElementById('pasteArea').value;
            const lines = text.split('\n');
            let count = 0;
            const uncat = db.categories.find(c => c.id === 'uncategorized');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                // ç®€å•å°è¯•åˆ†ç¦» URL (å‡è®¾ http å¼€å¤´)
                const urlIdx = line.indexOf('http');
                if (urlIdx !== -1) {
                    const name = line.substring(0, urlIdx).trim() || 'æœªå‘½å';
                    const url = line.substring(urlIdx).trim();
                    uncat.items.push({ name: name, url: url });
                    count++;
                }
            });
            
            if (count > 0) {
                saveData();
                renderEmoticons();
                alert(`å·²å¯¼å…¥ ${count} ä¸ªè¡¨æƒ…åˆ°â€œæœªåˆ†ç±»â€`);
            }
            closeModal('pasteInputModal');
        }

        function importFromPhoto() {
            closeModal('importModal');
            // æ¨¡æ‹Ÿç›¸å†Œé€‰æ‹©ï¼Œè¿™é‡Œç”¨éšæœºå›¾ä»£æ›¿ï¼Œå®é™…ä¸­æ— æ³•ç›´æ¥è®¿é—®æ‰‹æœºç›¸å†Œé™¤é input type=file
            // è¿™é‡Œä¸ºäº†æ¼”ç¤ºæµç¨‹ï¼Œæˆ‘ä»¬å¼¹å‡ºä¸€ä¸ª input type=fileï¼Œä½†å®é™…ä¸Šæ˜¯è®©ç”¨æˆ·ä¼ å›¾ç‰‡
            // ä¸ºäº†ç¬¦åˆä½ çš„æè¿° "ç…§ç‰‡å›¾åº“ -> å¼¹çª—è¾“å…¥åå­—"ï¼Œæˆ‘ä»¬å…ˆè®©ç”¨æˆ·é€‰å›¾
            document.getElementById('fileInput').click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            // å¦‚æœæ˜¯æ–‡ä»¶ (json/txt)
            if (file.name.endsWith('.json') || file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // ç®€å•çš„å°è¯•è§£æ
                    try {
                        // å‡è®¾æ˜¯ JSON æ•°ç»„ [{name, url}]
                        const list = JSON.parse(e.target.result);
                        const uncat = db.categories.find(c => c.id === 'uncategorized');
                        if (Array.isArray(list)) {
                            list.forEach(i => { if(i.url) uncat.items.push(i); });
                            saveData(); renderEmoticons();
                            alert('å¯¼å…¥æˆåŠŸ');
                        }
                    } catch(err) {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsText(file);
                closeModal('importModal');
                return;
            }

            // å¦‚æœæ˜¯å›¾ç‰‡ (blob)
            const reader = new FileReader();
            reader.onload = (e) => {
                tempPhotoUrl = e.target.result; // Base64ï¼Œå¯èƒ½å¾ˆå¤§
                // å¼¹å‡ºå‘½åæ¡†
                document.getElementById('photoNameInput').value = '';
                closeModal('importModal'); // ç¡®ä¿å…³é—­
                document.getElementById('photoNameModal').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        function confirmPhotoImport() {
            const name = document.getElementById('photoNameInput').value.trim() || 'å›¾ç‰‡è¡¨æƒ…';
            const uncat = db.categories.find(c => c.id === 'uncategorized');
            uncat.items.push({ name: name, url: tempPhotoUrl });
            saveData();
            renderEmoticons();
            closeModal('photoNameModal');
        }

    </script>
</body>
</html>
