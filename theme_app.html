<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Theme Manager</title>
    <style>
        /* --- 1. åŸºç¡€é£æ ¼ (å¤ç”¨å­—ä½“App) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; 
            width: 100%; /* ä¿®æ”¹ï¼š100%é˜²æ­¢æº¢å‡º */
            height: 100vh;
            background: linear-gradient(180deg, #fff0f5 0%, #ffeef2 100%);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            color: #5d5d5d;
            display: flex; flex-direction: column;
            overflow: hidden; 
            overflow-x: hidden; /* æ–°å¢ï¼šç¦æ­¢æ¨ªå‘æ»šåŠ¨ */
            position: relative;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆª --- */
        .nav-bar {
            padding: 50px 24px 20px 24px; /* é¡¶éƒ¨ç•™ç™½é˜²æ­¢é®æŒ¡ */
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10; flex-shrink: 0;
        }
        .back-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2);
            font-size: 18px; color: #888; transition: transform 0.2s;
        }
        .back-btn:active { transform: scale(0.9); }
        
        /* å³ä¸Šè§’ä¿å­˜æŒ‰é’® */
        .save-btn-top {
            padding: 8px 16px; background: #ffb7c5; color: #fff;
            border-radius: 20px; font-size: 14px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.4); cursor: pointer;
            transition: transform 0.2s;
        }
        .save-btn-top:active { transform: scale(0.95); }

        .page-title { font-size: 18px; font-weight: 600; color: #7a6a6a; letter-spacing: 0.5px; }

        /* --- 3. å†…å®¹åŒºåŸŸ --- */
        .content-area {
            flex: 1; padding: 10px 24px 40px 24px;
            display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto; scrollbar-width: none;
            width: 100%; /* ç¡®ä¿å†…å®¹ä¸è¶…è¿‡çˆ¶å®¹å™¨ */
        }
        .content-area::-webkit-scrollbar { display: none; }

        /* é€šç”¨ç™½æ¡† */
        .white-box {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(255, 182, 193, 0.15), 0 4px 10px rgba(255, 255, 255, 0.5);
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .section-title {
            font-size: 14px; color: #aaa; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- å£çº¸è®¾ç½® --- */
        .wallpaper-row {
            display: flex; align-items: center; gap: 10px; /* ç¨å¾®å‡å°é—´è·ä»¥é€‚åº”å°å± */
            width: 100%; /* ç¡®ä¿è¡Œå®½é“ºæ»¡ */
        }
        .wp-preview {
            width: 60px; height: 100px; border-radius: 8px; background: #f0f0f0;
            background-size: cover; background-position: center;
            border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative; flex-shrink: 0;
        }
        .wp-preview.disabled::after {
            content: "OFF"; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); color: #fff; font-size: 12px;
            display: flex; justify-content: center; align-items: center; border-radius: 6px;
        }
        
        /* å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  min-width:0 é˜²æ­¢è¢«æ’‘å¼€ */
        .wp-controls { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            min-width: 0; 
        }
        
        .input-group { display: flex; gap: 8px; width: 100%; }
        
        /* å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  min-width:0 */
        .text-input {
            flex: 1; padding: 8px 12px; border-radius: 12px; border: 1px solid #ffeef2;
            background: #fffbfd; font-size: 13px; color: #666;
            min-width: 0; 
        }
        .file-label {
            padding: 8px 12px; background: #ffeef2; color: #ff8fa3;
            border-radius: 12px; font-size: 12px; font-weight: 600; cursor: pointer;
            white-space: nowrap; display: flex; align-items: center;
            flex-shrink: 0; /* é˜²æ­¢ä¸Šä¼ æŒ‰é’®æ–‡å­—æ¢è¡Œ */
        }
        
        /* å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  flex-shrink:0 */
        .icon-cross {
            width: 30px; height: 30px; background: #ffeded; color: #ff6b6b;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-weight: bold; font-size: 16px; border: none;
            flex-shrink: 0; 
            margin-left: 5px;
        }

        /* --- é”å±è¯¦æƒ… --- */
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 0;
        }
        .setting-label { font-size: 14px; color: #555; font-weight: 500; }
        .setting-desc { font-size: 12px; color: #999; margin-top: 4px; }
        
        .radio-group { display: flex; background: #ffeef2; border-radius: 10px; padding: 3px; }
        .radio-opt {
            padding: 6px 12px; font-size: 12px; border-radius: 8px; cursor: pointer;
            color: #888; transition: all 0.2s;
        }
        .radio-opt.active { background: #fff; color: #ffb7c5; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* --- App å›¾æ ‡ --- */
        .app-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
        }
        .app-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer;
        }
        .app-icon-display {
            width: 50px; height: 50px; border-radius: 12px; background: #eee;
            background-size: cover; background-position: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s;
            position: relative;
        }
        .app-item:active .app-icon-display { transform: scale(0.9); }
        .app-name { font-size: 11px; color: #888; text-align: center; }

        /* --- é¢„è®¾ä¸å¤–æ¡† --- */
        .preset-row {
            display: flex; gap: 10px; align-items: center;
        }
        .preset-select {
            flex: 1; padding: 12px; background: #fff8fa; border: 1px solid #ffeef2;
            border-radius: 14px; font-size: 14px; color: #555; display: flex; justify-content: space-between;
        }
        .btn-mini {
            width: 40px; height: 40px; border-radius: 12px; border: none;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }
        .btn-mini.save { background: #fff0f5; color: #ffb7c5; }
        .btn-mini.del { background: #fff5f5; color: #ff8888; }

        /* å¼€å…³ Switch */
        .toggle-switch {
            width: 50px; height: 28px; background: #eee; border-radius: 30px;
            position: relative; cursor: pointer; transition: 0.3s;
        }
        .toggle-switch.active { background: #ffb7c5; }
        .toggle-switch::after {
            content: ''; position: absolute; left: 2px; top: 2px;
            width: 24px; height: 24px; background: #fff; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after { transform: translateX(22px); }

        /* --- å¼¹çª— (å¤ç”¨) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 300px; background: #fff; border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 40px rgba(255, 182, 193, 0.4);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-title { font-size: 16px; font-weight: 700; color: #444; text-align: center; margin-bottom: 5px; }
        .modal-btns { display: flex; gap: 12px; margin-top: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 14px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #f2f2f2; color: #888; }
        .btn-confirm { background: #ffb7c5; color: #fff; box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3); }

        .preset-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .preset-item { padding: 12px; background: #f9f9f9; border-radius: 10px; font-size: 14px; cursor: pointer; }
        .preset-item.active { background: #fff0f5; color: #ffb7c5; font-weight: bold; }
        
        /* Toast */
        .toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%) scale(0.9); opacity: 0;
            background: rgba(255,255,255,0.95); padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 5px 20px rgba(255, 182, 193, 0.3); font-size: 13px; color: #555;
            transition: all 0.3s; z-index: 2000; pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) scale(1); opacity: 1; }

        /* æ–°å¢ï¼šé‡ç½®æŒ‰é’®æ ·å¼ */
        .btn-reset-block {
            background: #fff5f5; color: #ff6b6b; font-weight: 600;
            border-radius: 16px; padding: 15px; text-align: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.1);
            border: 1px solid #ffecec; transition: 0.2s;
        }
        .btn-reset-block:active { background: #ffe0e0; transform: scale(0.98); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
</head>
<body>

    <div class="nav-bar">
        <div class="back-btn" onclick="closeApp()">â†</div>
        <div class="page-title">ä¸»é¢˜ç¾åŒ–</div>
        <!-- å³ä¸Šè§’ï¼šåº”ç”¨/ä¿å­˜åˆ°æ‰‹æœº -->
        <div class="save-btn-top" onclick="applyToPhone()">ä¿å­˜åº”ç”¨</div>
    </div>

    <div class="content-area">
        
        <!-- 1. å£çº¸è®¾ç½® -->
        <div class="white-box">
            <div class="section-title">Wallpapers</div>
            
            <!-- æ¡Œé¢å£çº¸ -->
            <div class="wallpaper-row">
                <div class="wp-preview" id="previewHome" style="background-image: url('')"></div>
                <div class="wp-controls">
                    <div style="font-size:13px; font-weight:600;">æ¡Œé¢å£çº¸</div>
                    <div class="input-group">
                        <input type="text" class="text-input" id="inputHomeUrl" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥..." onchange="updatePreview('Home', this.value)">
                        <label class="file-label">
                            ä¸Šä¼ 
                            <input type="file" hidden accept="image/*" onchange="handleFile(this, 'Home')">
                        </label>
                    </div>
                </div>
            </div>

            <div style="height:1px; background:#ffeef2; margin: 5px 0;"></div>

            <!-- é”å±å£çº¸ -->
            <div class="wallpaper-row">
                <div class="wp-preview" id="previewLock"></div>
                <div class="wp-controls">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:13px; font-weight:600;">é”å±å£çº¸</span>
                    </div>
                    <div class="input-group">
                        <input type="text" class="text-input" id="inputLockUrl" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥..." onchange="updatePreview('Lock', this.value)">
                        <label class="file-label">
                            ä¸Šä¼ 
                            <input type="file" hidden accept="image/*" onchange="handleFile(this, 'Lock')">
                        </label>
                    </div>
                </div>
                <!-- ç¦ç”¨é”å±æŒ‰é’® -->
                <button class="icon-cross" onclick="toggleLockScreen()">Ã—</button>
            </div>
        </div>

        <!-- 2. é”å±è¯¦ç»†è®¾ç½® -->
        <div class="white-box" id="lockSettingsBox">
            <div class="section-title">Lock Screen Info</div>
            
            <div class="setting-item">
                <span class="setting-label">å¯†ç ä½æ•°</span>
                <div class="radio-group">
                    <div class="radio-opt active" id="pwd4" onclick="setPwdLen(4)">4ä½</div>
                    <div class="radio-opt" id="pwd6" onclick="setPwdLen(6)">6ä½</div>
                </div>
            </div>
            
            <div class="setting-item">
                <span class="setting-label">é”å±å¯†ç </span>
                <input type="number" id="inputPwd" class="text-input" style="width: 100px; text-align:center; flex:none;" placeholder="1234">
            </div>

            <div class="setting-item">
        <span class="setting-label">æ–‡å­—é¢œè‰²</span>
        <div style="display:flex; align-items:center; gap:8px;">
            <!-- é¢œè‰²é€‰æ‹©å™¨ -->
            <input type="color" id="inputLockColorPicker" style="width:30px; height:30px; padding:0; border:none; background:none; cursor:pointer;" onchange="updateLockColor(this.value)">
            <!-- é¢œè‰²ä»£ç è¾“å…¥æ¡† -->
            <input type="text" id="inputLockColorText" class="text-input" style="width:80px; text-align:center; padding:4px;" placeholder="#ffffff" onchange="updateLockColor(this.value)">
        </div>
    </div>

            <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
                <span class="setting-label">ä¸ªæ€§åŒ–æ–‡æ¡ˆ</span>
                <div class="setting-desc">è¾“å…¥åå­—ï¼Œè‡ªåŠ¨ç”Ÿæˆ "xxx of Buzzy Phone"</div>
                <div style="display: flex; align-items: center; width: 100%; margin-top: 8px; gap: 5px;">
                    <input type="text" id="inputText" class="text-input" placeholder="è¯·è¾“å…¥æ˜µç§°">
                    <!-- é¢„è§ˆåç¼€ -->
                    <span style="font-size: 13px; color: #aaa; flex-shrink: 0; transform: translateY(1px);">of Buzzy Phone</span>
                </div>
                <div class="setting-desc" style="color:#ffb7c5; margin-top:4px;">* æ˜¾ç¤ºåœ¨æ—¥æœŸå·¦ä¸‹æ–¹</div>
            </div>
        </div>

        <!-- 3. Appå›¾æ ‡ -->
        <div class="white-box">
            <div class="section-title">App Icons</div>
            <div class="app-grid" id="appGrid">
                <!-- ç”± JS ç”Ÿæˆå›¾æ ‡åˆ—è¡¨ -->
            </div>
        </div>

        <!-- 3.5 æ¶ˆæ¯æç¤ºéŸ³ (æ–°åŠ çš„) -->
        <div class="white-box">
            <div class="section-title">Notification Sound</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="font-size:13px; font-weight:600;">æ¶ˆæ¯æç¤ºéŸ³</div>
                <div class="input-group">
                    <input type="text" class="text-input" id="inputMsgSound" placeholder="ç²˜è´´éŸ³é¢‘é“¾æ¥ (mp3/wav)..." onchange="updateMsgSound(this.value)">
                    <!-- è¯•å¬æŒ‰é’® -->
                    <button class="btn-mini save" style="width:50px;" onclick="previewMsgSound()">â–¶</button>
                </div>
                <div class="setting-desc">å½“è§’è‰²åœ¨åå°å›å¤æ¶ˆæ¯æ—¶æ’­æ”¾</div>
            </div>
        </div>
        
        <!-- 4. é¢„è®¾ & å¤–æ¡† -->
        <div class="white-box">
            <div class="section-title">System</div>
            
            <!-- æ‰‹æœºå¤–æ¡†å¼€å…³ -->
            <div class="setting-item">
                <div>
                    <div class="setting-label">æ‰‹æœºå¤–æ¡†</div>
                    <div class="setting-desc">ç®€çº¦å¯çˆ±çš„è¾¹æ¡†åŒ…è£¹æ•ˆæœ</div>
                </div>
                <div class="toggle-switch" id="frameToggle" onclick="toggleFrame()"></div>
            </div>

            <div style="height:1px; background:#ffeef2; margin: 10px 0;"></div>

            <!-- é¢„è®¾ç®¡ç† -->
            <div class="setting-label" style="margin-bottom:8px;">é¢„è®¾ç®¡ç†</div>
            <div class="preset-row">
                <div class="preset-select" onclick="openPresetList()">
                    <span id="currentPresetName">é»˜è®¤é¢„è®¾</span>
                    <span style="font-size:10px; color:#ccc;">â–¼</span>
                </div>
                <button class="btn-mini save" onclick="openSavePresetModal()">ğŸ’¾</button>
                <button class="btn-mini del" onclick="deletePreset()">ğŸ—‘ï¸</button>
            </div>
        </div>

        <!-- 5. åˆå§‹åŒ–æŒ‰é’® (æ–°åŠ çš„) -->
        <div class="btn-reset-block" onclick="openResetModal()">
            åˆå§‹åŒ–å¤–è§‚
            <div style="font-size:11px; font-weight:400; opacity:0.7; margin-top:4px;">é‡ç½®æ‰€æœ‰ç¾åŒ–è®¾ç½®ä¸å¯†ç </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå›¾æ ‡ä¿®æ”¹ -->
    <div class="modal-overlay" id="modal-icon">
        <div class="modal-box">
            <div class="modal-title">ä¿®æ”¹å›¾æ ‡</div>
            <div style="text-align:center; margin-bottom:10px; font-size:13px; color:#888;" id="editingAppName">App Name</div>
            <input type="text" id="iconUrlInput" class="text-input" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥..." onchange="previewIcon(this.value)">
            <div style="display:flex; justify-content:center; margin: 10px 0;">
                <div id="iconPreviewBig" style="width:60px; height:60px; border-radius:15px; background:#eee; background-size:cover;"></div>
            </div>
            <label class="file-label" style="text-align:center; display:block;">
                ä»ç›¸å†Œä¸Šä¼ 
                <input type="file" hidden accept="image/*" onchange="handleIconFile(this)">
            </label>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('modal-icon')">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmIconChange()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šä¿å­˜é¢„è®¾ -->
    <div class="modal-overlay" id="modal-save">
        <div class="modal-box">
            <div class="modal-title">ä¿å­˜æ–°é¢„è®¾</div>
            <input type="text" id="presetNameInput" class="text-input" placeholder="è¾“å…¥é¢„è®¾åç§°..." style="text-align:center;">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('modal-save')">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmSavePreset()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šé€‰æ‹©é¢„è®¾ -->
    <div class="modal-overlay" id="modal-list">
        <div class="modal-box">
            <div class="modal-title">é€‰æ‹©é¢„è®¾</div>
            <div class="preset-list" id="presetListContainer"></div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('modal-list')">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- å¼¹çª—ï¼šåˆ é™¤ç¡®è®¤ -->
    <div class="modal-overlay" id="modal-del">
        <div class="modal-box">
            <div class="modal-title">åˆ é™¤é¢„è®¾</div>
            <div style="text-align:center; font-size:14px; color:#666;">ç¡®å®šè¦åˆ é™¤å½“å‰é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('modal-del')">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmDeletePreset()" style="background:#ff8888;">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šåˆå§‹åŒ–ç¡®è®¤ (æ–°åŠ çš„) -->
    <div class="modal-overlay" id="modal-reset">
        <div class="modal-box">
            <div class="modal-title" style="color:#ff6b6b;">è­¦å‘Š</div>
            <div style="text-align:center; font-size:14px; color:#666; line-height:1.5;">
                ç¡®å®šè¦åˆå§‹åŒ–æ‰€æœ‰å¤–è§‚è®¾ç½®å—ï¼Ÿ<br>
                æ‰€æœ‰å›¾æ ‡ã€å£çº¸å’Œå¯†ç å°†æ¢å¤é»˜è®¤ã€‚<br>
                <b>æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</b>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('modal-reset')">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmReset()" style="background:#ff6b6b;">ç¡®è®¤åˆå§‹åŒ–</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">æ“ä½œæˆåŠŸ</div>

    <script>
        async function dbGet(key) {
            return await localforage.getItem(key);
        }
        async function dbSet(key, val) {
            return await localforage.setItem(key, val);
        }
        // --- æ•°æ®ç»“æ„ ---
        const DEFAULT_THEME = {
            id: 'default',
            msgSound: '', // æ¶ˆæ¯æç¤ºéŸ³URL
            name: 'é»˜è®¤é¢„è®¾',
            homeWp: '', // é»˜è®¤ç©ºæˆ–æŒ‡å®šURL
            lockWp: '',
            lockEnabled: true,
            lockTextColor: '#ffffff', // <--- ã€æ–°å¢è¿™è¡Œï¼šé»˜è®¤ç™½è‰²ã€‘
            pwdLen: 4,
            pwd: '1234',
            customText: '',
            frameEnabled: false,
            icons: {
                'phone': 'https://cdn-icons-png.flaticon.com/512/724/724664.png',
                'message': 'https://cdn-icons-png.flaticon.com/512/1384/1384090.png',
                'camera': 'https://cdn-icons-png.flaticon.com/512/4066/4066427.png',
                'settings': 'https://cdn-icons-png.flaticon.com/512/3019/3019014.png',
                'photos': 'https://cdn-icons-png.flaticon.com/512/3342/3342137.png',
                'browser': 'https://cdn-icons-png.flaticon.com/512/3065/3065849.png'
            }
        };

        // å°è¯•ä»å­˜å‚¨ä¸­è¯»å– index.html æ³¨å†Œè¿‡çš„ APP åˆ—è¡¨
        let APPS_LIST = [
            { id: 'phone', name: 'ç”µè¯' },
            { id: 'message', name: 'ä¿¡æ¯' }
        ];

        let currentTheme = JSON.parse(JSON.stringify(DEFAULT_THEME));
        let presets = [JSON.parse(JSON.stringify(DEFAULT_THEME))];
        let editingAppId = null;

        // --- æ–°å¢ï¼šå›¾ç‰‡å‹ç¼©å·¥å…· ---
// å¸®ä½ æŠŠå¤§å›¾ç‰‡å·å·å‹æ‰ï¼Œæ¨¡æ‹Ÿ URL çš„è½»é‡çº§æ•ˆæœ
function compressImage(file, maxWidth, quality, callback) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function(event) {
        const img = new Image();
        img.src = event.target.result;
        img.onload = function() {
            let width = img.width;
            let height = img.height;
            
            // å¦‚æœå›¾ç‰‡å¤ªå®½ï¼Œç­‰æ¯”ä¾‹ç¼©å°
            if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // è½¬æ¢ä¸ºå‹ç¼©åçš„ Base64 (image/jpeg æ ¼å¼ä½“ç§¯æœ€å°)
            // quality: 0.1-1.0ï¼Œæ•°å­—è¶Šå°è¶Šæ¨¡ç³Šä½†ä½“ç§¯è¶Šå°
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            callback(dataUrl);
        }
    }
}

        // åˆå§‹åŒ–
        window.onload = async function() {
            try {
                // 1. è¯»å– App åˆ—è¡¨
                const savedApps = await dbGet('buzzy_installed_apps');
                if (savedApps) {
                    APPS_LIST = (typeof savedApps === 'string') ? JSON.parse(savedApps) : savedApps;
                }
                
                // 2. è¯»å–é¢„è®¾
                const savedPresets = await dbGet('buzzy_presets');
                if(savedPresets) {
                    presets = (typeof savedPresets === 'string') ? JSON.parse(savedPresets) : savedPresets;
                }

                // 3. è¯»å–å½“å‰ä¸»é¢˜
                const savedActive = await dbGet('buzzy_active_theme');
                if(savedActive) {
                    currentTheme = (typeof savedActive === 'string') ? JSON.parse(savedActive) : savedActive;
                } else {
                    currentTheme = presets[0];
                }

                // ã€å…³é”®ä¿®å¤ã€‘ç»™æ•°æ®åšä½“æ£€ï¼Œé˜²æ­¢æ—§æ•°æ®ç¼ºå°‘å­—æ®µå¯¼è‡´å´©å
                fixThemeData(currentTheme);
                presets.forEach(p => fixThemeData(p));

                renderUI();
            } catch (err) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", err);
                alert("æ•°æ®è¯»å–å‡ºé”™ï¼Œå·²é‡ç½®ä¸ºé»˜è®¤ä¸»é¢˜ä»¥æ¢å¤åŠŸèƒ½ã€‚");
                // å…œåº•ç­–ç•¥ï¼šå‡ºé”™å°±é‡ç½®ï¼Œä¿è¯èƒ½ç”¨
                currentTheme = JSON.parse(JSON.stringify(DEFAULT_THEME));
                renderUI();
            }
        };

        // ã€æ–°å¢ã€‘æ•°æ®ä¿®å¤å‡½æ•°ï¼šç¼ºä»€ä¹ˆè¡¥ä»€ä¹ˆ
        function fixThemeData(theme) {
            if (!theme) return;
            // è¡¥å…¨åŸºç¡€å­—æ®µ
            theme.homeWp = theme.homeWp || '';
            theme.lockWp = theme.lockWp || '';
            theme.lockEnabled = (theme.lockEnabled !== undefined) ? theme.lockEnabled : true;
            theme.pwdLen = theme.pwdLen || 4;
            theme.pwd = theme.pwd || '1234';
            theme.customText = theme.customText || '';
            theme.lockTextColor = theme.lockTextColor || '#ffffff';
            theme.msgSound = theme.msgSound || '';
            theme.frameEnabled = (theme.frameEnabled !== undefined) ? theme.frameEnabled : false;
            
            // è¡¥å…¨å›¾æ ‡å¯¹è±¡
            if (!theme.icons) theme.icons = {};
            // ç¡®ä¿æ¯ä¸ªAPPéƒ½æœ‰å›¾æ ‡ï¼Œæ²¡æœ‰å°±ç”¨é»˜è®¤
            APPS_LIST.forEach(app => {
                if (!theme.icons[app.id]) {
                    theme.icons[app.id] = DEFAULT_THEME.icons[app.id] || '';
                }
            });
        }

        function closeApp() {
            if (window.parent && window.parent.closeApp) window.parent.closeApp();
            else history.back();
        }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function renderUI() {
            // 1. å£çº¸
            document.getElementById('inputHomeUrl').value = currentTheme.homeWp.startsWith('data') ? '' : currentTheme.homeWp;
            document.getElementById('previewHome').style.backgroundImage = `url(${currentTheme.homeWp})`;

            const lockPreview = document.getElementById('previewLock');
            const lockBox = document.getElementById('lockSettingsBox');
            
            if (currentTheme.lockEnabled) {
                lockPreview.classList.remove('disabled');
                lockPreview.style.backgroundImage = `url(${currentTheme.lockWp})`;
                document.getElementById('inputLockUrl').value = currentTheme.lockWp.startsWith('data') ? '' : currentTheme.lockWp;
                lockBox.style.opacity = '1';
                lockBox.style.pointerEvents = 'auto';
            } else {
                lockPreview.classList.add('disabled');
                lockPreview.style.backgroundImage = 'none';
                lockBox.style.opacity = '0.5';
                lockBox.style.pointerEvents = 'none';
            }

            // 2. é”å±ä¿¡æ¯
            setPwdLen(currentTheme.pwdLen, false); 
            document.getElementById('inputPwd').value = currentTheme.pwd;
            document.getElementById('inputText').value = currentTheme.customText;

            const textColor = currentTheme.lockTextColor || '#ffffff';
    document.getElementById('inputLockColorPicker').value = textColor;
    document.getElementById('inputLockColorText').value = textColor;

            // 3. å›¾æ ‡
            const grid = document.getElementById('appGrid');
            grid.innerHTML = '';
            APPS_LIST.forEach(app => {
                const url = currentTheme.icons[app.id] || DEFAULT_THEME.icons[app.id];
                const item = document.createElement('div');
                item.className = 'app-item';
                item.onclick = () => openIconEditor(app.id, app.name, url);
                item.innerHTML = `
                    <div class="app-icon-display" style="background-image: url('${url}')"></div>
                    <div class="app-name">${app.name}</div>
                `;
                grid.appendChild(item);
            });

            // 4. å¤–æ¡†ä¸é¢„è®¾å
            const frameSwitch = document.getElementById('frameToggle');
            if(currentTheme.frameEnabled) frameSwitch.classList.add('active');
            else frameSwitch.classList.remove('active');

            document.getElementById('currentPresetName').innerText = currentTheme.name;
            document.getElementById('inputMsgSound').value = currentTheme.msgSound || '';
        }

        // --- åŠŸèƒ½é€»è¾‘ ---

        function updatePreview(type, url) {
            if(type === 'Home') {
                currentTheme.homeWp = url;
            } else {
                currentTheme.lockWp = url;
                currentTheme.lockEnabled = true; 
            }
            renderUI();
        }

        function handleFile(input, type) {
    const file = input.files[0];
    if(!file) return;

    showToast('æ­£åœ¨å¤„ç†å›¾ç‰‡...'); // æç¤ºç”¨æˆ·ç¨å¾®ç­‰ä¸€ä¸‹

    // å£çº¸ä¸éœ€è¦4Ké«˜æ¸…ï¼Œå®½720pxï¼Œ0.6è´¨é‡è¶³å¤Ÿæ‰‹æœºçœ‹ï¼Œä½“ç§¯èƒ½ç¼©å‡ åå€
    compressImage(file, 1080, 0.8, function(compressedUrl) {
        if(type === 'Home') currentTheme.homeWp = compressedUrl;
        else {
            currentTheme.lockWp = compressedUrl;
            currentTheme.lockEnabled = true;
        }
        renderUI();
        showToast('å›¾ç‰‡æ·»åŠ æˆåŠŸ');
    });
    
    input.value = '';
}

        function toggleLockScreen() {
            currentTheme.lockEnabled = !currentTheme.lockEnabled;
            renderUI();
        }

        function setPwdLen(len, updateModel = true) {
            if(updateModel) currentTheme.pwdLen = len;
            document.getElementById('pwd4').className = len === 4 ? 'radio-opt active' : 'radio-opt';
            document.getElementById('pwd6').className = len === 6 ? 'radio-opt active' : 'radio-opt';
            const input = document.getElementById('inputPwd');
            input.setAttribute('oninput', `if(value.length>${len})value=value.slice(0,${len})`);
        }

        function updateLockColor(val) {
    // ç®€å•çš„æ ¼å¼æ ¡éªŒï¼Œå¦‚æœæ²¡æœ‰#å·ä¸”æ˜¯hexä»£ç ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œæˆ–è€…ç›´æ¥èµ‹å€¼
    if(!val.startsWith('#')) val = '#' + val; 
    
    currentTheme.lockTextColor = val;
    // åŒæ­¥ä¸¤ä¸ªè¾“å…¥æ¡†æ˜¾ç¤º
    document.getElementById('inputLockColorPicker').value = val;
    document.getElementById('inputLockColorText').value = val;
}

        let tempIconUrl = '';
        function openIconEditor(id, name, url) {
            editingAppId = id;
            document.getElementById('editingAppName').innerText = `æ­£åœ¨ä¿®æ”¹: ${name}`;
            document.getElementById('iconUrlInput').value = '';
            tempIconUrl = url;
            document.getElementById('iconPreviewBig').style.backgroundImage = `url(${url})`;
            openModal('modal-icon');
        }

        function previewIcon(url) {
            tempIconUrl = url;
            document.getElementById('iconPreviewBig').style.backgroundImage = `url(${url})`;
        }

        function handleIconFile(input) {
    const file = input.files[0];
    if(!file) return;

    showToast('æ­£åœ¨å¤„ç†å›¾æ ‡...');

    // å›¾æ ‡éå¸¸å°ï¼Œåªéœ€è¦å®½150pxå³å¯ï¼Œè´¨é‡0.7
    compressImage(file, 150, 0.7, function(compressedUrl) {
        previewIcon(compressedUrl);
        showToast('å›¾æ ‡å·²åŠ è½½');
    });
    
    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢é‡å¤ä¸Šä¼ ä¸è§¦å‘
}

        function confirmIconChange() {
            if(editingAppId) {
                currentTheme.icons[editingAppId] = tempIconUrl;
                renderUI();
            }
            closeModal('modal-icon');
        }

        function toggleFrame() {
            currentTheme.frameEnabled = !currentTheme.frameEnabled;
            renderUI();
        }

        // --- é¢„è®¾ç®¡ç† ---

        function openPresetList() {
            const container = document.getElementById('presetListContainer');
            container.innerHTML = '';
            presets.forEach(p => {
                const div = document.createElement('div');
                div.className = `preset-item ${currentTheme.id === p.id ? 'active' : ''}`;
                div.innerHTML = p.name;
                div.onclick = () => {
                    currentTheme = JSON.parse(JSON.stringify(p)); 
                    renderUI();
                    closeModal('modal-list');
                };
                container.appendChild(div);
            });
            openModal('modal-list');
        }

        function openSavePresetModal() { openModal('modal-save'); }

        function confirmSavePreset() {
            const name = document.getElementById('presetNameInput').value.trim() || 'æœªå‘½åé¢„è®¾';
            syncInputsToModel();
            const newId = Date.now().toString();
            currentTheme.id = newId;
            currentTheme.name = name;
            presets.push(JSON.parse(JSON.stringify(currentTheme)));
            savePresetsToStorage();
            renderUI();
            closeModal('modal-save');
            showToast('é¢„è®¾å·²ä¿å­˜');
        }

        function deletePreset() {
            if(currentTheme.id === 'default') {
                showToast('é»˜è®¤é¢„è®¾ä¸èƒ½åˆ é™¤');
                return;
            }
            openModal('modal-del');
        }

        function confirmDeletePreset() {
            presets = presets.filter(p => p.id !== currentTheme.id);
            currentTheme = JSON.parse(JSON.stringify(presets[0]));
            savePresetsToStorage();
            renderUI();
            closeModal('modal-del');
            showToast('é¢„è®¾å·²åˆ é™¤');
        }

        async function savePresetsToStorage() {
            try {
                await dbSet('buzzy_presets', presets);
            } catch (e) {
                // å¦‚æœå­˜ä¸è¿›å»äº†ï¼Œæç¤ºç”¨æˆ·
                alert("ä¿å­˜å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´å·²æ»¡ï¼\nè¯·åˆ é™¤ä¸€äº›ä¸ç”¨çš„é¢„è®¾ï¼Œæˆ–è€…å‡å°‘å›¾ç‰‡çš„æ•°é‡ã€‚");
                console.error(e);
            }
        }

        // --- æ¶ˆæ¯æç¤ºéŸ³é€»è¾‘ ---
        function updateMsgSound(val) {
            currentTheme.msgSound = val.trim();
        }

        function previewMsgSound() {
            const url = document.getElementById('inputMsgSound').value;
            if(!url) {
                showToast('è¯·å…ˆè¾“å…¥é“¾æ¥');
                return;
            }
            const audio = new Audio(url);
            audio.volume = 0.5; // éŸ³é‡é€‚ä¸­
            audio.play().catch(e => showToast('æ— æ³•æ’­æ”¾ï¼Œè¯·æ£€æŸ¥é“¾æ¥'));
        }

        // --- åˆå§‹åŒ–åŠŸèƒ½ (æ–°) ---
        function openResetModal() { openModal('modal-reset'); }

        async function confirmReset() {
            // æ¢å¤é»˜è®¤
            currentTheme = JSON.parse(JSON.stringify(DEFAULT_THEME));
            // åˆå§‹åŒ–é€šå¸¸èƒ½æˆåŠŸï¼Œå› ä¸ºæ˜¯å­˜å¾ˆå°çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨åŠ å¤æ‚çš„ä¿é™©
            await dbSet('buzzy_active_theme', currentTheme);

            new BroadcastChannel('buzzy_sync_channel').postMessage({ type: 'theme_update' });
            
            if(window.parent && window.parent.reloadTheme) {
                window.parent.reloadTheme();
            }
            renderUI();
            closeModal('modal-reset');
            showToast('å·²æ¢å¤åˆå§‹åŒ–');
        }

        // --- ä¿å­˜åº”ç”¨ ---
        async function applyToPhone() {
            syncInputsToModel();
            try {
                await dbSet('buzzy_active_theme', currentTheme);
                new BroadcastChannel('buzzy_sync_channel').postMessage({ type: 'theme_update' });
                if(window.parent && window.parent.reloadTheme) {
                    window.parent.reloadTheme();
                }
                showToast('ç¾åŒ–å·²åº”ç”¨ï¼');
            } catch (e) {
                // å¦‚æœåº”ç”¨å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
                alert("åº”ç”¨å¤±è´¥ï¼šå›¾ç‰‡å¤ªå¤§å¯¼è‡´æµè§ˆå™¨æ‹’ç»ä¿å­˜ã€‚\n\nå»ºè®®ï¼š\n1. åˆšæ‰çš„å›¾ç‰‡å·²è‡ªåŠ¨å‹ç¼©ï¼Œè¯·å°è¯•å†æ¬¡ç‚¹å‡»ä¿å­˜ã€‚\n2. å¦‚æœè¿˜ä¸è¡Œï¼Œè¯·åˆ é™¤ä¸€äº›å¤æ‚çš„é¢„è®¾è…¾å‡ºç©ºé—´ã€‚");
            }
        }

        function syncInputsToModel() {
            currentTheme.pwd = document.getElementById('inputPwd').value;
            currentTheme.customText = document.getElementById('inputText').value;
        }

        function openModal(id) { 
            const el = document.getElementById(id); 
            el.style.display='flex'; 
            setTimeout(()=>el.classList.add('show'),10); 
        }
        function closeModal(id) { 
            const el = document.getElementById(id); 
            el.classList.remove('show'); 
            setTimeout(()=>el.style.display='none',300); 
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

    </script>
</body>
</html>
