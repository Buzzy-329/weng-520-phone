<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>World Book</title>
    <style>
        /* --- 基础设定 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: linear-gradient(180deg, #fff0f5 0%, #ffe4e1 100%);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            color: #5d5d5d;
            overflow: hidden; position: relative;
        }

        /* --- 滚动条隐藏 --- */
        .no-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- 顶部导航栏 --- */
        .nav-bar {
            padding: 50px 24px 20px 24px;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 100; position: absolute; top: 0; left: 0; right: 0;
            background: linear-gradient(180deg, #fff0f5 0%, rgba(255, 240, 245, 0) 100%);
            pointer-events: none;
        }
        .nav-btn {
            pointer-events: auto;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2);
            font-size: 18px; color: #888; transition: transform 0.2s; border: none;
        }
        .nav-btn:active { transform: scale(0.9); }
        .nav-title { pointer-events: auto; font-size: 18px; font-weight: 600; letter-spacing: 0.5px; color: #7a6a6a; }
        .nav-right-group { pointer-events: auto; display: flex; gap: 10px; }

        /* --- 列表视图 --- */
        #view-list {
            height: 100%; width: 100%; padding-top: 100px; padding-bottom: 20px;
            display: flex; flex-direction: column; transition: opacity 0.3s;
        }
        .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 24px 15px 24px; flex-shrink: 0; }
        .filter-chip {
            flex-shrink: 0; padding: 8px 16px; background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.8); border-radius: 16px;
            font-size: 13px; color: #777; transition: all 0.3s; cursor: pointer;
        }
        .filter-chip.active {
            background: #ffb7b2; color: white; box-shadow: 0 4px 12px rgba(255, 183, 178, 0.4);
            border-color: #ffb7b2; transform: scale(1.05);
        }
        .books-container { flex: 1; overflow-y: auto; padding: 0 24px; display: flex; flex-direction: column; gap: 15px; }
        .book-card {
            background: rgba(255, 255, 255, 0.85); border-radius: 20px; padding: 20px;
            box-shadow: 0 5px 15px rgba(230, 200, 200, 0.2); display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .book-card:active { transform: scale(0.98); }
        .book-info h3 { margin: 0 0 5px 0; font-size: 16px; color: #555; }
        .book-info p { margin: 0; font-size: 12px; color: #aaa; }
        .book-arrow { color: #ffb7b2; font-size: 20px; }

        /* --- 编辑视图 --- */
        #view-editor {
            height: 100%; width: 100%; padding-top: 100px; padding-bottom: 20px;
            display: none; flex-direction: column; background: linear-gradient(180deg, #fff0f5 0%, #ffe4e1 100%);
            position: absolute; top: 0; left: 0; z-index: 20;
        }
        .editor-content { flex: 1; overflow-y: auto; padding: 0 24px 40px 24px; display: flex; flex-direction: column; gap: 20px; }
        .editor-header { background: rgba(255,255,255,0.6); border-radius: 20px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .editor-title-input { width: 100%; border: none; background: transparent; font-size: 20px; font-weight: bold; color: #555; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px; }
        .editor-cat-select { width: 100%; border: none; background: transparent; font-size: 14px; color: #888; text-align-last: center; appearance: none; -webkit-appearance: none; }
        
        /* 条目卡片 */
        .entry-card { background: #fff; border-radius: 18px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 10px; position: relative; }
        .entry-delete { position: absolute; top: -8px; left: -8px; width: 24px; height: 24px; background: #ff6b6b; color: white; border-radius: 50%; font-size: 14px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .entry-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .entry-name-input { flex: 1; border: none; font-size: 16px; font-weight: 600; color: #444; margin-right: 10px; }
        
        .toggle-switch { position: relative; width: 44px; height: 24px; -webkit-appearance: none; appearance: none; background: #e0e0e0; border-radius: 12px; transition: 0.3s; outline: none; flex-shrink: 0; }
        .toggle-switch:checked { background: #ffb7b2; }
        .toggle-switch::before { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; top: 2px; left: 2px; background: #fff; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch:checked::before { left: 22px; }

        .entry-keywords { width: 100%; border: 1px solid #f0f0f0; background: #fafafa; border-radius: 8px; padding: 8px; font-size: 12px; color: #666; }
        .entry-content { width: 100%; border: none; background: transparent; font-size: 14px; color: #555; min-height: 80px; resize: none; line-height: 1.5; }
        .add-entry-btn { background: #fff; color: #ffb7b2; border: 2px dashed #ffb7b2; border-radius: 18px; padding: 12px; text-align: center; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .add-entry-btn:active { background: #fff0f0; }

        /* --- 弹窗 --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); z-index: 100; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-card { background: rgba(255,255,255,0.95); width: 85%; max-width: 320px; padding: 24px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.show .modal-card { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: bold; color: #555; text-align: center; margin-bottom: 5px; }
        .modal-btn-col { display: flex; flex-direction: column; gap: 10px; }
        .modal-btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #ffb7b2 0%, #ffdac1 100%); color: white; }
        .btn-secondary { background: #f5f5f5; color: #888; }
        .btn-danger { background: #ffefef; color: #ff6b6b; }

        .cat-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px 15px; border-radius: 10px; font-size: 14px; color: #666; }
        .cat-delete { color: #ff6b6b; font-weight: bold; cursor: pointer; padding: 5px; }
        .cat-add-row { display: flex; gap: 8px; margin-top: 10px; }
        .cat-input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        
        .toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(50, 50, 50, 0.9); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .icon-upload { font-size: 20px; }
        .icon-list { font-size: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
</head>
<body>
    <div class="nav-bar">
        <button class="nav-btn" id="nav-back-main" onclick="closeApp()">←</button>
        <button class="nav-btn" id="nav-back-editor" style="display:none;" onclick="exitEditor(false)">←</button>
        <div class="nav-title" id="nav-title">世界书</div>
        <div class="nav-right-group" id="nav-right-main">
            <button class="nav-btn" onclick="openCatModal()"><span class="icon-list">≡</span></button>
            <button class="nav-btn" onclick="openUploadModal()"><span class="icon-upload">+</span></button>
        </div>
        <div class="nav-right-group" id="nav-right-editor" style="display:none;">
            <button class="nav-btn" onclick="openDeleteModal()" style="color: #ff9090; margin-right: 12px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
            <button class="nav-btn" onclick="saveEditorContent()" style="color: #ffb7b2; font-weight:bold;">✓</button>
        </div>
    </div>

    <div id="view-list">
        <div class="filter-scroll no-scrollbar" id="filterList"></div>
        <div class="books-container no-scrollbar" id="bookList"></div>
    </div>

    <div id="view-editor">
        <div class="editor-content no-scrollbar">
            <div class="editor-header">
                <input type="text" id="edit-title" class="editor-title-input" placeholder="输入世界书名称">
                <select id="edit-category" class="editor-cat-select"></select>
            </div>
            <div id="entries-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
            <div class="add-entry-btn" onclick="addEmptyEntry()">+ 添加新条目</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-upload">
        <div class="modal-card">
            <div class="modal-title">新建世界书</div>
            <div class="modal-btn-col">
                <button class="btn btn-primary" onclick="startManualInput()">手动输入</button>
                <button class="btn btn-secondary" onclick="triggerFileImport()">文件导入 (.json)</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('modal-upload')" style="margin-top:10px">取消</button>
        </div>
    </div>
    <input type="file" id="file-input" style="display: none;" accept=".json" onchange="handleFileImport(this)">

    <div class="modal-overlay" id="modal-cat">
        <div class="modal-card">
            <div class="modal-title">分类管理</div>
            <div class="cat-list no-scrollbar" id="cat-manage-list"></div>
            <div class="cat-add-row">
                <input type="text" id="new-cat-input" class="cat-input" placeholder="新分类名称">
                <button class="btn btn-primary" style="padding: 8px 15px;" onclick="addNewCategory()">添加</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('modal-cat')" style="margin-top:10px">关闭</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-delete">
        <div class="modal-card">
            <div class="modal-title">操作确认</div>
            <p id="delete-msg" style="text-align:center; color:#666; font-size:14px; margin: 10px 0;">确定要删除吗？</p>
            <div class="modal-btn-row">
                <button class="btn btn-secondary" onclick="closeModal('modal-delete')">取消</button>
                <button class="btn btn-danger" onclick="confirmDelete()">删除</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">提示信息</div>

    <script>
        let categories = ["全部", "未分类"];
        let worldbooks = [];
        let currentFilter = "全部";
        let editingBookId = null;

        let dbPromise;
        function initDB() {
            if (!dbPromise) {
    dbPromise = idb.openDB('QQ_DB_2026', 1, {
        upgrade(db) {
            // 这里只做一件事：如果没有 keyval 表，就建一个
            if (!db.objectStoreNames.contains('keyval')) {
                db.createObjectStore('keyval');
            }
        },
    });
}
            return dbPromise;
        }
        async function dbGet(key) {
            const db = await initDB();
            return await db.get('keyval', key);
        }
        async function dbSet(key, val) {
            const db = await initDB();
            return await db.put('keyval', val, key);
        }
        
        window.onload = async function() { 
            await loadData(); 
            renderFilter(); 
            renderBookList(); 
        };

        async function loadData() {
            // 读取分类
            const savedCats = await dbGet('wb_categories');
            if (savedCats) {
                try { categories = JSON.parse(savedCats); } catch(e) {}
            }
            // 读取世界书 (关键)
            const savedBooks = await dbGet('wb_books');
            if (savedBooks) {
                try { worldbooks = JSON.parse(savedBooks); } catch(e) {}
            }
        }
        async function saveData() {
            // 必须 stringify，否则 chat_window 读取时会报错
            await dbSet('wb_categories', JSON.stringify(categories));
            await dbSet('wb_books', JSON.stringify(worldbooks));
        }

        function renderFilter() {
            const container = document.getElementById('filterList');
            container.innerHTML = '';
            const hasUncategorized = worldbooks.some(b => b.category === "未分类");
            categories.forEach(cat => {
                if (cat === "未分类" && !hasUncategorized) return;
                const chip = document.createElement('div');
                chip.className = `filter-chip ${currentFilter === cat ? 'active' : ''}`;
                chip.innerText = cat;
                chip.onclick = () => { currentFilter = cat; renderFilter(); renderBookList(); };
                container.appendChild(chip);
            });
        }

        function renderBookList() {
            const container = document.getElementById('bookList');
            container.innerHTML = '';
            let filtered = worldbooks;
            if (currentFilter !== "全部") filtered = worldbooks.filter(b => b.category === currentFilter);
            if (filtered.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:50px; font-size:14px;">暂无世界书</div>'; return; }
            filtered.forEach(book => {
                const card = document.createElement('div');
                card.className = 'book-card';
                card.onclick = () => openEditor(book.id);
                card.innerHTML = `<div class="book-info"><h3>${book.name}</h3><p>${book.category} · ${book.entries.length} 个条目</p></div><div class="book-arrow">›</div>`;
                container.appendChild(card);
            });
        }

        function toggleView(isEditor) {
            document.getElementById('nav-back-main').style.display = isEditor ? 'none' : 'flex';
            document.getElementById('nav-back-editor').style.display = isEditor ? 'flex' : 'none';
            document.getElementById('nav-right-main').style.display = isEditor ? 'none' : 'flex';
            document.getElementById('nav-right-editor').style.display = isEditor ? 'flex' : 'none';
            document.getElementById('view-list').style.display = isEditor ? 'none' : 'flex';
            document.getElementById('view-editor').style.display = isEditor ? 'flex' : 'none';
            document.getElementById('nav-title').innerText = isEditor ? "编辑内容" : "世界书";
            if(!isEditor) { renderFilter(); renderBookList(); }
        }

        function openEditor(bookId = null) {
            editingBookId = bookId;
            const titleInput = document.getElementById('edit-title');
            const catSelect = document.getElementById('edit-category');
            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            catSelect.innerHTML = '';
            categories.forEach(cat => {
                if (cat === "全部") return;
                const opt = document.createElement('option');
                opt.value = cat; opt.innerText = cat; catSelect.appendChild(opt);
            });

            if (bookId) {
                const book = worldbooks.find(b => b.id === bookId);
                titleInput.value = book.name; catSelect.value = book.category;
                book.entries.forEach(entry => addEntryToDom(entry));
            } else {
                titleInput.value = ""; catSelect.value = "未分类"; addEmptyEntry();
            }
            toggleView(true);
        }

        function addEntryToDom(data = {name:"", active:true, keywords:"", content:""}) {
            const container = document.getElementById('entries-container');
            const div = document.createElement('div');
            div.className = 'entry-card';
            div.innerHTML = `<div class="entry-delete" onclick="this.parentElement.remove()">×</div><div class="entry-header"><input type="text" class="entry-name-input" placeholder="条目名称" value="${data.name}"><input type="checkbox" class="toggle-switch" ${data.active ? 'checked' : ''}></div><input type="text" class="entry-keywords" placeholder="关键词 (可选)" value="${data.keywords}"><textarea class="entry-content no-scrollbar" placeholder="在此输入具体内容...">${data.content}</textarea>`;
            container.appendChild(div);
        }
        function addEmptyEntry() { addEntryToDom(); }

        function saveEditorContent() {
            const title = document.getElementById('edit-title').value.trim();
            if (!title) { showToast("请输入世界书名称"); return; }
            const category = document.getElementById('edit-category').value;
            const entries = [];
            document.querySelectorAll('.entry-card').forEach(div => {
                const name = div.querySelector('.entry-name-input').value.trim();
                if(name) entries.push({ name: name, active: div.querySelector('.toggle-switch').checked, keywords: div.querySelector('.entry-keywords').value.trim(), content: div.querySelector('.entry-content').value });
            });

            if (editingBookId) {
                const idx = worldbooks.findIndex(b => b.id === editingBookId);
                if (idx !== -1) { worldbooks[idx].name = title; worldbooks[idx].category = category; worldbooks[idx].entries = entries; }
            } else {
                worldbooks.push({ id: Date.now(), name: title, category: category, entries: entries });
            }
            saveData(); showToast("已保存"); toggleView(false);
        }
        function exitEditor(save) { toggleView(false); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function openUploadModal() { document.getElementById('modal-upload').classList.add('show'); }
        function startManualInput() { closeModal('modal-upload'); openEditor(null); }
        function triggerFileImport() { document.getElementById('file-input').click(); }
        function handleFileImport(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    worldbooks.push({ id: Date.now(), name: data.name || file.name.replace('.json', ''), category: "未分类", entries: Array.isArray(data.entries) ? data.entries : [] });
                    saveData(); closeModal('modal-upload'); showToast("导入成功"); renderFilter(); renderBookList();
                } catch (err) { showToast("文件格式错误"); }
                input.value = '';
            }; reader.readAsText(file);
        }

        function openCatModal() { renderCatManageList(); document.getElementById('modal-cat').classList.add('show'); }
        function renderCatManageList() {
            const list = document.getElementById('cat-manage-list'); list.innerHTML = '';
            categories.forEach(cat => {
                if (cat === "全部") return;
                const item = document.createElement('div'); item.className = 'cat-item';
                item.innerHTML = `<span>${cat}</span>` + (cat !== "未分类" ? `<div class="cat-delete" onclick="deleteCategory('${cat}')">×</div>` : '');
                list.appendChild(item);
            });
        }
        function addNewCategory() {
            const name = document.getElementById('new-cat-input').value.trim();
            if (name && !categories.includes(name)) { categories.push(name); saveData(); document.getElementById('new-cat-input').value = ''; renderCatManageList(); renderFilter(); }
            else if (categories.includes(name)) showToast("分类已存在");
        }
        function deleteCategory(catName) {
            worldbooks.forEach(b => { if (b.category === catName) b.category = "未分类"; });
            categories = categories.filter(c => c !== catName);
            saveData(); renderCatManageList(); renderFilter(); renderBookList();
        }

        function openDeleteModal() {
            document.getElementById('delete-msg').innerText = editingBookId ? "确定要永久删除这本世界书吗？" : "确定要放弃新建吗？";
            document.getElementById('modal-delete').classList.add('show');
        }
        function confirmDelete() {
            closeModal('modal-delete');
            if (editingBookId) { worldbooks = worldbooks.filter(b => b.id !== editingBookId); saveData(); showToast("已删除"); }
            toggleView(false);
        }

        function closeApp() { if (window.parent && window.parent.closeApp) window.parent.closeApp(); else history.back(); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    </script>
</body>
</html>
