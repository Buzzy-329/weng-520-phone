<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Character Detail</title>
    <style id="dynamicPreviewStyles"></style>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <style>
        /* --- 1. åŸºç¡€é£æ ¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: linear-gradient(180deg, #fff0f5 0%, #ffeef2 100%);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            color: #5d5d5d;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆª --- */
        .nav-bar {
            padding: 40px 24px 15px 24px;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 100; flex-shrink: 0;
            background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(10px);
            position: absolute; top: 0; left: 0; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.5);
        }
        .nav-btn {
            width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.6);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2); font-size: 18px; color: #888; border: none;
        }
        .nav-btn:active { transform: scale(0.9); }
        .page-title { font-size: 17px; font-weight: 600; color: #7a6a6a; }
        .btn-save-top { color: #ffb7c5; font-weight: bold; font-size: 14px; width: auto; padding: 0 15px; border-radius: 20px; }

        /* --- 3. å†…å®¹åŒºåŸŸ --- */
        .content-scroll-area {
            flex: 1; margin-top: 95px; padding: 10px 20px 40px 20px;
            overflow-y: auto; scrollbar-width: none; display: flex; flex-direction: column; gap: 20px;
        }
        .content-scroll-area::-webkit-scrollbar { display: none; }
        
        .white-box {
            background: rgba(255, 255, 255, 0.9); border-radius: 24px;
            box-shadow: 0 10px 30px rgba(255, 182, 193, 0.15), 0 4px 10px rgba(255, 255, 255, 0.5);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .section-label { font-size: 12px; color: #ffb7c5; font-weight: 700; letter-spacing: 1px; margin-bottom: -5px; text-transform: uppercase; }

        /* å¤´åƒä¸åå­— */
        .profile-header { display: flex; align-items: center; gap: 15px; }
        .avatar-wrap {
            position: relative; width: 70px; height: 70px; flex-shrink: 0;
            border-radius: 50%; overflow: hidden; cursor: pointer;
            border: 3px solid #fff; box-shadow: 0 5px 15px rgba(255,182,193,0.3); background: #eee;
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 20px; background: rgba(0,0,0,0.3); color: #fff; font-size: 10px; display: flex; justify-content: center; align-items: center; }
        .name-inputs { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .input-line { width: 100%; border: none; background: transparent; border-bottom: 1px solid #ffeef2; padding: 5px 0; font-size: 15px; color: #555; }
        .input-line:focus { border-bottom-color: #ffb7c5; }
        .input-sub { font-size: 13px; color: #888; } 

        .select-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: #fff8fa; border-radius: 16px;
            cursor: pointer; font-size: 14px; color: #666;
        }
        .select-row:active { background: #fff0f5; }
        .select-value { color: #ffb7c5; font-weight: 600; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .persona-box {
            width: 100%; height: 120px; background: #fffbfd; border: 1px solid #ffeef2;
            border-radius: 16px; padding: 12px; font-size: 14px; color: #555; line-height: 1.5; resize: none; overflow-y: auto;
        }
        .persona-box::-webkit-scrollbar { width: 4px; }
        .persona-box::-webkit-scrollbar-thumb { background: #ffdae0; border-radius: 4px; }

        .btn-row { display: flex; gap: 10px; margin-top: 5px; }
        .small-btn {
            flex: 1; padding: 10px; border-radius: 12px; border: none;
            font-size: 12px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-pink { background: #fff0f5; color: #ffb7c5; border: 1px solid #ffeef2; }
        .btn-outline { background: #fff; color: #888; border: 1px solid #eee; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
        .num-input { width: 60px; padding: 8px; border-radius: 10px; border: 1px solid #ffeef2; text-align: center; font-size: 13px; background: #fff8fa; }
        .text-input-small { width: 100px; padding: 8px; border-radius: 10px; border: 1px solid #ffeef2; text-align: right; font-size: 13px; background: #fff8fa; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #eee; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ffb7c5; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- é¢„è§ˆåŒºä¸“ç”¨åŸºç¡€æ ·å¼ (åŠ åœ¨ .preview-img-box æ ·å¼åé¢) --- */
#chatBgPreview .bubble {
    padding: 10px 15px;
    font-size: 13px;
    position: relative;
    max-width: 80%;
    word-wrap: break-word;
}
/* é»˜è®¤æ ·å¼ï¼Œé˜²æ­¢æ²¡è¾“CSSæ—¶çœ‹ä¸è§ */
#chatBgPreview .msg-row.ai .bubble { background: #fff; color: #333; border-radius: 15px 15px 15px 4px; }
#chatBgPreview .msg-row.me .bubble { background: #0099FF; color: #fff; border-radius: 15px 15px 4px 15px; }


        .preview-img-box { 
    width: 100%; 
    height: 240px; /* <--- æ”¹è¿™é‡Œï¼Œ240px è¶³å¤Ÿæ˜¾ç¤ºå¤§è´´çº¸äº† */
    background: #eee; 
    border-radius: 12px; 
    overflow: hidden; 
    background-size: cover; 
    background-position: center; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    gap: 10px; 
}
        .bubble-demo { padding: 8px 12px; max-width: 80%; font-size: 13px; position: relative; }
        .bubble-default-ai { background: #fff; border-radius: 15px 15px 15px 4px; color: #333; }
        .bubble-default-user { background: #0099FF; border-radius: 15px 15px 4px 15px; color: #fff; }

        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tool-btn { padding: 12px; background: #fdfdfd; border: 1px solid #f0f0f0; border-radius: 14px; font-size: 13px; color: #666; text-align: center; cursor: pointer; }
        .btn-danger { color: #ff6b6b; border-color: #ffebeb; background: #fff5f5; }

        /* --- å¼¹çª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 320px; background: #fff; border-radius: 24px; padding: 25px;
            box-shadow: 0 0 25px rgba(255, 182, 193, 0.5), 0 10px 40px rgba(255, 182, 193, 0.4);
            display: flex; flex-direction: column; gap: 15px;
            max-height: 70vh; transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-title { font-size: 16px; font-weight: 700; color: #444; text-align: center; }
        .modal-input { width: 100%; padding: 12px; border: 1px solid #ffeef2; background: #fffbfd; border-radius: 14px; font-size: 14px; outline: none; color: #555; }
        .modal-list { overflow-y: auto; max-height: 200px; display: flex; flex-direction: column; gap: 8px; }
        .list-item { padding: 12px; background: #f9f9f9; border-radius: 12px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 14px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #f2f2f2; color: #888; }
        .btn-confirm { background: #ffb7c5; color: #fff; }

        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(255,255,255,0.95); padding: 12px 25px; border-radius: 30px; box-shadow: 0 5px 20px rgba(255, 182, 193, 0.3); font-size: 13px; color: #555; transition: transform 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        #hiddenFileInput { display: none; }
        
        /* å¤©æ°”è¾“å…¥ç»„ */
        .weather-group { margin-top: 5px; padding: 10px; background: #fffbfd; border-radius: 12px; }
        .weather-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .weather-label { font-size: 11px; color: #999; margin-bottom: 3px; display:block; }
    </style>
</head>
<body>
    <div class="nav-bar">
        <button class="nav-btn" onclick="openConfirmModal('exit')">â†</button>
        <div class="page-title">è§’è‰²è¯¦ç»†è®¾å®š</div>
        <button class="nav-btn btn-save-top" onclick="saveAllSettings()">ä¿å­˜</button>
    </div>

    <div class="content-scroll-area">
        <div class="white-box">
            <div class="section-label">è§’è‰²ä¿¡æ¯</div>
            <div class="profile-header">
                <div class="avatar-wrap" onclick="triggerUpload('charAvatar')">
                    <img id="charAvatarImg" class="avatar-img" src="" style="display:none">
                    <div id="charAvatarPlaceholder" style="width:100%;height:100%;background:#eee;color:#ccc;display:flex;justify-content:center;align-items:center;font-size:10px;">æ— å¤´åƒ</div>
                    <div class="avatar-overlay">æ›´æ¢</div>
                </div>
                <div class="name-inputs">
                    <input type="text" class="input-line" id="charDisplayName" placeholder="å¤‡æ³¨å (ç”¨æˆ·å¯è§)">
                    <input type="text" class="input-line input-sub" id="charTrueName" placeholder="æœ¬å (æ¨¡å‹è¯»å–)">
                </div>
            </div>
        </div>

        <div class="white-box">
            <div class="section-label">ä½ åœ¨Taçœ¼ä¸­çš„å½¢è±¡</div>
            <div class="profile-header">
                <div class="avatar-wrap" onclick="triggerUpload('userAvatar')">
                    <img id="userAvatarImg" class="avatar-img" src="" style="display:none">
                    <div id="userAvatarPlaceholder" style="width:100%;height:100%;background:#eee;color:#ccc;display:flex;justify-content:center;align-items:center;font-size:10px;">æ— å¤´åƒ</div>
                    <div class="avatar-overlay">æ›´æ¢</div>
                </div>
                <div class="name-inputs">
                    <input type="text" class="input-line" id="userNickName" placeholder="è§’è‰²ç»™ä½ çš„å¤‡æ³¨ (æ˜µç§°)">
                    <div style="font-size:11px; color:#aaa; margin-top:4px;">* æ­¤æ˜µç§°è§’è‰²å¯éšæœºæ›´æ”¹ï¼Œç”¨æˆ·çœŸå®å§“åè¯·å†™åœ¨ä¸‹æ–¹äººè®¾ä¸­</div>
                </div>
            </div>
        </div>

        <div class="white-box" onclick="openGroupModal()">
            <div class="section-label">å¥½å‹åˆ†ç»„</div>
            <div class="select-row"><span>å½“å‰åˆ†ç»„</span><span class="select-value" id="currentGroupDisplay">æœªåˆ†ç»„ ></span></div>
        </div>

        <div class="white-box">
            <div class="section-label">è§’è‰²äººè®¾ (Prompt)</div>
            <textarea class="persona-box" id="charPersona" placeholder="è¾“å…¥è§’è‰²çš„è¯¦ç»†è®¾å®šï¼Œæ€§æ ¼ï¼ŒèƒŒæ™¯æ•…äº‹..."></textarea>
        </div>

        <div class="white-box">
            <div class="section-label">ç”¨æˆ·äººè®¾ (User Persona)</div>
            <textarea class="persona-box" id="userPersona" placeholder="è¾“å…¥ä½ çš„çœŸå®å§“åå’Œäººè®¾..."></textarea>
            <div class="btn-row">
                <button class="small-btn btn-outline" onclick="openPresetListModal('user')">é€‰æ‹©é¢„è®¾</button>
                <button class="small-btn btn-pink" onclick="openSavePresetModal('user')">ä¿å­˜ä¸ºé¢„è®¾</button>
            </div>
        </div>

        <div class="white-box">
            <div class="section-label">é€»è¾‘ä¸è®°å¿†</div>
            <div class="select-row" onclick="openWorldBookModal()"><span>ä¸–ç•Œä¹¦ (World Book)</span><span class="select-value" id="currentWorldBook">æ—  ></span></div>
            <div class="setting-row"><span class="setting-label">çŸ­æœŸè®°å¿†æ¡æ•°</span><input type="number" class="num-input" id="shortMemCount" value="20"></div>
            <div class="setting-row"><span class="setting-label">è‡ªåŠ¨æ€»ç»“å¼€å…³</span><div class="setting-right"><label class="switch"><input type="checkbox" id="autoSummarySwitch"><span class="slider"></span></label></div></div>
            <div class="setting-row"><span class="setting-label">è‡ªåŠ¨æ€»ç»“é˜ˆå€¼</span><input type="number" class="num-input" id="autoSummaryThreshold" value="100"></div>
            <!-- æ–°å¢ï¼šè‡ªå®šä¹‰æ€»ç»“æŒ‡ä»¤ -->
            <div style="margin-top:10px;">
                <span class="setting-label">è‡ªå®šä¹‰æ€»ç»“æŒ‡ä»¤ (å¯é€‰)</span>
                <textarea class="persona-box" style="height:80px; margin-top:5px; font-size:12px;" id="summaryPrompt" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æŒ‡ä»¤ã€‚&#10;ç¤ºä¾‹ï¼šè¯·ä»¥ç¬¬ä¸€äººç§°æ—¥è®°çš„å½¢å¼æ€»ç»“è¿™æ®µå¯¹è¯..."></textarea>
            </div>
            <button class="small-btn btn-pink" style="width:100%; margin-top:5px;" onclick="triggerManualSummary()">âœ¨ ç«‹å³æ‰‹åŠ¨æ€»ç»“ (æ™ºèƒ½ç”Ÿæˆ)</button>
            <div class="select-row" style="margin-top:10px;" onclick="openLongMemModal()"><span>é•¿æœŸè®°å¿†åº“</span><span class="select-value" id="longMemCount">0æ¡ ></span></div>
            <div class="setting-row" style="margin-top:10px; border-top:1px solid #ffeef2; padding-top:10px;">
    <span class="setting-label" style="color:#ffb7c5; font-weight:bold;">çº¿ä¸‹æ¨¡å¼ (å°è¯´æ¨¡å¼)</span>
    <div class="setting-right">
        <label class="switch"><input type="checkbox" id="offlineModeSwitch"><span class="slider"></span></label>
    </div>
</div>
<!-- åªæœ‰å¼€å¯çº¿ä¸‹æ¨¡å¼æ‰æ˜¾ç¤ºçš„äººç§°æ˜¾ç¤ºåŒº -->
<div class="select-row" id="offlinePerspectiveRow" style="display:none; margin-top:5px; background:#fff0f5;" onclick="openPerspectiveModal()">
    <span>å™è¿°äººç§°</span>
    <span class="select-value" id="currentPerspectiveDisplay">ç¬¬äºŒäººç§° ></span>
</div>
<!-- æ–°å¢ï¼šåŒè¯­æ¨¡å¼ç‹¬ç«‹å¼€å…³ -->
            <div class="setting-row" style="margin-top:10px; border-top:1px solid #ffeef2; padding-top:10px;">
                <span class="setting-label" style="color:#ffb7c5; font-weight:bold;">åŒè¯­æ¨¡å¼</span>
                <div class="setting-right">
                    <label class="switch"><input type="checkbox" id="bilingualModeSwitch"><span class="slider"></span></label>
                </div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#aaa;margin-top:5px;"><span>å½“å‰å¯¹è¯: <span id="statMsgCount">0</span>æ¡</span><span>Token: <span id="statTokenCount">0</span></span></div>
        </div>

        <div class="white-box">
            <div class="section-label">ç¯å¢ƒæ„ŸçŸ¥</div>
            <div class="setting-row">
                <span class="setting-label">æ—¶é—´æ„ŸçŸ¥ (æ—¶åŒº)</span>
                <div class="setting-right">
                    <label class="switch"><input type="checkbox" id="timeSenseSwitch"><span class="slider"></span></label>
                </div>
            </div>
            <!-- æ—¶åŒºé€‰æ‹©å™¨ -->
            <div class="select-row" id="timeZoneSelectRow" onclick="openTimeZoneModal()" style="margin-top:5px; padding:10px;">
                <span>é€‰æ‹©æ—¶åŒº</span>
                <span class="select-value" id="currentTimeZoneDisplay">èƒŒæ™¯ç³»ç»Ÿæ—¶é—´ ></span>
            </div>

            <div class="setting-row" style="margin-top:10px;">
                <span class="setting-label">å¤©æ°”æ„ŸçŸ¥</span>
                <div class="setting-right">
                    <label class="switch"><input type="checkbox" id="weatherSenseSwitch"><span class="slider"></span></label>
                </div>
            </div>
            <div id="weatherConfigArea" style="display:none; flex-direction:column; gap:8px;">
                <div class="weather-group">
                    <span class="weather-label" style="color:#ffb7c5; font-weight:bold;">è§’è‰²å¤©æ°”è®¾å®š</span>
                    <div class="weather-row">
                        <div style="flex:1">
                            <span class="weather-label">è™šæ‹Ÿå (è§’è‰²è®¤ä¸ºè‡ªå·±åœ¨)</span>
                            <input type="text" class="input-line" style="font-size:13px; width:100%" id="charWeatherVirtualLoc" placeholder="è™šæ‹Ÿåœ°å">
                        </div>
                        <div style="flex:1">
                            <span class="weather-label">çœŸå®åœ°ç‚¹ (ç”¨äºAPIè¯»å–)</span>
                            <input type="text" class="input-line" style="font-size:13px; width:100%" id="charWeatherRealLoc" placeholder="çœä»½/åŸå¸‚">
                        </div>
                    </div>
                </div>
                <div class="weather-group">
                    <span class="weather-label" style="color:#007AFF; font-weight:bold;">ç”¨æˆ·å¤©æ°”è®¾å®š</span>
                    <div class="weather-row">
                        <div style="flex:1">
                            <span class="weather-label">è™šæ‹Ÿå (è§’è‰²è®¤ä¸ºä½ åœ¨)</span>
                            <input type="text" class="input-line" style="font-size:13px; width:100%" id="userWeatherVirtualLoc" placeholder="è™šæ‹Ÿåœ°å">
                        </div>
                        <div style="flex:1">
                            <span class="weather-label">çœŸå®åœ°ç‚¹ (ç”¨äºAPIè¯»å–)</span>
                            <input type="text" class="input-line" style="font-size:13px; width:100%" id="userWeatherRealLoc" placeholder="çœä»½/åŸå¸‚">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="white-box">
            <div class="section-label">ç•Œé¢ç¾åŒ–</div>
            <div class="setting-row">
    <span class="setting-label">èŠå¤©èƒŒæ™¯</span>
    <div style="display:flex; gap:10px;">
        <button class="small-btn btn-outline" style="width: auto;" onclick="triggerUpload('chatBg')">ç›¸å†Œä¸Šä¼ </button>
        <button class="small-btn btn-outline" style="width: auto;" onclick="triggerUrlInput('chatBg')">URLå¯¼å…¥</button>
    </div>
</div>
            <div class="preview-img-box" id="chatBgPreview">
    <div style="width:90%; padding: 20px 0; display:flex; flex-direction:column; gap:25px;">
        <!-- æ¨¡æ‹Ÿå¯¹æ–¹æ¶ˆæ¯ç»“æ„ -->
        <div class="msg-row ai" style="display:flex; width:100%; position:relative;">
            <div class="bubble" id="demoAiBubble">è§’è‰²æ°”æ³¡é¢„è§ˆ</div>
        </div>
        <!-- æ¨¡æ‹Ÿæˆ‘çš„æ¶ˆæ¯ç»“æ„ -->
        <div class="msg-row me" style="display:flex; width:100%; justify-content:flex-end; position:relative;">
            <div class="bubble" id="demoUserBubble">ç”¨æˆ·æ°”æ³¡é¢„è§ˆ</div>
        </div>
    </div>
</div>
            <div style="margin-top:15px;"><span class="setting-label">æ°”æ³¡æ ·å¼ (CSS)</span><textarea class="persona-box" style="height:80px; margin-top:5px;" id="bubbleCss" placeholder=".bubble { background: pink; }"></textarea></div>
            <div style="margin-top:15px;">
    <span class="setting-label">å…¨ç•Œé¢UIæ ·å¼ (CSS)</span>
    <textarea class="persona-box" style="height:100px; margin-top:5px;" id="uiCss" placeholder="/* è‡ªå®šä¹‰ä¸Šä¸‹æ æ ·å¼ */
.chat-header { background: rgba(0,0,0,0.5); }
.input-bar-wrap { background: black; }"></textarea>
</div>
            <div class="btn-row"><button class="small-btn btn-outline" onclick="openPresetListModal('bubble')">é€‰æ‹©æ ·å¼é¢„è®¾</button><button class="small-btn btn-pink" onclick="openSavePresetModal('bubble')">ä¿å­˜å½“å‰æ ·å¼</button></div>
        </div>

        <div class="white-box">
            <div class="section-label">èŠå¤©è®°å½•ç®¡ç†</div>
            <div class="tool-grid">
                <div class="tool-btn" onclick="openSearchModal()">ğŸ” æŸ¥æ‰¾è®°å½•</div>
                <div class="tool-btn btn-danger" onclick="openConfirmModal('clear')">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</div>
                <div class="tool-btn" onclick="exportHistory()">ğŸ“¤ å¯¼å‡ºè®°å½•</div>
                <div class="tool-btn" onclick="triggerImport()">ğŸ“¥ å¯¼å…¥è®°å½•</div>
            </div>
        </div>
    </div>
    <input type="file" id="hiddenFileInput">

    <!-- å¼¹çª—ä»¬ -->
    <div class="modal-overlay" id="modal-input-name">
        <div class="modal-box"><div class="modal-title" id="inputModalTitle">è¾“å…¥åç§°</div><input type="text" class="modal-input" id="genericInput" autocomplete="off"><div class="modal-btns"><button class="modal-btn btn-cancel" onclick="closeModal('modal-input-name')">å–æ¶ˆ</button><button class="modal-btn btn-confirm" id="btnConfirmInput">ç¡®å®š</button></div></div>
    </div>
    <div class="modal-overlay" id="modal-list-select">
        <div class="modal-box"><div class="modal-title" id="listModalTitle">é€‰æ‹©</div><div class="modal-list" id="genericListContainer"></div><div class="modal-btns"><button class="modal-btn btn-confirm" id="btnAddToList" style="display:none;">+ æ·»åŠ </button><button class="modal-btn btn-cancel" onclick="closeModal('modal-list-select')">å…³é—­</button></div></div>
    </div>
    <div class="modal-overlay" id="modal-long-mem">
        <div class="modal-box"><div class="modal-title">é•¿æœŸè®°å¿†ç®¡ç†</div><div class="modal-list" id="longMemList" style="max-height: 300px;"></div><div class="modal-btns"><button class="modal-btn btn-cancel" onclick="addLongMem()">+ æ·»åŠ </button><button class="modal-btn btn-confirm" onclick="saveLongMemChanges()">ä¿å­˜ä¿®æ”¹</button></div></div>
    </div>
    <div class="modal-overlay" id="modal-confirm">
        <div class="modal-box"><div class="modal-title">æç¤º</div><div style="text-align:center;color:#666" id="confirmMsg"></div><div class="modal-btns"><button class="modal-btn btn-cancel" onclick="closeModal('modal-confirm')">å–æ¶ˆ</button><button class="modal-btn btn-confirm" id="btnConfirmAction">ç¡®å®š</button></div></div>
    </div>
    <!-- æœç´¢å¼¹çª— -->
    <div class="modal-overlay" id="modal-search">
        <div class="modal-box">
            <div class="modal-title">æŸ¥æ‰¾èŠå¤©è®°å½•</div>
            <input type="text" class="modal-input" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯...">
            <button class="small-btn btn-pink" style="width:100%" onclick="doSearch()">æœç´¢</button>
            <div class="modal-list" id="searchResultList" style="max-height: 200px; margin-top:10px;"></div>
            <button class="modal-btn btn-cancel" style="width:100%" onclick="closeModal('modal-search')">å…³é—­</button>
        </div>
    </div>
    <!-- æ–°å¢ï¼šäººç§°é€‰æ‹©å¼¹çª— -->
<div class="modal-overlay" id="modal-perspective">
    <div class="modal-box">
        <div class="modal-title">é€‰æ‹©çº¿ä¸‹æ¨¡å¼äººç§°</div>
        <div style="font-size:12px; color:#999; margin-bottom:10px; line-height:1.4;">
            <b>ç¬¬äºŒäººç§°ï¼š</b>åŸæ–‡ç§°å‘¼ç”¨æˆ·ä¸ºâ€œä½ â€ï¼Œç§°å‘¼è§’è‰²ä¸ºâ€œä»–/å¥¹/åå­—â€ã€‚<br>
            <b>ç¬¬ä¸‰äººç§°ï¼š</b>åŸæ–‡ç§°å‘¼ç”¨æˆ·ä¸ºâ€œæœ¬åâ€ï¼Œç§°å‘¼è§’è‰²ä¸ºâ€œæœ¬åâ€ã€‚(æ— â€œä½ /æˆ‘â€)
        </div>
        <div class="modal-list">
            <div class="list-item" onclick="selectPerspective('2nd')">
                <span>ç¬¬äºŒäººç§° (ä½  & ä»–/å¥¹)</span>
                <span id="mark-2nd" style="color:#ffb7c5; font-weight:bold; display:none;">âœ“</span>
            </div>
            <div class="list-item" onclick="selectPerspective('3rd')">
                <span>ç¬¬ä¸‰äººç§° (åå­— & åå­—)</span>
                <span id="mark-3rd" style="color:#ffb7c5; font-weight:bold; display:none;">âœ“</span>
            </div>
        </div>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-perspective')">å…³é—­</button>
        </div>
    </div>
</div>

    <div class="toast" id="toast"><span id="toastMsg"></span></div>

    <script>
        const detailChannel = new BroadcastChannel('buzzy_sync_channel');
         // --- æ–°å¢ï¼šå¬åˆ°å–Šå£°åï¼Œé‡æ–°åŠ è½½æ•°æ® ---
        detailChannel.onmessage = async (event) => {
            if (event.data && event.data.type === 'refresh_list') {
                await loadData(); // é‡æ–°è¯»æ•°æ®åº“
                // å¦‚æœå½“å‰æ­£åœ¨çœ‹è¿™ä¸ªè§’è‰²ï¼Œé¡ºä¾¿åˆ·æ–°ä¸€ä¸‹ç•Œé¢
                if (currentChar && currentChar.id) {
                    const latest = characters.find(c => c.id === currentChar.id);
                    if (latest) {
                        currentChar = latest;
                        initUI(); // åˆ·æ–°ç•Œé¢æ–‡å­—
                    }
                }
            }
        };
        let dbPromise;
        function initDB() {
            if (!dbPromise) {
    dbPromise = idb.openDB('QQ_DB_2026', 1, {
        upgrade(db) {
            // è¿™é‡Œåªåšä¸€ä»¶äº‹ï¼šå¦‚æœæ²¡æœ‰ keyval è¡¨ï¼Œå°±å»ºä¸€ä¸ª
            if (!db.objectStoreNames.contains('keyval')) {
                db.createObjectStore('keyval');
            }
        },
    });
}
            return dbPromise;
        }
        async function dbGet(key) {
            const db = await initDB();
            return await db.get('keyval', key);
        }
        async function dbSet(key, val) {
            const db = await initDB();
            return await db.put('keyval', val, key);
        }
        const DB_KEY = 'qq_app_data_pro_max_final';
        const PRESET_KEY = 'qq_app_presets_global';
        const WB_KEY = 'wb_books';
        let characters = [], currentChar = null, charIndex = -1;
        let globalPresets = { userPersonas: [], bubbleStyles: [] };
        let allGroups = new Set(['æœªåˆ†ç»„', 'æˆ‘çš„å¥½å‹', 'ç‰¹åˆ«å…³å¿ƒ']); 

         window.onload = async function() {
            // 1. é…ç½® localforage è¿æ¥åˆ°å’Œ chat_window ä¸€æ ·çš„æ•°æ®åº“
            await loadData(); // å…ˆåŠ è½½æ‰€æœ‰æ•°æ®
            
            // --- ã€å…³é”®ä¿®å¤å¼€å§‹ã€‘ ---
            // ä¼˜å…ˆä» URL è·å– ID (æœ€ç¨³)ï¼Œå¦‚æœæ²¡æœ‰å†æŸ¥æ•°æ®åº“
            const urlParams = new URLSearchParams(window.location.search);
            let editId = urlParams.get('id');
            if (!editId) {
                 editId = await dbGet('edit_char_id');
            }
            
            // 2. å¦‚æœæ–°åœ°æ–¹æ²¡æœ‰ï¼Œè¯´æ˜æ˜¯ä»æ—§ç‰ˆé¦–é¡µè·³è¿‡æ¥çš„ï¼Œå»æ—§åœ°æ–¹æ‹¿
            if (!editId) {
                editId = localStorage.getItem('edit_char_id');
            }
            // --- ã€å…³é”®ä¿®å¤ç»“æŸã€‘ ---

            if(editId) {
                // æ‰¾åˆ°äº† IDï¼Œå»æ•°ç»„é‡Œæ‰¾å¯¹åº”çš„è§’è‰²
                charIndex = characters.findIndex(c => c.id === editId);
                if(charIndex !== -1) { 
                    currentChar = characters[charIndex]; 
                    await initUI(); // åˆå§‹åŒ–ç•Œé¢
                } 
                else { 
                    openConfirmModal('exit', 'è§’è‰²ä¸å­˜åœ¨ï¼Œé€€å‡ºï¼Ÿ'); 
                }
            } else { 
                openConfirmModal('exit', 'æœªæŒ‡å®šè§’è‰²ï¼Œé€€å‡ºï¼Ÿ'); 
            }

            // ç»‘å®šäº‹ä»¶ç›‘å¬
            document.getElementById('bubbleCss').addEventListener('input', (e) => applyPreviewCss(e.target.value));
            document.getElementById('timeSenseSwitch').addEventListener('change', (e) => {
               document.getElementById('timeZoneSelectRow').style.display = e.target.checked ? 'flex' : 'none'; 
            });
            document.getElementById('weatherSenseSwitch').addEventListener('change', (e) => {
               document.getElementById('weatherConfigArea').style.display = e.target.checked ? 'flex' : 'none'; 
            });
        };

        async function loadData() {
            // 1. å°è¯•ä» IndexedDB è¯»å–
            let raw = await dbGet(DB_KEY);
            let rawPresets = await dbGet(PRESET_KEY);

            // 2. å…¼å®¹æ—§æ•°æ® (LocalStorage è¿ç§»)
            if (!raw) {
                const oldRaw = localStorage.getItem(DB_KEY);
                if (oldRaw) {
                    raw = oldRaw; 
                    await dbSet(DB_KEY, raw); // å­˜å…¥æ–°åº“
                }
            }
            if (!rawPresets) {
                const oldPresets = localStorage.getItem(PRESET_KEY);
                if (oldPresets) {
                    rawPresets = oldPresets;
                    await dbSet(PRESET_KEY, rawPresets);
                }
            }

            // 3. è§£ææ•°æ®
            if(raw) {
                try { characters = JSON.parse(raw); } catch(e) {}
            }
            if(rawPresets) {
                try { globalPresets = JSON.parse(rawPresets); } catch(e) {}
            }
        }
        async function saveData() { 
            if(charIndex !== -1 && currentChar) { 
                characters[charIndex] = currentChar; 
                // å­˜ä¸ºå­—ç¬¦ä¸²
                await dbSet(DB_KEY, JSON.stringify(characters)); 
            }
            // å­˜ä¸ºå­—ç¬¦ä¸²
            await dbSet(PRESET_KEY, JSON.stringify(globalPresets)); 
            
            detailChannel.postMessage({ type: 'refresh_list' });
        }

        async function initUI() { // <--- åŠ äº† async
            document.getElementById('charDisplayName').value = currentChar.name || '';
            document.getElementById('charTrueName').value = currentChar.trueName || currentChar.name || '';
            document.getElementById('userNickName').value = currentChar.userNickName || '';
            if(currentChar.avatar) document.getElementById('charAvatarImg').src = currentChar.avatar, document.getElementById('charAvatarImg').style.display = 'block', document.getElementById('charAvatarPlaceholder').style.display = 'none';
            if(currentChar.userAvatar) document.getElementById('userAvatarImg').src = currentChar.userAvatar, document.getElementById('userAvatarImg').style.display = 'block', document.getElementById('userAvatarPlaceholder').style.display = 'none';
            document.getElementById('currentGroupDisplay').innerText = (currentChar.group || 'æœªåˆ†ç»„') + ' >';
            document.getElementById('charPersona').value = currentChar.persona || '';
            document.getElementById('userPersona').value = currentChar.userPersona || '';
            
           // ä¸–ç•Œä¹¦ (World Book) - ä¿®å¤æ˜¾ç¤ºå¤šæœ¬
            let wbText = 'æ—  >';
            if (!currentChar.worldBookIds) currentChar.worldBookIds = [];
            if (currentChar.worldBookId && !currentChar.worldBookIds.includes(currentChar.worldBookId)) {
                currentChar.worldBookIds.push(currentChar.worldBookId);
            }
            if(currentChar.worldBookIds.length > 0) {
                // â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“ ä¿®æ”¹äº†è¿™ä¸€è¡Œ â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“
                const rawBooks = await dbGet(WB_KEY) || '[]'; 
                const books = JSON.parse(rawBooks);
                // â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
                const selectedNames = books.filter(b => currentChar.worldBookIds.includes(b.id)).map(b => b.name);
                if (selectedNames.length > 0) {
                    wbText = selectedNames.length === 1 ? selectedNames[0] + ' >' : `å·²é€‰ ${selectedNames.length} æœ¬ >`;
                }
            }
            document.getElementById('currentWorldBook').innerText = wbText;

            document.getElementById('shortMemCount').value = currentChar.shortMemCount || 20;
            document.getElementById('autoSummarySwitch').checked = currentChar.autoSummary || false;
            document.getElementById('autoSummaryThreshold').value = currentChar.autoSummaryThreshold || 100;
            document.getElementById('summaryPrompt').value = currentChar.summaryPrompt || '';
            
            const history = currentChar.history || [];
            document.getElementById('statMsgCount').innerText = history.length;
            let tokens = 0; 
// è¯»å–è®¾ç½®çš„æ¡æ•°ï¼Œé»˜è®¤20
const limit = currentChar.shortMemCount || 20;
// åªæˆªå–æœ€å limit æ¡è¿›è¡Œè®¡ç®—
const activeSlice = history.slice(-limit);
activeSlice.forEach(m => tokens += m.content.length * 1.5);
document.getElementById('statTokenCount').innerText = Math.floor(tokens);
            document.getElementById('longMemCount').innerText = (currentChar.longTermMemories || []).length + 'æ¡ >';

            // æ—¶é—´
            document.getElementById('timeSenseSwitch').checked = currentChar.timeSense || false;
            document.getElementById('timeZoneSelectRow').style.display = currentChar.timeSense ? 'flex' : 'none';
            document.getElementById('currentTimeZoneDisplay').innerText = (currentChar.timeZoneName || 'èƒŒæ™¯ç³»ç»Ÿæ—¶é—´') + ' >';

            // å¤©æ°”
            document.getElementById('weatherSenseSwitch').checked = currentChar.weatherSense || false;
            document.getElementById('weatherConfigArea').style.display = currentChar.weatherSense ? 'flex' : 'none';
            document.getElementById('charWeatherVirtualLoc').value = currentChar.charWeatherVirtualLoc || '';
            document.getElementById('charWeatherRealLoc').value = currentChar.charWeatherRealLoc || '';
            document.getElementById('userWeatherVirtualLoc').value = currentChar.userWeatherVirtualLoc || '';
            document.getElementById('userWeatherRealLoc').value = currentChar.userWeatherRealLoc || '';
            document.getElementById('offlineModeSwitch').checked = currentChar.isOfflineMode || false;
// å¦‚æœå¼€å¯äº†ï¼Œæ˜¾ç¤ºäººç§°é€‰æ‹©è¡Œ
document.getElementById('offlinePerspectiveRow').style.display = currentChar.isOfflineMode ? 'flex' : 'none';
document.getElementById('bilingualModeSwitch').checked = currentChar.bilingualMode || false;
// æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„äººç§°
const pMap = {'2nd': 'ç¬¬äºŒäººç§°', '3rd': 'ç¬¬ä¸‰äººç§°'};
document.getElementById('currentPerspectiveDisplay').innerText = (pMap[currentChar.offlinePerspective] || 'ç¬¬äºŒäººç§°') + ' >';

            if(currentChar.chatBg) document.getElementById('chatBgPreview').style.backgroundImage = `url(${currentChar.chatBg})`;
            document.getElementById('bubbleCss').value = currentChar.bubbleCss || '';
            document.getElementById('uiCss').value = currentChar.uiCss || ''; 
            applyPreviewCss(currentChar.bubbleCss || '');
        }

        function saveAllSettings() {
            if(!currentChar) return;
            currentChar.name = document.getElementById('charDisplayName').value;
            currentChar.trueName = document.getElementById('charTrueName').value;
            currentChar.userNickName = document.getElementById('userNickName').value;
            currentChar.persona = document.getElementById('charPersona').value;
            currentChar.userPersona = document.getElementById('userPersona').value;
            currentChar.shortMemCount = parseInt(document.getElementById('shortMemCount').value) || 20;
            currentChar.autoSummary = document.getElementById('autoSummarySwitch').checked;
            currentChar.autoSummaryThreshold = parseInt(document.getElementById('autoSummaryThreshold').value) || 100;
            currentChar.summaryPrompt = document.getElementById('summaryPrompt').value;
            
            currentChar.timeSense = document.getElementById('timeSenseSwitch').checked;
            // timeZoneValue and timeZoneName are set in modal
            
            currentChar.weatherSense = document.getElementById('weatherSenseSwitch').checked;
            currentChar.charWeatherVirtualLoc = document.getElementById('charWeatherVirtualLoc').value;
            currentChar.charWeatherRealLoc = document.getElementById('charWeatherRealLoc').value;
            currentChar.userWeatherVirtualLoc = document.getElementById('userWeatherVirtualLoc').value;
            currentChar.userWeatherRealLoc = document.getElementById('userWeatherRealLoc').value;
            currentChar.isOfflineMode = document.getElementById('offlineModeSwitch').checked;
            currentChar.bilingualMode = document.getElementById('bilingualModeSwitch').checked;
// offlinePerspective å·²ç»åœ¨é€‰æ‹©æ—¶ç›´æ¥ä¿å­˜åˆ° currentChar (æˆ–è€…æš‚å­˜å˜é‡) äº†ï¼Œè¿™é‡Œä¸ºäº†ä¿é™©å¯ä»¥ä¸å†™ï¼Œæˆ–è€…ç¡®ä¿åœ¨ selectPerspective é‡Œèµ‹å€¼

            currentChar.bubbleCss = document.getElementById('bubbleCss').value;
            currentChar.uiCss = document.getElementById('uiCss').value;
            saveData(); showToast("è®¾å®šå·²ä¿å­˜å¹¶åº”ç”¨");
            setTimeout(() => { if(window.parent && window.parent.closeCharDetail) window.parent.closeCharDetail(); else history.back(); }, 800);
        }

        let uploadType = '';
        function triggerUpload(type) { uploadType = type; const input = document.getElementById('hiddenFileInput'); input.accept = "image/*"; input.onchange = handleFile; input.click(); }
        function handleFile(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => {
                    // ã€ä¿®æ”¹ç‚¹ã€‘èƒŒæ™¯å›¾æœ€å¤§ 1080pxï¼Œå¤´åƒæœ€å¤§ 300px (è¶³å¤Ÿæ¸…æ™°äº†)
                    const canvas = document.createElement('canvas'); 
let w = img.width, h = img.height, max = uploadType === 'chatBg' ? 1620 : 300;
if(w > h && w > max) { h *= max/w; w = max; } else if(h > w && h > max) { w *= max/h; h = max; }
canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h);
// ã€ä¿®æ”¹ç‚¹ã€‘è´¨é‡æ”¹ä¸º 0.6ï¼Œå¤§å¹…èŠ‚çœç©ºé—´
const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    if(uploadType === 'charAvatar') { document.getElementById('charAvatarImg').src = dataUrl; document.getElementById('charAvatarImg').style.display='block'; document.getElementById('charAvatarPlaceholder').style.display='none'; currentChar.avatar = dataUrl; }
                    else if(uploadType === 'userAvatar') { document.getElementById('userAvatarImg').src = dataUrl; document.getElementById('userAvatarImg').style.display='block'; document.getElementById('userAvatarPlaceholder').style.display='none'; currentChar.userAvatar = dataUrl; }
                    else if(uploadType === 'chatBg') { document.getElementById('chatBgPreview').style.backgroundImage = `url(${dataUrl})`; currentChar.chatBg = dataUrl; }
                }; img.src = evt.target.result;
            }; reader.readAsDataURL(file); e.target.value = '';
        }

        // ã€æ–°å¢å‡½æ•°ã€‘å¤„ç† URL å¯¼å…¥
function triggerUrlInput(type) {
    // å¤ç”¨å·²æœ‰çš„è¾“å…¥å¼¹çª—ï¼Œå›è°ƒå‡½æ•°å¤„ç†é€»è¾‘
    openInputModal("è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ (URL)", (url) => {
        if (!url) return;
        // ç®€å•çš„å»ç©ºéªŒè¯
        url = url.trim();
        if (type === 'chatBg') {
            document.getElementById('chatBgPreview').style.backgroundImage = `url(${url})`;
            currentChar.chatBg = url;
            showToast("èƒŒæ™¯å·²é€šè¿‡ URL æ›´æ”¹");
        }
    });
}

        // æ—¶åŒºé€‰æ‹© Modal
        function openTimeZoneModal() {
            const container = document.getElementById('genericListContainer'); container.innerHTML = '';
            document.getElementById('listModalTitle').innerText = 'é€‰æ‹©æ—¶é—´æ„ŸçŸ¥æ—¶åŒº';
            document.getElementById('btnAddToList').style.display = 'none';

            // å®šä¹‰æ—¶åŒºåˆ—è¡¨
            const zones = [
                {name: "èƒŒæ™¯ç³»ç»Ÿæ—¶é—´ (é»˜è®¤)", val: ""},
                {name: "ä¸­å›½æ—¶é—´ (Beijing)", val: "Asia/Shanghai"},
                {name: "æ—¥æœ¬æ—¶é—´ (Tokyo)", val: "Asia/Tokyo"},
                {name: "ç¾å›½ä¸œéƒ¨ (New York)", val: "America/New_York"},
                {name: "ç¾å›½è¥¿éƒ¨ (Los Angeles)", val: "America/Los_Angeles"},
                {name: "è‹±å›½æ—¶é—´ (London)", val: "Europe/London"},
                {name: "å¥¥å…‹å…°å†¬ä»¤æ—¶/æ ‡å‡†æ—¶ (Auckland)", val: "Pacific/Auckland"}, // JS Intl ä¼šè‡ªåŠ¨å¤„ç†å†¬å¤ä»¤æ—¶ï¼Œåªè¦æŒ‡å®šåŒºåŸŸ
                {name: "æ¾³å¤§åˆ©äºšä¸œéƒ¨ (Sydney)", val: "Australia/Sydney"},
                {name: "æ³•å›½æ—¶é—´ (Paris)", val: "Europe/Paris"},
                {name: "ä¿„ç½—æ–¯ (Moscow)", val: "Europe/Moscow"}
            ];

            zones.forEach(z => {
                let div = document.createElement('div'); div.className = 'list-item';
                div.innerHTML = `<span>${z.name}</span>` + (currentChar.timeZoneValue === z.val ? '<span style="color:#ffb7c5">â—</span>' : '');
                div.onclick = () => { 
                    currentChar.timeZoneValue = z.val; 
                    currentChar.timeZoneName = z.name;
                    document.getElementById('currentTimeZoneDisplay').innerText = z.name + ' >'; 
                    closeModal('modal-list-select'); 
                };
                container.appendChild(div);
            });
            openModal('modal-list-select');
        }

        // è¿™é‡Œçš„ä»£ç æ˜¯æ–°åŠ çš„ï¼Œç”¨äºæ‰“å¼€ä¸–ç•Œä¹¦é€‰æ‹©å¼¹çª—
        async function openWorldBookModal() { // <--- åŠ äº† async
            const rawBooks = await dbGet(WB_KEY) || '[]';
            const books = JSON.parse(rawBooks);
            const container = document.getElementById('genericListContainer'); 
            container.innerHTML = '';
            document.getElementById('listModalTitle').innerText = 'é€‰æ‹©ä¸–ç•Œä¹¦ (å¯å¤šé€‰)';
            
            // åˆå§‹åŒ–æ•°ç»„
            if (!currentChar.worldBookIds) currentChar.worldBookIds = [];
            if (currentChar.worldBookId && !currentChar.worldBookIds.includes(currentChar.worldBookId)) {
                currentChar.worldBookIds.push(currentChar.worldBookId);
            }

            // æ˜¾ç¤ºå¹¶è®¾ç½®"ç¡®å®š"æŒ‰é’®
            const btnConfirm = document.getElementById('btnAddToList');
            btnConfirm.style.display = 'block';
            btnConfirm.innerText = 'ç¡®å®šå®Œæˆ'; 
            
            btnConfirm.onclick = () => {
                let wbText = 'æ—  >';
                const selectedNames = books.filter(b => currentChar.worldBookIds.includes(b.id)).map(b => b.name);
                if (selectedNames.length > 0) {
                    wbText = selectedNames.length === 1 ? selectedNames[0] + ' >' : `å·²é€‰ ${selectedNames.length} æœ¬ >`;
                }
                document.getElementById('currentWorldBook').innerText = wbText;
                closeModal('modal-list-select');
            };
            
            // æ¸²æŸ“åˆ—è¡¨
            books.forEach(b => {
                let div = document.createElement('div'); 
                div.className = 'list-item';
                const isSelected = currentChar.worldBookIds.includes(b.id);
                div.innerHTML = `<span style="${isSelected ? 'color:#ffb7c5;font-weight:bold' : ''}">${b.name}</span>` + 
                                (isSelected ? '<span style="color:#ffb7c5; font-weight:bold;">âœ“</span>' : '');
                div.onclick = () => {
                    const idx = currentChar.worldBookIds.indexOf(b.id);
                    if (idx > -1) { currentChar.worldBookIds.splice(idx, 1); } 
                    else { currentChar.worldBookIds.push(b.id); }
                    openWorldBookModal(); // åˆ·æ–°åˆ—è¡¨çŠ¶æ€
                };
                container.appendChild(div);
            });
            openModal('modal-list-select');
        }

        // æœç´¢åŠŸèƒ½
        function openSearchModal() { openModal('modal-search'); document.getElementById('searchInput').value = ''; document.getElementById('searchResultList').innerHTML = ''; }
        async function doSearch() { // <--- åŠ äº† async
            const keyword = document.getElementById('searchInput').value.trim();
            const list = document.getElementById('searchResultList'); list.innerHTML = '';
            if(!keyword || !currentChar.history) return;
            currentChar.history.forEach((msg, idx) => {
                if(msg.content.includes(keyword)) {
                    let div = document.createElement('div'); div.className = 'list-item';
                    div.style.flexDirection = 'column'; div.style.alignItems = 'flex-start'; div.style.gap = '2px';
                    div.innerHTML = `<span style="font-size:12px;color:#aaa">${new Date(msg.timestamp).toLocaleString()} - ${msg.role==='user'?'æˆ‘':currentChar.name}</span><span style="font-size:13px;color:#333">${msg.content}</span>`;
                    
                    div.onclick = async () => {
                        await dbSet('chat_jump_index', idx);
                        if(window.parent && window.parent.closeCharDetail) window.parent.closeCharDetail();
                        else history.back();
                    };
                    
                    list.appendChild(div);
                }
            });
            if(list.children.length === 0) list.innerHTML = '<div style="text-align:center;color:#ccc;font-size:12px">æœªæ‰¾åˆ°è®°å½•</div>';
        }

        // ç¡®è®¤å¼¹çª—
        function openConfirmModal(type, text) {
            const msg = document.getElementById('confirmMsg');
            const btn = document.getElementById('btnConfirmAction');
            document.getElementById('modal-confirm').style.display = 'flex'; setTimeout(()=>document.getElementById('modal-confirm').classList.add('show'),10);
            
            if(type === 'exit') {
                msg.innerText = text || "ç¡®å®šä¸ä¿å­˜ç›´æ¥é€€å‡ºå—ï¼Ÿ";
                btn.onclick = () => { if(window.parent && window.parent.closeCharDetail) window.parent.closeCharDetail(); else history.back(); };
            } else if (type === 'clear') {
                msg.innerText = "ç¡®å®šæ¸…ç©ºèŠå¤©è®°å½•ï¼Ÿé•¿æœŸè®°å¿†å°†ä¿ç•™ã€‚";
                btn.onclick = () => { currentChar.history = []; saveData(); document.getElementById('statMsgCount').innerText='0'; document.getElementById('statTokenCount').innerText='0'; closeModal('modal-confirm'); showToast("å·²æ¸…ç©º"); };
            }
        }

        // è¾…åŠ©å‡½æ•°
        function openLongMemModal() {
            const list = document.getElementById('longMemList'); list.innerHTML = '';
            (currentChar.longTermMemories || []).forEach((m, idx) => {
                let div = document.createElement('div'); div.className = 'list-item';
                div.innerHTML = `<div contenteditable="true" id="mem-${idx}" style="flex:1;outline:none">${m}</div><div style="color:#ff8888;font-weight:bold;margin-left:10px" onclick="currentChar.longTermMemories.splice(${idx},1);openLongMemModal()">Ã—</div>`;
                list.appendChild(div);
            }); openModal('modal-long-mem');
        }
        function addLongMem() { 
            // è°ƒç”¨è¾“å…¥å¼¹çª—ï¼Œè¾“å…¥å®Œæˆåæ‰§è¡Œå›è°ƒ
            openInputModal("æ·»åŠ é•¿æœŸè®°å¿†", (text) => {
                if(text && text.trim()) {
                    if(!currentChar.longTermMemories) currentChar.longTermMemories = [];
                    currentChar.longTermMemories.push(text.trim());
                    // åˆ·æ–°é•¿æœŸè®°å¿†åˆ—è¡¨æ˜¾ç¤º
                    openLongMemModal();
                    // å¦‚æœéœ€è¦ç«‹å³ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼Œæˆ–è€…ä¾èµ–åç»­çš„"ä¿å­˜ä¿®æ”¹"æŒ‰é’®
                    // saveData(); 
                }
            });
        }
        function saveLongMemChanges() { 
            let arr = []; document.querySelectorAll('[id^="mem-"]').forEach(el => arr.push(el.innerText));
            currentChar.longTermMemories = arr; document.getElementById('longMemCount').innerText = arr.length + 'æ¡ >'; closeModal('modal-long-mem'); 
        }
        
        function openGroupModal() {
            characters.forEach(c => { if(c.group) allGroups.add(c.group); });
            const container = document.getElementById('genericListContainer'); container.innerHTML = '';
            document.getElementById('listModalTitle').innerText = 'é€‰æ‹©å¥½å‹åˆ†ç»„';
            document.getElementById('btnAddToList').style.display = 'block'; document.getElementById('btnAddToList').innerText = '+ æ·»åŠ åˆ†ç»„';
            document.getElementById('btnAddToList').onclick = () => { openInputModal("æ–°åˆ†ç»„åç§°", (val) => { if(val) { allGroups.add(val); openGroupModal(); } }); };
            allGroups.forEach(g => {
                let div = document.createElement('div'); div.className = 'list-item';
                div.innerHTML = `<span>${g} ${currentChar.group === g ? '(å½“å‰)' : ''}</span>` + ((g!=='æœªåˆ†ç»„'&&g!=='æˆ‘çš„å¥½å‹') ? `<div onclick="event.stopPropagation();allGroups.delete('${g}');openGroupModal()">Ã—</div>` : '');
                div.onclick = () => { currentChar.group = g; document.getElementById('currentGroupDisplay').innerText = g + ' >'; closeModal('modal-list-select'); };
                container.appendChild(div);
            }); openModal('modal-list-select');
        }

        function openPresetListModal(type) {
            const container = document.getElementById('genericListContainer'); 
            container.innerHTML = '';
            document.getElementById('listModalTitle').innerText = type === 'user' ? 'ç”¨æˆ·äººè®¾é¢„è®¾' : 'æ°”æ³¡æ ·å¼é¢„è®¾';
            document.getElementById('btnAddToList').style.display = 'none';
            
            const targetArray = type === 'user' ? globalPresets.userPersonas : globalPresets.bubbleStyles;

            targetArray.forEach((p, idx) => {
                let div = document.createElement('div'); 
                div.className = 'list-item';
                
                // åˆ›å»ºåå­—éƒ¨åˆ†
                let span = document.createElement('span');
                span.innerText = p.name;
                
                // åˆ›å»ºåˆ é™¤æŒ‰é’®
                let delBtn = document.createElement('div');
                delBtn.innerText = 'Ã—';
                delBtn.style.padding = '0 10px';
                delBtn.style.cursor = 'pointer';
                delBtn.style.fontWeight = 'bold';
                
                // ç»‘å®šåˆ é™¤äº‹ä»¶
                delBtn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ•´è¡Œç‚¹å‡»
                    // æ‰§è¡Œåˆ é™¤
                    targetArray.splice(idx, 1);
                    saveData();
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    openPresetListModal(type); 
                };

                // ç»‘å®šæ•´è¡Œç‚¹å‡»åº”ç”¨äº‹ä»¶
                div.onclick = () => { 
    if(type === 'user') {
        document.getElementById('userPersona').value = p.content; 
    } else { 
        // å°è¯•è§£æ JSON (æ–°ç‰ˆé¢„è®¾)ï¼Œå¦‚æœè§£æå¤±è´¥åˆ™å…¼å®¹æ—§ç‰ˆ(çº¯å­—ç¬¦ä¸²)
        try {
            const styleObj = JSON.parse(p.content);
            document.getElementById('bubbleCss').value = styleObj.bubble || '';
            document.getElementById('uiCss').value = styleObj.ui || '';
            applyPreviewCss(styleObj.bubble || '');
        } catch(e) {
            // æ—§ç‰ˆé¢„è®¾åªæœ‰ bubbleCss
            document.getElementById('bubbleCss').value = p.content;
            applyPreviewCss(p.content); 
        }
    } 
    closeModal('modal-list-select'); 
};

                div.appendChild(span);
                div.appendChild(delBtn);
                container.appendChild(div);
            }); 
            openModal('modal-list-select');
        }
        function openSavePresetModal(type) {
    openInputModal("ä¸ºé¢„è®¾å‘½å", (name) => {
        if(!name) return;
        
        let content;
        if (type === 'user') {
            content = document.getElementById('userPersona').value;
        } else {
            // --- ä¿®æ”¹ç‚¹ï¼šCSSé¢„è®¾åŒæ—¶ä¿å­˜æ°”æ³¡æ ·å¼å’ŒUIæ ·å¼ ---
            const bCss = document.getElementById('bubbleCss').value;
            const uCss = document.getElementById('uiCss').value;
            // å°†ä¸¤è€…æ‰“åŒ…æˆ JSON å­—ç¬¦ä¸²ä¿å­˜
            content = JSON.stringify({ bubble: bCss, ui: uCss });
        }

        if(!content) return showToast("å†…å®¹ä¸ºç©º", true);
        (type === 'user' ? globalPresets.userPersonas : globalPresets.bubbleStyles).push({ name: name, content: content });
        saveData(); showToast("é¢„è®¾å·²ä¿å­˜");
    });
}

        // æ‰‹åŠ¨æ€»ç»“ (ä¿®å¤ç‰ˆï¼šæ”¯æŒæ–°ç‰ˆAPIé…ç½® + è‡ªå®šä¹‰æŒ‡ä»¤)
        async function triggerManualSummary() {
            // 1. ä¼˜å…ˆè¯»å– settings.html ä¿å­˜çš„æ–°ç‰ˆé…ç½®
            let config = await dbGet('qq_ai_config');

            // 2. å…¼å®¹æ—§é€»è¾‘
            if (!config) {
                const rawPresets = await dbGet('aiPhone_presets'); 
                const currentId = await dbGet('aiPhone_currentId');
                if (rawPresets && currentId) { 
                    try { config = JSON.parse(rawPresets).find(p => p.id == currentId); } catch(e) {} 
                }
            }
            
            if(!config || !config.url || !config.key) {
                return showToast("è¯·å…ˆåœ¨é¦–é¡µè®¾ç½®APIè¿æ¥", true);
            }

            if(!currentChar.history || currentChar.history.length === 0) {
                return showToast("æ²¡æœ‰èŠå¤©è®°å½•å¯æ€»ç»“", true);
            }

            showToast("æ­£åœ¨è¯·æ±‚æ¨¡å‹æ€»ç»“...", false);

            let cleanUrl = config.url.trim().replace(/\/+$/, '');
            let fetchUrl = '';
            if (cleanUrl.endsWith('/v1')) { fetchUrl = cleanUrl + '/chat/completions'; }
            else if (cleanUrl.endsWith('/chat/completions')) { fetchUrl = cleanUrl; }
            else { fetchUrl = cleanUrl + '/v1/chat/completions'; }
            
            // å–æœ€è¿‘ 200 æ¡
            const recent = currentChar.history.slice(-200).map(m => `${m.role}:${m.content}`).join('\n');
            
            // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–­æ˜¯å¦æœ‰è‡ªå®šä¹‰æŒ‡ä»¤ ---
            const defaultPrompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°å¿†åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹å¯¹è¯ï¼Œæ€»ç»“å‡ºå…³é”®ä¿¡æ¯ã€‚æ€»ç»“å¿…é¡»åŒ…å«ï¼š1.æ—¶é—´(å¤§æ¦‚å‘ç”Ÿæ—¶å€™) 2.äººç‰©(è°å’Œè°) 3.äº‹ä»¶(å‘ç”Ÿäº†ä»€ä¹ˆ) 4.çº¦å®šæˆ–é‡è¦ç»†èŠ‚ã€‚è¯·ç”¨ç®€æ´çš„è¯­è¨€æ€»ç»“ï¼Œå­—æ•°æ§åˆ¶åœ¨200å­—ä»¥å†…ï¼Œä¸è¦é—æ¼é‡è¦æƒ…èŠ‚ã€‚";
            const systemPrompt = currentChar.summaryPrompt && currentChar.summaryPrompt.trim() !== "" 
                                 ? currentChar.summaryPrompt 
                                 : defaultPrompt;

            try {
                const res = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.key}` },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: [
                            {role: "system", content: systemPrompt}, // ä½¿ç”¨åŠ¨æ€åˆ¤æ–­åçš„ Prompt
                            {role: "user", content: recent}
                        ],
                        temperature: 0.5
                    })
                });

                if(res.ok) {
                    const data = await res.json();
                    if(data.choices && data.choices.length > 0) {
                        const summary = `[æ‰‹åŠ¨æ€»ç»“ ${new Date().toLocaleString()}]: ` + data.choices[0].message.content;
                        if(!currentChar.longTermMemories) currentChar.longTermMemories = [];
                        currentChar.longTermMemories.push(summary);
                        saveData();
                        document.getElementById('longMemCount').innerText = currentChar.longTermMemories.length + 'æ¡ >';
                        showToast("æ€»ç»“æˆåŠŸå¹¶å·²å­˜å…¥é•¿æœŸè®°å¿†ï¼");
                    } else {
                        showToast("æ€»ç»“å¤±è´¥ï¼šæ— å†…å®¹è¿”å›", true);
                    }
                } else {
                    showToast("APIè¯·æ±‚å¤±è´¥", true);
                }
            } catch(e) {
                console.error(e);
                showToast("ç½‘ç»œé”™è¯¯", true);
            }
        }

        function exportHistory() { const b = new Blob([JSON.stringify(currentChar)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `${currentChar.name}.json`; a.click(); }
        function triggerImport() { document.getElementById('hiddenFileInput').accept=".json"; document.getElementById('hiddenFileInput').onchange=(e)=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{ try{ currentChar={...currentChar, ...JSON.parse(ev.target.result), id:currentChar.id}; initUI(); saveData(); showToast("å¯¼å…¥æˆåŠŸ"); }catch(e){showToast("é”™è¯¯")} }; r.readAsText(f); }; document.getElementById('hiddenFileInput').click(); }

        function applyPreviewCss(css) { 
            const styleTag = document.getElementById('dynamicPreviewStyles');
            if(!css || !css.trim()) {
                styleTag.innerHTML = ""; // å¦‚æœæ¸…ç©ºäº†ï¼Œå°±ç§»é™¤æ ·å¼
                return;
            }

            // å¦‚æœåŒ…å«å¤§æ‹¬å·ï¼Œè¯´æ˜æ˜¯å®Œæ•´çš„é«˜çº§CSSï¼Œç›´æ¥æ³¨å…¥
            if(css.includes('{')) {
                // ä¸ºäº†é˜²æ­¢é¢„è§ˆæ ·å¼å½±å“å…¨å±€ï¼Œæˆ‘ä»¬åœ¨æ‰€æœ‰é€‰æ‹©å™¨å‰åŠ  #chatBgPreview
                // ä½†ä¸ºäº†ç®€å•ï¼Œå› ä¸ºé¢„è§ˆé¡µæ²¡æœ‰å…¶ä»– bubbleï¼Œç›´æ¥æ³¨å…¥é€šå¸¸ä¹Ÿæ²¡é—®é¢˜
                // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„å¤„ç†ï¼Œè®©ç”¨æˆ·è¾“å…¥çš„ .msg-row èƒ½åŒ¹é…åˆ°é¢„è§ˆæ¡†é‡Œçš„ç»“æ„
                styleTag.innerHTML = css; 
            } else {
                // å…¼å®¹æ—§æ¨¡å¼ï¼šå¦‚æœåªå†™äº† color:redï¼Œå°±è‡ªåŠ¨å¥—åœ¨ .bubble ä¸Š
                // æ³¨æ„ï¼šä¸ºäº†è®©é¢„è§ˆç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶è¦†ç›– ai å’Œ me
                styleTag.innerHTML = `
                    #chatBgPreview .bubble { ${css} }
                    #chatBgPreview .msg-row.ai .bubble { ${css} }
                    #chatBgPreview .msg-row.me .bubble { ${css} }
                `;
            }
        }
        function openInputModal(t, cb) { 
            // æ ¸å¿ƒä¿®æ”¹ï¼šæ‰‹åŠ¨å°†è¾“å…¥å¼¹çª—çš„å±‚çº§æé«˜åˆ° 1500ï¼ˆåŸé»˜è®¤æ˜¯1000ï¼‰ï¼Œç¡®ä¿å®ƒåœ¨é•¿æœŸè®°å¿†å¼¹çª—ä¹‹ä¸Š
            document.getElementById('modal-input-name').style.zIndex = '1500';

            document.getElementById('inputModalTitle').innerText = t; 
            document.getElementById('genericInput').value = ''; 
            const old = document.getElementById('btnConfirmInput'); 
            const n = old.cloneNode(true); 
            old.parentNode.replaceChild(n, old); 
            n.onclick = () => { 
                cb(document.getElementById('genericInput').value); 
                closeModal('modal-input-name'); 
            }; 
            openModal('modal-input-name'); 
        }
        function openModal(id) { document.getElementById(id).style.display='flex'; setTimeout(()=>document.getElementById(id).classList.add('show'),10); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); setTimeout(()=>document.getElementById(id).style.display='none',300); }
        function showToast(msg, err) { const t=document.getElementById('toast'); t.innerText=msg; t.style.color=err?'red':'#333'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        // ç›‘å¬å¼€å…³å˜åŒ–
document.getElementById('offlineModeSwitch').addEventListener('change', (e) => {
    if (e.target.checked) {
        // å¼€å¯æ—¶ï¼Œæ˜¾ç¤ºäººç§°è¡Œï¼Œå¹¶å¼¹å‡ºé€‰æ‹©æ¡†
        document.getElementById('offlinePerspectiveRow').style.display = 'flex';
        openPerspectiveModal();
    } else {
        // å…³é—­æ—¶ï¼Œéšè—äººç§°è¡Œ
        document.getElementById('offlinePerspectiveRow').style.display = 'none';
    }
});

function openPerspectiveModal() {
    // é»˜è®¤é€‰ä¸­ç¬¬äºŒäººç§°
    if (!currentChar.offlinePerspective) currentChar.offlinePerspective = '2nd';
    
    // æ›´æ–°å¯¹å‹¾æ˜¾ç¤º
    document.getElementById('mark-2nd').style.display = currentChar.offlinePerspective === '2nd' ? 'block' : 'none';
    document.getElementById('mark-3rd').style.display = currentChar.offlinePerspective === '3rd' ? 'block' : 'none';
    
    openModal('modal-perspective');
}

function selectPerspective(type) {
    currentChar.offlinePerspective = type;
    const pMap = {'2nd': 'ç¬¬äºŒäººç§°', '3rd': 'ç¬¬ä¸‰äººç§°'};
    document.getElementById('currentPerspectiveDisplay').innerText = pMap[type] + ' >';
    closeModal('modal-perspective');
}
    </script>
</body>
</html>
